<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>รายรับจ่าย (Responsive)</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <!-- Google Fonts: Sarabun & Prompt -->
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&family=Sarabun:wght@300;400;500;600&display=swap" rel="stylesheet">
  
  <style>
    :root {
      /* Palette: Clean & Soft */
      --primary: #5e72e4;
      --primary-soft: #eaecfb;
      --success: #2dce89;
      --success-soft: #e0fbf4;
      --danger: #f5365c;
      --danger-soft: #fee6ea;
      --warning: #fb6340;
      --info: #11cdef;
      --info-soft: #e0f7fa;
      --text-main: #32325d;
      --text-muted: #8898aa;
      --bg-glass: rgba(255, 255, 255, 0.85);
      --bg-glass-strong: rgba(255, 255, 255, 0.95);
      --shadow-soft: 0 7px 14px rgba(50, 50, 93, 0.1), 0 3px 6px rgba(0, 0, 0, 0.08);
      --shadow-hover: 0 15px 35px rgba(50, 50, 93, 0.1), 0 5px 15px rgba(0, 0, 0, 0.07);
      --radius: 16px;
      --radius-sm: 8px;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
      font-family: 'Prompt', 'Sarabun', sans-serif;
      margin: 0; padding: 20px 15px;
      min-height: 100vh;
      color: var(--text-main);
      background: #f8f9fe;
      padding-bottom: 100px;
    }

    .main-container {
        max-width: 600px;
        margin: 0 auto;
        width: 100%;
    }

    /* ===== Background ===== */
    .bg-layer { position: fixed; inset: 0; z-index: -2; overflow: hidden; }
    .bg {
      position: absolute; inset: 0;
      background-size: cover; background-position: center;
      filter: blur(8px);
      transform: scale(1.1);
      transition: opacity 2.5s ease; opacity: 0;
    }
    .bg.active { opacity: 1; }
    .bg-overlay { 
        position: fixed; inset: 0; z-index: -1; 
        transition: background 1s;
        background: rgba(248, 249, 254, 0.7);
    }
    .night .bg-overlay { background: rgba(15, 23, 42, 0.85); }
    .night { 
        --text-main: #e2e8f0; 
        --text-muted: #94a3b8;
        --bg-glass: rgba(30, 41, 59, 0.85);
        --bg-glass-strong: rgba(30, 41, 59, 0.95);
        --primary-soft: rgba(94, 114, 228, 0.15);
        --success-soft: rgba(45, 206, 137, 0.15);
        --danger-soft: rgba(245, 54, 92, 0.15);
        --info-soft: rgba(17, 205, 239, 0.15);
    }

    /* ===== Dashboard ===== */
    .dashboard {
      background: var(--bg-glass-strong);
      border-radius: var(--radius);
      padding: 24px 20px;
      box-shadow: var(--shadow-soft);
      margin-bottom: 25px;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255,255,255,0.4);
      position: relative;
      overflow: hidden;
    }
    .dashboard::before {
        content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px;
        background: linear-gradient(90deg, var(--primary), var(--success));
    }
    
    .dash-header {
        display: flex; justify-content: space-between; align-items: center;
        margin-bottom: 20px;
    }
    .dash-header h2 { margin: 0; font-size: 1.1rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }

    .balance-container { text-align: center; margin-bottom: 25px; }
    .balance-label { font-size: 0.9rem; color: var(--text-muted); margin-bottom: 5px; }
    .balance-amount { 
        font-size: 2.5rem; font-weight: 700; color: var(--text-main); 
        letter-spacing: -1px; line-height: 1;
    }
    .balance-amount.positive { color: var(--primary); }

    .stats-row { 
        display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;
        background: rgba(0,0,0,0.02);
        padding: 15px; border-radius: var(--radius-sm);
    }
    .stat-item { text-align: center; }
    .stat-label { font-size: 0.75rem; color: var(--text-muted); display: block; margin-bottom: 4px; white-space: nowrap; }
    .stat-val { font-size: 1rem; font-weight: 600; }
    .val-inc { color: var(--success); }
    .val-exp { color: var(--danger); }
    .val-save { color: var(--info); }

    .top-expenses-widget {
        margin-top: 20px; padding-top: 15px;
        border-top: 1px dashed rgba(0,0,0,0.1);
    }
    .widget-title { font-size: 0.85rem; font-weight: 600; color: var(--warning); margin-bottom: 10px; display: flex; align-items: center; gap: 6px; }
    .top-pill {
        display: inline-flex; align-items: center; gap: 6px;
        background: var(--danger-soft); padding: 4px 10px; border-radius: 20px;
        font-size: 0.75rem; color: var(--danger); margin-right: 5px; margin-bottom: 5px;
        font-weight: 500;
    }

    /* ===== Toolbar ===== */
    .toolbar-container {
        position: sticky; top: 10px; z-index: 100;
        margin-bottom: 20px;
        display: flex; gap: 12px; overflow-x: auto; padding: 5px 2px;
        scrollbar-width: none;
    }
    .toolbar-container::-webkit-scrollbar { display: none; }

    .btn-tool {
        flex: none; padding: 10px 18px; border-radius: 30px; border: none;
        font-size: 0.9rem; font-weight: 500; cursor: pointer;
        display: flex; align-items: center; gap: 8px;
        box-shadow: 0 4px 6px rgba(50, 50, 93, 0.11), 0 1px 3px rgba(0, 0, 0, 0.08);
        transition: transform 0.2s, box-shadow 0.2s;
        background: white; color: var(--text-main);
    }
    .btn-tool:active { transform: translateY(1px); box-shadow: none; }
    
    .btn-tool.ai { 
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; 
        position: relative; overflow: hidden;
    }
    .btn-tool.ai::after {
        content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
        background: linear-gradient(to right, transparent, rgba(255,255,255,0.3), transparent);
        transform: rotate(45deg); animation: shine 3s infinite;
    }
    @keyframes shine { 0% { transform: translateX(-100%) rotate(45deg); } 100% { transform: translateX(100%) rotate(45deg); } }

    .btn-tool.graph { background: #fb6340; color: white; border: none; box-shadow: 0 4px 10px rgba(251, 99, 64, 0.3); }
    .btn-tool.excel { background: #2dce89; color: white; border: none; box-shadow: 0 4px 10px rgba(45, 206, 137, 0.3); }
    .btn-tool.clear { background: #f5365c; color: white; border: none; box-shadow: 0 4px 10px rgba(245, 54, 92, 0.3); }
    
    .btn-tool.graph:active, .btn-tool.graph:hover { background: #e65230; transform: translateY(1px); }
    .btn-tool.excel:active, .btn-tool.excel:hover { background: #24b073; transform: translateY(1px); }
    .btn-tool.clear:active, .btn-tool.clear:hover { background: #d62c4d; transform: translateY(1px); }

    /* ===== Month Cards ===== */
    .month-card {
        background: var(--bg-glass);
        border-radius: var(--radius);
        margin-bottom: 16px;
        box-shadow: var(--shadow-soft);
        transition: transform 0.2s, box-shadow 0.2s;
        border: 1px solid rgba(255,255,255,0.5);
        overflow: hidden;
    }
    .month-card.open {
        background: var(--bg-glass-strong);
        box-shadow: var(--shadow-hover);
        z-index: 10;
        border-color: var(--primary);
    }

    .card-header {
        padding: 18px 20px;
        display: flex; justify-content: space-between; align-items: center;
        cursor: pointer;
        background: transparent;
    }
    .m-title { font-weight: 600; font-size: 1rem; color: var(--text-main); display: flex; align-items: center; gap: 10px; }
    .m-icon-box {
        width: 36px; height: 36px; background: white; border-radius: 10px;
        display: flex; align-items: center; justify-content: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05); color: var(--primary);
    }
    .night .m-icon-box { background: #334155; color: #fff; }

    .m-stat { text-align: right; }
    .m-balance { font-weight: 700; font-size: 1rem; display: block; }
    .m-subtext { font-size: 0.75rem; color: var(--text-muted); margin-top: 2px; }

    .card-body {
        display: none; padding: 20px;
        border-top: 1px solid rgba(0,0,0,0.05);
        background: rgba(255,255,255,0.3);
    }
    .month-card.open .card-body { display: block; animation: fadeIn 0.4s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

    /* Inputs Modern */
    .input-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
    .modern-input-group label {
        font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;
        color: var(--text-muted); margin-bottom: 6px; display: block; font-weight: 600;
    }
    .modern-input {
        width: 100%; padding: 12px 15px; border-radius: var(--radius-sm);
        border: 1px solid #e9ecef; background: #fff;
        font-size: 0.95rem; font-family: 'Sarabun'; color: var(--text-main);
        transition: all 0.2s;
    }
    .modern-input:focus {
        border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-soft); outline: none;
    }
    .night .modern-input { background: #1e293b; border-color: #334155; }

    /* Savings Section */
    .savings-section {
        background: var(--info-soft); border: 1px dashed var(--info);
        border-radius: var(--radius-sm); padding: 15px; margin-bottom: 20px;
    }
    .savings-header {
        font-size: 0.85rem; font-weight: 600; color: #0b7285; margin-bottom: 10px;
        display: flex; align-items: center; gap: 6px;
    }
    .night .savings-section { background: rgba(17, 205, 239, 0.1); border-color: rgba(17, 205, 239, 0.4); }
    .night .savings-header { color: #67e8f9; }
    .free-cash-display { text-align: right; font-size: 0.85rem; color: var(--text-muted); margin-top: 8px; }
    .free-cash-val { font-weight: 700; color: var(--text-main); font-size: 1rem; }

    /* Detail Items (Fixed Overflow) */
    .detail-container { margin-top: 15px; }
    .detail-row {
        display: flex; align-items: center; gap: 8px; margin-bottom: 10px;
        background: white; padding: 8px; border-radius: var(--radius-sm);
        box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        flex-wrap: nowrap; /* ป้องกันการขึ้นบรรทัดใหม่มั่ว */
    }
    .night .detail-row { background: #334155; }
    
    /* ปรับขนาด Input ในแถวให้ยืดหยุ่น */
    .type-select { width: 75px; flex-shrink: 0; border:none; background: transparent; font-weight: 600; cursor: pointer; }
    .type-select.inc { color: var(--success); }
    .type-select.exp { color: var(--danger); }
    
    .desc-input { 
        flex: 1; /* ยืดจนสุด */
        min-width: 0; /* สำคัญ: ป้องกันการดันจนล้น */
        border: none; background: transparent; font-size: 0.95rem; color: var(--text-main); 
    }
    
    .amt-input { 
        width: 70px; flex-shrink: 0; 
        border: none; background: transparent; text-align: right; font-weight: 600; color: var(--text-main); 
    }
    
    .btn-del {
        width: 28px; height: 28px; flex-shrink: 0;
        border-radius: 50%; border: none;
        background: var(--danger-soft); color: var(--danger); cursor: pointer;
        display: flex; align-items: center; justify-content: center; font-size: 0.8rem;
    }

    /* Buttons */
    .scan-btn {
        width: 100%; padding: 12px; border-radius: var(--radius-sm); border: 2px solid var(--primary);
        background: white; color: var(--primary); font-weight: 700; cursor: pointer;
        display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 15px;
        transition: all 0.2s;
    }
    .scan-btn:hover, .scan-btn:active { background: var(--primary); color: white; transform: translateY(-1px); }

    .action-row { display: flex; gap: 10px; margin-top: 15px; }
    .action-btn {
        flex: 1; padding: 12px; border: none; border-radius: var(--radius-sm);
        font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px;
        color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .btn-add-inc { background: #2dce89; }
    .btn-add-inc:active { background: #24b073; }
    .btn-add-exp { background: #f5365c; }
    .btn-add-exp:active { background: #d62c4d; }

    /* Modal & Loading */
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 1000; align-items: center; justify-content: center; padding: 20px; }
    .modal.show { display: flex; animation: fadeIn 0.2s; }
    .modal-card { background: white; width: 100%; max-width: 500px; border-radius: 20px; padding: 25px; max-height: 85vh; overflow-y: auto; position: relative; box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
    .night .modal-card { background: #1e293b; color: #fff; }
    .close-btn { position: absolute; top: 15px; right: 20px; font-size: 1.5rem; cursor: pointer; color: var(--text-muted); }
    
    .loading-overlay { 
        position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 2000;
        display: none; flex-direction: column; align-items: center; justify-content: center;
    }
    .night .loading-overlay { background: rgba(15, 23, 42, 0.9); }
    .loader { width: 48px; height: 48px; border: 4px solid var(--primary); border-bottom-color: transparent; border-radius: 50%; animation: rotation 1s linear infinite; }
    @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* ===== DESKTOP RESPONSIVE ===== */
    @media (min-width: 1024px) {
        .main-container { max-width: 1200px; }
        
        #cardsContainer {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* 3 คอลัมน์ */
            gap: 20px;
            align-items: start; /* ป้องกันการ์ดยืดสูงเท่ากัน */
        }
        
        .month-card {
            margin-bottom: 0;
            height: fit-content;
        }

        /* เมื่อการ์ดเปิดบน Desktop ให้ขยายเต็มแถว */
        .month-card.open {
            grid-column: 1 / -1; /* กินพื้นที่ตั้งแต่คอลัมน์แรกถึงสุดท้าย */
            transform: scale(1.02); /* ขยายใหญ่ขึ้นเล็กน้อย */
            box-shadow: 0 20px 50px rgba(0,0,0,0.1);
        }

        .toolbar-container { justify-content: center; padding: 10px 0; }
        .btn-tool { padding: 12px 24px; font-size: 1rem; }
        .btn-tool:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(50, 50, 93, 0.15); }
    }

    @media (min-width: 768px) and (max-width: 1023px) {
        .main-container { max-width: 90%; }
        #cardsContainer {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            align-items: start;
        }
        .month-card.open { grid-column: 1 / -1; }
    }

  </style>
</head>
<body id="mainBody">

  <!-- Background -->
  <div class="bg-layer">
    <div class="bg active" id="bg1"></div>
    <div class="bg" id="bg2"></div>
  </div>
  <div class="bg-overlay day" id="overlay"></div>

  <!-- Hidden Inputs -->
  <input type="file" id="receiptInput" accept="image/*" style="display: none;">

  <!-- Loading -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loader"></div>
    <p id="loadingText" style="margin-top:15px; font-weight:500;">AI กำลังทำงาน...</p>
  </div>

  <!-- Main Content Wrapper for Responsive -->
  <div class="main-container">
      <div class="dashboard">
        <div class="dash-header">
            <h2>My Budget Year</h2>
            <div style="font-size: 0.8rem; color: var(--text-muted);">
                <i class="fas fa-wallet"></i> Wallet
            </div>
        </div>
        
        <div class="balance-container">
            <div class="balance-label">ยอดคงเหลือสุทธิ</div>
            <div class="balance-amount" id="grandBalance">0</div>
        </div>

        <div class="stats-row">
            <div class="stat-item">
                <span class="stat-label">รายรับรวม</span>
                <span class="stat-val val-inc" id="grandIncome">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">รายจ่ายรวม</span>
                <span class="stat-val val-exp" id="grandExpense">0</span>
            </div>
            <div class="stat-item" style="border-left:1px solid rgba(0,0,0,0.1);">
                <span class="stat-label">เงินออมรวม</span>
                <span class="stat-val val-save" id="grandSavings">0</span>
            </div>
        </div>

        <div class="top-expenses-widget">
            <div class="widget-title"><i class="fas fa-trophy"></i> รายจ่ายสูงสุดปีนี้</div>
            <div id="yearTopExpList" style="white-space: nowrap; overflow-x: auto; padding-bottom: 5px;"></div>
        </div>
      </div>

      <div class="toolbar-container">
        <button class="btn-tool ai" onclick="analyzeBudgetWithAI()"><i class="fas fa-sparkles"></i> AI Coach</button>
        <button class="btn-tool graph" onclick="openChart()"><i class="fas fa-chart-pie"></i> กราฟ</button>
        <button class="btn-tool excel" onclick="exportToExcel()"><i class="fas fa-file-excel"></i> Excel</button>
        <button class="btn-tool clear" onclick="clearData()"><i class="fas fa-trash-alt"></i> ล้าง</button>
      </div>

      <div id="cardsContainer"></div>
  </div>

  <!-- Modals -->
  <div class="modal" id="chartModal">
    <div class="modal-card">
      <span class="close-btn" onclick="closeChart()">&times;</span>
      <h3 style="margin-top:0;">สถิติรายเดือน</h3>
      <canvas id="chart" height="300"></canvas>
    </div>
  </div>

  <div class="modal" id="aiModal">
    <div class="modal-card">
      <span class="close-btn" onclick="closeAiModal()">&times;</span>
      <h3 style="margin-top:0; display:flex; align-items:center; gap:10px; color:#667eea;">
        <i class="fas fa-robot"></i> AI Coach
      </h3>
      <div id="aiContent" style="line-height: 1.7; font-size: 0.95rem;"></div>
    </div>
  </div>

  <script>
    // --- Config & Init ---
    const apiKey = ""; 
    const backgroundImages = ['DSCF1292.jpg', 'DSCF1361.jpg', 'DSCF1400.jpg', 'DSC00543.jpg', 'DSCF0921.jpg'];
    let currentBgIndex = 0;
    
    // Background Animation
    const bgA = document.getElementById('bg1');
    const bgB = document.getElementById('bg2');
    bgA.style.backgroundImage = `url(${backgroundImages[0]})`;
    
    setInterval(() => {
      currentBgIndex = (currentBgIndex + 1) % backgroundImages.length;
      const show = (currentBgIndex % 2 === 0) ? bgA : bgB;
      const hide = (currentBgIndex % 2 === 0) ? bgB : bgA;
      show.style.backgroundImage = `url(${backgroundImages[currentBgIndex]})`;
      show.classList.add('active');
      hide.classList.remove('active');
    }, 8000);

    // Day/Night
    function updateDayNight() {
      const hour = new Date().getHours();
      const isNight = hour >= 18 || hour < 6;
      document.getElementById('overlay').className = `bg-overlay ${isNight ? 'night' : 'day'}`;
      if(isNight) document.body.classList.add('night');
      else document.body.classList.remove('night');
    }
    updateDayNight();

    // --- Data ---
    const months = ["มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน", "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"];
    
    let monthlyData = JSON.parse(localStorage.getItem('yearlyBudget_v1')) || months.map(() => ({ salary: 0, extra: 0, savings: 0, details: [] }));
    monthlyData = monthlyData.map(m => ({ ...m, savings: m.savings || 0 }));

    renderCards();

    // Helper Stats
    function calculateStats(m) {
        const dInc = m.details.filter(d => d.type === 'income').reduce((s, d) => s + (Number(d.amount)||0), 0);
        const dExp = m.details.filter(d => d.type === 'expense').reduce((s, d) => s + (Number(d.amount)||0), 0);
        const totalInc = (Number(m.salary)||0) + (Number(m.extra)||0) + dInc;
        const totalExp = dExp;
        const saving = Number(m.savings)||0;
        const balance = totalInc - totalExp;
        const freeBalance = balance - saving;
        
        return { totalInc, totalExp, balance, saving, freeBalance };
    }

    function calculateYearlyTop5() {
        const expMap = {};
        monthlyData.forEach(m => {
            m.details.filter(d => d.type === 'expense').forEach(d => {
                const key = d.desc.trim() || 'อื่นๆ';
                expMap[key] = (expMap[key] || 0) + (Number(d.amount)||0);
            });
        });
        return Object.entries(expMap)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 5)
            .map(([name, val]) => ({ name, val }));
    }

    // Refresh Stats ONLY (No Re-render)
    function refreshStats() {
        let gInc = 0, gExp = 0, gSave = 0;
        
        monthlyData.forEach((m, idx) => {
            const stats = calculateStats(m);
            gInc += stats.totalInc;
            gExp += stats.totalExp;
            gSave += stats.saving;

            const balEl = document.getElementById(`m-bal-${idx}`);
            const incEl = document.getElementById(`m-inc-${idx}`);
            const expEl = document.getElementById(`m-exp-${idx}`);
            const freeEl = document.getElementById(`m-free-${idx}`);
            
            if(balEl) {
                balEl.innerText = stats.balance.toLocaleString();
                balEl.className = `m-balance ${stats.balance >= 0 ? 'val-inc' : 'val-exp'}`;
            }
            if(incEl) incEl.innerText = stats.totalInc.toLocaleString();
            if(expEl) expEl.innerText = stats.totalExp.toLocaleString();
            if(freeEl) {
                freeEl.innerText = stats.freeBalance.toLocaleString();
                freeEl.style.color = stats.freeBalance >= 0 ? 'var(--text-main)' : 'var(--danger)';
            }
        });

        document.getElementById('grandIncome').innerText = gInc.toLocaleString();
        document.getElementById('grandExpense').innerText = gExp.toLocaleString();
        document.getElementById('grandSavings').innerText = gSave.toLocaleString();
        
        const gBal = gInc - gExp;
        const gBalEl = document.getElementById('grandBalance');
        gBalEl.innerText = gBal.toLocaleString();
        gBalEl.classList.toggle('positive', gBal >= 0);

        const top5 = calculateYearlyTop5();
        let topHtml = '';
        if (top5.length > 0) {
            top5.forEach(item => topHtml += `<span class="top-pill">${item.name} ${item.val.toLocaleString()}</span>`);
        } else {
            topHtml = '<span style="color:var(--text-muted); font-size:0.8rem;">ยังไม่มีข้อมูล</span>';
        }
        document.getElementById('yearTopExpList').innerHTML = topHtml;
    }

    function saveDataSilent() {
        localStorage.setItem('yearlyBudget_v1', JSON.stringify(monthlyData));
    }
    
    function saveDataAndRender() {
        saveDataSilent();
        renderCards();
    }

    function renderCards() {
      const container = document.getElementById('cardsContainer');
      const openStates = Array.from(document.querySelectorAll('.month-card')).map(c => c.classList.contains('open'));
      
      let html = '';

      monthlyData.forEach((m, idx) => {
        const stats = calculateStats(m);
        const isOpen = openStates[idx] ? 'open' : '';

        let detailsHtml = '';
        m.details.forEach((d, dIdx) => {
          const isInc = d.type === 'income';
          detailsHtml += `
            <div class="detail-row">
              <select class="type-select ${isInc?'inc':'exp'}" onchange="updateDetail(${idx}, ${dIdx}, 'type', this.value)">
                <option value="income" ${isInc?'selected':''}>+ รับ</option>
                <option value="expense" ${!isInc?'selected':''}>- จ่าย</option>
              </select>
              <input class="desc-input" type="text" placeholder="รายการ..." value="${d.desc}" oninput="updateDetail(${idx}, ${dIdx}, 'desc', this.value)">
              <input class="amt-input" type="number" placeholder="0" value="${d.amount}" oninput="updateDetail(${idx}, ${dIdx}, 'amount', this.value)">
              <button class="btn-del" onclick="removeDetail(${idx}, ${dIdx})"><i class="fas fa-times"></i></button>
            </div>
          `;
        });

        html += `
          <div class="month-card ${isOpen}" id="card-${idx}">
            <div class="card-header" onclick="toggleCard(${idx})">
              <div class="m-title">
                <div class="m-icon-box"><i class="far fa-calendar"></i></div>
                ${months[idx]}
              </div>
              <div class="m-stat">
                <span id="m-bal-${idx}" class="m-balance ${stats.balance >= 0 ? 'val-inc' : 'val-exp'}">${stats.balance.toLocaleString()}</span>
                <div class="m-subtext">คงเหลือ</div>
              </div>
            </div>

            <div class="card-body">
              <div class="input-row">
                <div class="modern-input-group">
                    <label>เงินเดือน</label>
                    <input class="modern-input" type="number" value="${m.salary||''}" placeholder="0" oninput="updateBase(${idx}, 'salary', this.value)">
                </div>
                <div class="modern-input-group">
                    <label>รายได้พิเศษ</label>
                    <input class="modern-input" type="number" value="${m.extra||''}" placeholder="0" oninput="updateBase(${idx}, 'extra', this.value)">
                </div>
              </div>

              <div class="savings-section">
                <div class="savings-header">
                    <i class="fas fa-piggy-bank"></i> จัดสรรเงินออม
                </div>
                <div class="modern-input-group">
                    <input class="modern-input" style="border-color:var(--info);" type="number" value="${m.savings||''}" placeholder="ระบุยอดออม..." oninput="updateBase(${idx}, 'savings', this.value)">
                </div>
                <div class="free-cash-display">
                    คงเหลือใช้จริง: <span id="m-free-${idx}" class="free-cash-val">${stats.freeBalance.toLocaleString()}</span>
                </div>
              </div>

              <div class="detail-container">
                ${detailsHtml}
              </div>

              <div class="action-row">
                <button class="action-btn btn-add-inc" onclick="addDetail(${idx}, 'income')"><i class="fas fa-plus"></i> เพิ่มรายรับ</button>
                <button class="action-btn btn-add-exp" onclick="addDetail(${idx}, 'expense')"><i class="fas fa-minus"></i> เพิ่มรายจ่าย</button>
              </div>

              <div style="margin-top: 20px;">
                <button class="scan-btn" onclick="triggerScan(${idx})">
                    <i class="fas fa-camera"></i> AI Scan Slip
                </button>
              </div>

              <div style="margin-top: 15px; font-size:0.8rem; color:var(--text-muted); display:flex; justify-content:space-between;">
                 <span>รับ: <b id="m-inc-${idx}" class="val-inc">${stats.totalInc.toLocaleString()}</b></span>
                 <span>จ่าย: <b id="m-exp-${idx}" class="val-exp">${stats.totalExp.toLocaleString()}</b></span>
              </div>
            </div>
          </div>
        `;
      });

      container.innerHTML = html;
      refreshStats(); 
    }

    function toggleCard(idx) {
        const card = document.getElementById(`card-${idx}`);
        // For desktop, we can choose to close others or not. 
        // Currently keeping behavior simple: toggle.
        card.classList.toggle('open');
    }

    function updateBase(idx, field, val) {
      monthlyData[idx][field] = Number(val);
      refreshStats();
      saveDataSilent();
    }
    
    function updateDetail(mIdx, dIdx, field, val) {
      monthlyData[mIdx].details[dIdx][field] = (field === 'amount') ? Number(val) : val;
      if (field === 'type') {
          saveDataAndRender();
      } else {
          refreshStats();
          saveDataSilent();
      }
    }

    function addDetail(idx, type) {
      monthlyData[idx].details.push({ type, desc: '', amount: '' });
      saveDataAndRender();
    }
    function removeDetail(mIdx, dIdx) {
      monthlyData[mIdx].details.splice(dIdx, 1);
      saveDataAndRender();
    }
    function clearData() {
      if(confirm('ต้องการลบข้อมูลทั้งหมดหรือไม่?')) {
        monthlyData = months.map(() => ({ salary: 0, extra: 0, savings: 0, details: [] }));
        saveDataAndRender();
      }
    }

    // --- AI Logic ---
    let currentUploadMonthIdx = -1;
    async function callGemini(prompt) { 
      const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
      const response = await fetch(url, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
      const data = await response.json(); return data.candidates[0].content.parts[0].text;
    }
    async function callGeminiVision(base64Image) {
      const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
      const response = await fetch(url, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: "Extract merchant and total amount. JSON format: { \"description\": \"string\", \"amount\": number, \"type\": \"expense\" }." }, { inlineData: { mimeType: "image/jpeg", data: base64Image } }] }] }) });
      const data = await response.json(); 
      const text = data.candidates[0].content.parts[0].text;
      return JSON.parse(text.replace(/```json/g, '').replace(/```/g, '').trim());
    }

    async function analyzeBudgetWithAI() {
        const overlay = document.getElementById('loadingOverlay');
        const modal = document.getElementById('aiModal');
        const content = document.getElementById('aiContent');
        
        document.getElementById('loadingText').innerText = "AI Coach กำลังวิเคราะห์...";
        overlay.style.display = 'flex';

        try {
            const summary = monthlyData.map((m, i) => {
                const inc = (m.salary||0) + (m.extra||0) + m.details.filter(d=>d.type==='income').reduce((s,d)=>s+(Number(d.amount)||0),0);
                const exp = m.details.filter(d=>d.type==='expense').reduce((s,d)=>s+(Number(d.amount)||0),0);
                const save = m.savings || 0;
                return `${months[i]}: In=${inc}, Out=${exp}, Saved=${save}`;
            }).join('\n');

            const prompt = `Act as a financial expert. Analyze this Thai Baht budget:\n${summary}\nGive 3 short, emoji-rich tips in Thai focusing on savings and expense control. Use markdown.`;
            const result = await callGemini(prompt);
            content.innerHTML = marked.parse(result);
            modal.classList.add('show');
        } catch(e) { alert("AI Error: " + e.message); } 
        finally { overlay.style.display = 'none'; }
    }

    function triggerScan(idx) { currentUploadMonthIdx = idx; document.getElementById('receiptInput').click(); }
    document.getElementById('receiptInput').addEventListener('change', async function(e) {
        if(this.files[0]) {
            const overlay = document.getElementById('loadingOverlay');
            document.getElementById('loadingText').innerText = "AI Scanning...";
            overlay.style.display = 'flex';
            const reader = new FileReader();
            reader.onload = async (ev) => {
                try {
                    const b64 = ev.target.result.split(',')[1];
                    const res = await callGeminiVision(b64);
                    if(res && res.amount) {
                        monthlyData[currentUploadMonthIdx].details.push({type: res.type||'expense', desc: res.description, amount: res.amount});
                        saveDataAndRender();
                    }
                } catch(err) { alert("Scan Failed"); }
                finally { overlay.style.display = 'none'; this.value=''; }
            };
            reader.readAsDataURL(this.files[0]);
        }
    });

    // --- Chart & Export ---
    let myChart = null;
    function openChart() {
        document.getElementById('chartModal').classList.add('show');
        const ctx = document.getElementById('chart').getContext('2d');
        if(myChart) myChart.destroy();
        
        const labels = months;
        const dInc = monthlyData.map(m=>(m.salary||0)+(m.extra||0)+m.details.filter(d=>d.type==='income').reduce((s,d)=>s+(d.amount||0),0));
        const dExp = monthlyData.map(m=>m.details.filter(d=>d.type==='expense').reduce((s,d)=>s+(d.amount||0),0));
        const dSave = monthlyData.map(m=>Number(m.savings)||0);

        myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    { label: 'รับ', data: dInc, backgroundColor: '#2dce89', borderRadius: 4 },
                    { label: 'จ่าย', data: dExp, backgroundColor: '#f5365c', borderRadius: 4 },
                    { label: 'ออม', data: dSave, backgroundColor: '#11cdef', borderRadius: 4 }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: { x: { grid: { display:false } }, y: { grid: { borderDash: [4, 4] } } },
                plugins: { legend: { position: 'bottom' } }
            }
        });
    }

    function exportToExcel() {
       let csv = "\uFEFFเดือน,ประเภท,รายการ,จำนวนเงิน\n";
       monthlyData.forEach((m, idx) => {
         const mm = months[idx];
         if(m.salary) csv += `${mm},รายรับ,เงินเดือน,${m.salary}\n`;
         if(m.extra) csv += `${mm},รายรับ,พิเศษ,${m.extra}\n`;
         if(m.savings) csv += `${mm},เงินออม,จัดสรรเงินออม,${m.savings}\n`;
         m.details.forEach(d => csv += `${mm},${d.type==='income'?'รายรับ':'รายจ่าย'},${d.desc},${d.amount}\n`);
       });
       const link = document.createElement("a");
       link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv;charset=utf-8;' }));
       link.download = "Budget_Yearly.csv";
       document.body.appendChild(link); link.click(); document.body.removeChild(link);
    }

    function closeChart() { document.getElementById('chartModal').classList.remove('show'); }
    function closeAiModal() { document.getElementById('aiModal').classList.remove('show'); }

  </script>
</body>
</html>
