<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</title>
  
  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&family=Sarabun:wght@300;400;500;600&display=swap" rel="stylesheet">
  
  <style>
    :root {
      /* Theme Variables */
      --primary: #5e72e4;
      --primary-soft: #eaecfb;
      --success: #2dce89;
      --success-soft: #e0fbf4;
      --danger: #f5365c;
      --danger-soft: #fee6ea;
      --warning: #fb6340;
      --warning-soft: #fff3cd;
      --info: #11cdef;
      --info-soft: #e0f7fa;
      
      --text-main: #32325d;
      --text-muted: #8898aa;
      --bg-body: #f8f9fe;
      --bg-card: #ffffff;
      
      --radius: 20px;
      --radius-sm: 12px;
      --shadow-soft: 0 7px 14px rgba(50, 50, 93, 0.1), 0 3px 6px rgba(0, 0, 0, 0.08);
      --bottom-nav-height: 70px;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
      font-family: 'Prompt', 'Sarabun', sans-serif;
      margin: 0; padding: 0;
      min-height: 100vh;
      color: var(--text-main);
      background: var(--bg-body);
      background-size: cover; background-position: center; background-attachment: fixed;
      padding-bottom: calc(var(--bottom-nav-height) + 20px);
      transition: background 0.3s, color 0.3s;
    }
    
    body.night {
        --text-main: #e2e8f0; --text-muted: #94a3b8;
        --bg-body: #0f172a; --bg-card: #1e293b;
        --primary-soft: rgba(94, 114, 228, 0.15); 
        --success-soft: rgba(45, 206, 137, 0.15);
        --danger-soft: rgba(245, 54, 92, 0.15); 
        --info-soft: rgba(17, 205, 239, 0.15);
        --warning-soft: rgba(251, 99, 64, 0.15);
    }

    /* Layout */
    .main-container {
        max-width: 600px; margin: 0 auto; width: 100%; padding: 20px;
    }

    /* Dashboard */
    .dashboard {
      background: var(--bg-card);
      border-radius: var(--radius); padding: 24px;
      box-shadow: var(--shadow-soft);
      margin-bottom: 25px; position: relative; overflow: hidden;
      border: 1px solid rgba(255,255,255,0.5);
    }
    .night .dashboard { border-color: rgba(255,255,255,0.05); }
    .dashboard::before {
        content: ''; position: absolute; top: 0; left: 0; right: 0; height: 6px;
        background: linear-gradient(90deg, var(--primary), var(--info));
    }
    
    .dash-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; }
    
    .user-profile-header { display: flex; align-items: center; gap: 12px; }
    .main-avatar {
        width: 45px; height: 45px; border-radius: 50%; object-fit: cover;
        border: 2px solid var(--bg-card); box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        display: none;
    }
    
    .balance-container { text-align: center; margin-bottom: 25px; padding: 10px 0; }
    .balance-label { font-size: 0.9rem; color: var(--text-muted); margin-bottom: 5px; font-weight: 500; }
    .balance-amount { 
        font-size: 2.8rem; font-weight: 700; color: var(--text-main); 
        letter-spacing: -1px; line-height: 1;
        transition: color 0.3s;
    }
    .balance-amount.positive { color: var(--primary); }

    .stats-row { 
        display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;
        background: var(--primary-soft); padding: 15px; border-radius: var(--radius-sm); 
        margin-top: 10px;
    }
    .night .stats-row { background: rgba(255,255,255,0.03); }
    .stat-item { text-align: center; }
    .stat-label { font-size: 0.75rem; color: var(--text-muted); display: block; margin-bottom: 4px; }
    .stat-val { font-size: 1rem; font-weight: 600; white-space: nowrap; }

    /* Month Cards */
    .month-card {
        background: var(--bg-card); border-radius: var(--radius); margin-bottom: 16px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05); transition: transform 0.2s, box-shadow 0.2s;
        border: 1px solid rgba(0,0,0,0.05); overflow: hidden;
    }
    .month-card.open {
        transform: scale(1.02); z-index: 10; border-color: var(--primary);
        box-shadow: 0 15px 35px rgba(0,0,0,0.1);
    }
    
    .card-header { padding: 18px 20px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
    .m-title { font-weight: 600; display: flex; align-items: center; gap: 12px; color: var(--text-main); font-size: 1.1rem; }
    .m-icon-box { 
        width: 40px; height: 40px; background: var(--primary-soft); border-radius: 12px; 
        display: flex; align-items: center; justify-content: center; color: var(--primary); font-size: 1.2rem;
    }
    
    .card-body { display: none; padding: 20px; border-top: 1px solid rgba(0,0,0,0.05); background: var(--bg-card); }
    .month-card.open .card-body { display: block; animation: fadeIn 0.3s; }

    /* Inputs */
    .input-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
    .modern-input {
        width: 100%; padding: 12px 15px; border-radius: var(--radius-sm); border: 1px solid #e2e8f0;
        background: var(--bg-body); font-size: 1rem; color: var(--text-main); font-family: 'Sarabun';
        transition: border-color 0.2s;
    }
    .night .modern-input { border-color: #334155; }
    .modern-input:focus { border-color: var(--primary); outline: none; }
    
    /* Category Picker */
    .category-picker-container { position: relative; display: flex; align-items: center; margin-bottom: 15px; }
    .category-scroll {
        display: flex; gap: 12px; overflow-x: auto; padding: 10px 5px; 
        scrollbar-width: none; flex: 1; scroll-behavior: smooth;
    }
    .cat-item { display: flex; flex-direction: column; align-items: center; gap: 5px; flex: none; width: 60px; cursor: pointer; }
    .cat-btn {
        width: 48px; height: 48px; border-radius: 50%; border: none;
        background: var(--bg-body); display: flex; align-items: center; justify-content: center;
        font-size: 1.4rem; transition: transform 0.1s, background 0.2s;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .cat-item:active .cat-btn { transform: scale(0.9); background: var(--primary-soft); }
    .cat-label { font-size: 0.75rem; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; text-align: center; }
    .night .cat-btn { background: #334155; }
    .cat-nav-btn {
      background: var(--bg-body); border: 1px solid rgba(0,0,0,0.05); width: 24px; height: 24px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text-muted); font-size: 0.8rem; box-shadow: 0 2px 4px rgba(0,0,0,0.05); z-index: 2;
    }
    .cat-nav-btn:hover { color: var(--primary); }
    .night .cat-nav-btn { background: #334155; }

    /* Action Buttons */
    .action-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 20px; }
    .action-btn {
        padding: 12px; border: none; border-radius: 50px;
        font-weight: 600; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px;
        color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.15); transition: transform 0.1s;
        font-size: 0.9rem; height: 60px;
    }
    .action-btn:active { transform: scale(0.95); }
    .action-btn i { font-size: 1.2rem; }
    
    .btn-inc { background: linear-gradient(135deg, #2dce89, #2dcecc); }
    .btn-exp { background: linear-gradient(135deg, #f5365c, #f56636); }
    .btn-scan { background: linear-gradient(135deg, #5e72e4, #825ee4); }

    /* Detail Row */
    .detail-row {
        display: flex; align-items: center; gap: 8px; margin-bottom: 10px;
        background: var(--bg-body); padding: 8px; border-radius: var(--radius-sm);
        border: 1px solid rgba(0,0,0,0.03);
    }
    .type-badge {
        width: 30px; height: 30px; border-radius: 8px; display: flex; align-items: center; justify-content: center;
        font-size: 0.8rem; font-weight: bold; cursor: pointer; flex-shrink: 0;
    }
    .badge-inc { background: var(--success-soft); color: var(--success); }
    .badge-exp { background: var(--danger-soft); color: var(--danger); }
    
    /* Bottom Navigation */
    .bottom-nav {
        position: fixed; bottom: 0; left: 0; width: 100%; height: var(--bottom-nav-height);
        background: var(--bg-card); 
        box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
        display: flex; justify-content: space-around; align-items: center;
        z-index: 1000; border-top-left-radius: 20px; border-top-right-radius: 20px;
        backdrop-filter: blur(10px);
        padding-bottom: env(safe-area-inset-bottom);
    }
    .nav-item {
        display: flex; flex-direction: column; align-items: center; gap: 4px;
        color: var(--text-muted); cursor: pointer; transition: color 0.2s; width: 20%;
    }
    .nav-item i { font-size: 1.3rem; margin-bottom: 2px; transition: transform 0.2s; }
    .nav-item span { font-size: 0.7rem; font-weight: 500; }
    .nav-item.active { color: var(--primary); }
    .nav-item.active i { transform: translateY(-3px); }

    /* Modals */
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); z-index: 2000; align-items: center; justify-content: center; padding: 20px; animation: fadeIn 0.2s; }
    .modal.show { display: flex; }
    .modal-card { 
        background: var(--bg-card); width: 100%; max-width: 500px; border-radius: 24px; padding: 25px; 
        max-height: 85vh; overflow-y: auto; position: relative; box-shadow: 0 20px 50px rgba(0,0,0,0.3); 
    }
    
    /* Chart Buttons Grid */
    .chart-btn-grid {
        margin-top: 20px; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;
    }
    
    /* Settings Grid */
    .color-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 15px; }
    .color-swatch { width: 40px; height: 40px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: transform 0.2s; }
    .color-swatch.active { border-color: var(--text-main); transform: scale(1.1); }
    
    .btn-mode {
        flex: 1; padding: 10px; border-radius: 12px; border: 1px solid #eee;
        background: transparent; color: var(--text-muted); cursor: pointer; font-weight: 500; font-size: 0.9rem;
        transition: all 0.2s;
    }
    .night .btn-mode { border-color: #334155; }
    .btn-mode.active { border-color: var(--primary); color: var(--primary); background: var(--primary-soft); }

    /* Utility */
    .hidden { display: none !important; }
    .btn-full { width: 100%; padding: 12px; border-radius: 12px; border: none; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 10px; }
    .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(94, 114, 228, 0.3); }
    .btn-outline { background: transparent; border: 2px solid var(--text-muted); color: var(--text-muted); }
    
    /* Chart container wrapper */
    .chart-container-wrapper {
        position: relative; flex: 1; min-height: 0; height: 45vh; width: 100%;
    }
    
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  </style>
</head>
<body id="mainBody">

  <!-- Views Container -->
  <div id="view-home" class="view-section">
      <div class="main-container">
          <!-- Dashboard -->
          <div class="dashboard">
              <div class="dash-header">
                  <div class="user-profile-header">
                      <img id="mainAvatar" class="main-avatar" src="" alt="Me">
                      <div class="user-info">
                          <h2 style="margin:0; font-size:1.2rem;">‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h2>
                          <div id="userRole" style="font-size:0.8rem; color:var(--text-muted);">Personal Wallet</div>
                      </div>
                  </div>
                  <div id="syncStatus" style="font-size:0.75rem; padding:4px 10px; border-radius:20px; background:#e2e8f0; color:#64748b;">
                      <i class="fas fa-wifi"></i> Offline
                  </div>
              </div>
              
              <div class="balance-container">
                  <div class="balance-label">‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</div>
                  <div class="balance-amount" id="grandBalance">0</div>
              </div>

              <div class="stats-row">
                  <div class="stat-item">
                      <span class="stat-label">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</span>
                      <span class="stat-val" style="color:var(--success)" id="grandIncome">0</span>
                  </div>
                  <div class="stat-item">
                      <span class="stat-label">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</span>
                      <span class="stat-val" style="color:var(--danger)" id="grandExpense">0</span>
                  </div>
                  <div class="stat-item" style="border-left:1px solid rgba(0,0,0,0.1)">
                      <span class="stat-label">‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°</span>
                      <span class="stat-val" style="color:var(--info)" id="grandSavings">0</span>
                  </div>
              </div>
          </div>

          <!-- Cards -->
          <div id="cardsContainer"></div>
      </div>
  </div>

  <!-- Bottom Navigation -->
  <div class="bottom-nav">
      <div class="nav-item active" onclick="switchView('home')">
          <i class="fas fa-home"></i>
          <span>‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</span>
      </div>
      <div class="nav-item" onclick="openChartModal()">
          <i class="fas fa-chart-pie"></i>
          <span>‡∏Å‡∏£‡∏≤‡∏ü</span>
      </div>
      <div class="nav-item" onclick="analyzeBudgetWithAI()">
          <i class="fas fa-robot"></i>
          <span>AI</span>
      </div>
      <div class="nav-item" onclick="openToolsModal()">
          <i class="fas fa-tools"></i>
          <span>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠</span>
      </div>
      <div class="nav-item" onclick="openSettingsModal()">
          <i class="fas fa-cog"></i>
          <span>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</span>
      </div>
  </div>

  <!-- Modals -->
  
  <!-- 1. Chart Modal -->
  <div class="modal" id="chartModal">
    <div class="modal-card">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <h3 style="margin:0;">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</h3>
        <i class="fas fa-times" style="cursor:pointer; font-size:1.2rem;" onclick="closeModal('chartModal')"></i>
      </div>
      <div class="chart-container-wrapper">
        <canvas id="chart"></canvas>
      </div>
      <!-- 3 Buttons Grid -->
      <div class="chart-btn-grid">
          <button class="btn-full" style="background:var(--primary-soft); color:var(--primary); margin:0;" onclick="renderChart('bar')">‡πÅ‡∏ó‡πà‡∏á</button>
          <button class="btn-full" style="background:var(--info-soft); color:var(--info); margin:0;" onclick="renderChart('line')">‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°</button>
          <button class="btn-full" style="background:var(--warning-soft); color:var(--warning); margin:0;" onclick="renderChart('pie')">‡∏ß‡∏á‡∏Å‡∏•‡∏°</button>
      </div>
    </div>
  </div>

  <!-- 2. AI Modal -->
  <div class="modal" id="aiModal">
    <div class="modal-card" style="max-height:80vh; overflow-x: hidden;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <h3 style="margin:0; color:var(--primary);"><i class="fas fa-robot"></i> AI Coach</h3>
        <i class="fas fa-times" style="cursor:pointer;" onclick="closeModal('aiModal')"></i>
      </div>
      <div id="aiContent" style="line-height:1.7; font-size:0.95rem; overflow-y:auto; overflow-x:hidden; word-wrap:break-word;"></div>
    </div>
  </div>

  <!-- 3. Tools Modal (Backup/Excel) -->
  <div class="modal" id="toolsModal">
    <div class="modal-card" style="max-width:400px;">
      <h3 style="margin-top:0;">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
      <button class="btn-full" style="background:#d1fae5; color:#065f46;" onclick="exportToExcel()">
          <i class="fas fa-file-excel"></i> ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel
      </button>
      <button class="btn-full" style="background:#f1f5f9; color:#475569;" onclick="exportJSON()">
          <i class="fas fa-download"></i> ‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Backup)
      </button>
      <button class="btn-full" style="background:#f1f5f9; color:#475569;" onclick="document.getElementById('restoreInput').click()">
          <i class="fas fa-upload"></i> ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Restore)
      </button>
      <hr style="margin:15px 0; border:none; border-top:1px solid #eee;">
      <button class="btn-full" style="background:#fee2e2; color:#dc2626;" onclick="clearData()">
          <i class="fas fa-trash-alt"></i> ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
      </button>
      <button class="btn-full" style="margin-top:10px; background:transparent; color:#888;" onclick="closeModal('toolsModal')">‡∏õ‡∏¥‡∏î</button>
    </div>
  </div>

  <!-- 4. Settings Modal -->
  <div class="modal" id="settingsModal">
    <div class="modal-card" style="max-width:400px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h3 style="margin:0;">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</h3>
            <i class="fas fa-times" style="cursor:pointer;" onclick="closeModal('settingsModal')"></i>
        </div>
        
        <!-- Auth Section -->
        <div id="authSection" style="margin-bottom:20px; padding-bottom:10px; border-bottom:1px solid #eee;">
            <button id="btnLogin" class="btn-full" style="background:var(--bg-body); border:1px solid #ddd; color:var(--text-main);" onclick="loginGoogle()">
                <i class="fab fa-google"></i> ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢ Google
            </button>
            <button id="btnLogout" class="btn-full hidden" style="background:#fee2e2; color:#dc2626;" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
            </button>
        </div>
        
        <!-- API Key Input -->
        <div style="margin-bottom:20px;">
            <h4 style="margin:0 0 5px 0; font-size:0.9rem; color:var(--text-muted);">Gemini API Key</h4>
            <div style="display:flex; gap:10px;">
                <input id="apiKeyInput" type="password" class="modern-input" placeholder="AIza..." style="padding:10px;">
                <button class="btn-full" style="width:auto; margin:0; background:var(--primary); color:white;" onclick="saveApiKey()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
            <a href="https://aistudio.google.com/app/apikey" target="_blank" style="font-size:0.75rem; color:var(--primary); text-decoration:none;">üëâ ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏Ç‡∏≠‡∏Ñ‡∏µ‡∏¢‡πå‡∏ü‡∏£‡∏µ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</a>
        </div>

        <!-- Mode Toggle -->
        <div style="margin-bottom:20px;">
            <h4 style="margin:0 0 10px 0; font-size:0.9rem; color:var(--text-muted);">‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•</h4>
            <div style="display:flex; gap:10px;">
                <button class="btn-mode" onclick="setDisplayMode('light')" id="btn-mode-light">
                    <i class="fas fa-sun"></i> ‡∏™‡∏ß‡πà‡∏≤‡∏á
                </button>
                <button class="btn-mode" onclick="setDisplayMode('night')" id="btn-mode-night">
                    <i class="fas fa-moon"></i> ‡∏°‡∏∑‡∏î
                </button>
                <button class="btn-mode" onclick="setDisplayMode('auto')" id="btn-mode-auto">
                    <i class="fas fa-magic"></i> ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                </button>
            </div>
        </div>

        <!-- Theme Color -->
        <div style="margin-bottom:20px;">
            <h4 style="margin:0 0 10px 0; font-size:0.9rem; color:var(--text-muted);">‡∏™‡∏µ‡∏ò‡∏µ‡∏°‡πÅ‡∏≠‡∏õ</h4>
            <div class="color-grid">
                <div class="color-swatch" style="background:#5e72e4;" onclick="setTheme('#5e72e4')"></div>
                <div class="color-swatch" style="background:#2dce89;" onclick="setTheme('#2dce89')"></div>
                <div class="color-swatch" style="background:#fb6340;" onclick="setTheme('#fb6340')"></div>
                <div class="color-swatch" style="background:#f5365c;" onclick="setTheme('#f5365c')"></div>
                <div class="color-swatch" style="background:#11cdef;" onclick="setTheme('#11cdef')"></div>
            </div>
        </div>

        <!-- Background Image -->
        <div>
            <h4 style="margin:0 0 10px 0; font-size:0.9rem; color:var(--text-muted);">‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á</h4>
            <button class="btn-full" style="background:var(--primary-soft); color:var(--primary); margin-bottom:5px;" onclick="document.getElementById('bgInput').click()">
                <i class="fas fa-image"></i> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
            </button>
            <button class="btn-full" style="background:#f1f5f9; color:#64748b;" onclick="resetBackground()">
                <i class="fas fa-undo"></i> ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
            </button>
        </div>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div style="position:fixed; inset:0; background:rgba(255,255,255,0.9); z-index:9999; display:none; flex-direction:column; align-items:center; justify-content:center;" id="loadingOverlay">
      <div style="width:40px; height:40px; border:4px solid var(--primary); border-top-color:transparent; border-radius:50%; animation:spin 1s linear infinite;"></div>
      <p style="margin-top:15px; font-weight:600;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô...</p>
  </div>
  <style>@keyframes spin{to{transform:rotate(360deg)}}</style>

  <!-- Hidden Inputs -->
  <input type="file" id="receiptInput" accept="image/*" style="display:none;" onchange="handleReceiptScan(this)">
  <input type="file" id="restoreInput" accept="application/json" style="display:none;" onchange="importJSON(this)">
  <input type="file" id="bgInput" accept="image/*" style="display:none;" onchange="handleBgChange(this)">

  <!-- Firebase Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- YOUR FIREBASE CONFIG ---
    const YOUR_FIREBASE_CONFIG = {
      apiKey: "AIzaSyDUliKbJO1YyUNjZdBvkBULaWlEaBzmcAA",
      authDomain: "budget1-ed2f4.firebaseapp.com",
      projectId: "budget1-ed2f4",
      storageBucket: "budget1-ed2f4.firebasestorage.app",
      messagingSenderId: "312969765873",
      appId: "1:312969765873:web:db0e163fe587149963da50",
      measurementId: "G-FXT8WGFGKP"
    };

    let db, auth, userId, appId;
    let useCloud = false;

    async function initFirebase() {
        if (!YOUR_FIREBASE_CONFIG) return;
        try {
            const app = initializeApp(YOUR_FIREBASE_CONFIG);
            auth = getAuth(app);
            db = getFirestore(app);
            appId = 'budget-app';

            // Global Auth Functions
            window.loginGoogle = async () => {
                try {
                    const provider = new GoogleAuthProvider();
                    await signInWithPopup(auth, provider);
                    window.closeModal('settingsModal');
                } catch(e) { alert("Login Failed: " + e.message); }
            };

            window.logout = async () => {
                await signOut(auth);
                window.location.reload();
            };

            onAuthStateChanged(auth, (user) => {
                const btnLogin = document.getElementById('btnLogin');
                const btnLogout = document.getElementById('btnLogout');
                const avatar = document.getElementById('mainAvatar');
                const role = document.getElementById('userRole');
                const syncBadge = document.getElementById('syncStatus');

                if (user) {
                    userId = user.uid;
                    useCloud = !user.isAnonymous;
                    
                    if (!user.isAnonymous) {
                        syncBadge.innerHTML = '<i class="fas fa-cloud"></i> Online';
                        syncBadge.style.background = '#dcfce7'; syncBadge.style.color = '#166534';
                        btnLogin.classList.add('hidden');
                        btnLogout.classList.remove('hidden');
                        if(user.photoURL) { avatar.src = user.photoURL; avatar.style.display = 'block'; }
                        role.innerText = user.displayName || "User";
                        startDataListener();
                    }
                } else {
                    useCloud = false;
                    syncBadge.innerHTML = '<i class="fas fa-wifi"></i> Offline';
                    btnLogin.classList.remove('hidden');
                    btnLogout.classList.add('hidden');
                    avatar.style.display = 'none';
                    role.innerText = "Personal Wallet";
                }
            });
        } catch (e) { console.log("Offline Mode"); }
    }

    function startDataListener() {
        if (!db || !userId) return;
        const docRef = doc(db, 'artifacts', appId, 'users', userId, 'budget_data', 'yearly');
        onSnapshot(docRef, (docSnap) => {
            if (docSnap.exists()) {
                const data = docSnap.data();
                if (data && data.monthlyData) {
                    window.monthlyData = data.monthlyData;
                    if(window.renderCards) window.renderCards();
                }
            } else {
                saveDataToCloud();
            }
        });
    }

    window.saveDataToCloud = async function() {
        if (useCloud && db && userId) {
            try {
                await setDoc(doc(db, 'artifacts', appId, 'users', userId, 'budget_data', 'yearly'), {
                    monthlyData: window.monthlyData,
                    lastUpdated: new Date().toISOString()
                });
            } catch (e) { console.error("Save Error", e); }
        }
    }

    initFirebase();
  </script>

  <!-- App Logic -->
  <script>
    const months = ["‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå", "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°", "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô", "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°", "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô", "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°", "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô", "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°", "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô", "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"];
    const categories = [
        {icon: 'üçî', label: '‡∏≠‡∏≤‡∏´‡∏≤‡∏£'},
        {icon: 'üöó', label: '‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á'},
        {icon: 'üè†', label: '‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å'},
        {icon: 'üõçÔ∏è', label: '‡∏ä‡πâ‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á'},
        {icon: 'üíä', label: '‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û'},
        {icon: 'üéâ', label: '‡∏ö‡∏±‡∏ô‡πÄ‡∏ó‡∏¥‡∏á'},
        {icon: 'üí°', label: '‡∏ö‡∏¥‡∏•‡∏ï‡πà‡∏≤‡∏á‡πÜ'},
        {icon: 'üí∏', label: '‡∏•‡∏á‡∏ó‡∏∏‡∏ô'}
    ];

    // Data Init
    window.monthlyData = JSON.parse(localStorage.getItem('yearlyBudget_v1')) || months.map(() => ({ salary: 0, extra: 0, savings: 0, budget: 0, details: [] }));
    window.monthlyData = window.monthlyData.map(m => ({ ...m, savings: m.savings || 0, budget: m.budget || 0 }));

    // Init Theme & Mode
    const savedTheme = localStorage.getItem('app_theme');
    if(savedTheme) document.documentElement.style.setProperty('--primary', savedTheme);
    const savedBg = localStorage.getItem('custom_bg');
    if(savedBg) document.body.style.backgroundImage = `url(${savedBg})`;

    // Load API Key
    const storedKey = localStorage.getItem('gemini_api_key');
    if(storedKey) document.getElementById('apiKeyInput').value = storedKey;

    function saveApiKey() {
        const key = document.getElementById('apiKeyInput').value;
        localStorage.setItem('gemini_api_key', key);
        alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å API Key ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
    }

    function setDisplayMode(mode) {
        localStorage.setItem('display_mode', mode);
        applyThemeMode();
        updateModeButtons(mode);
    }

    function applyThemeMode() {
        const mode = localStorage.getItem('display_mode') || 'auto';
        if (mode === 'auto') {
            const hour = new Date().getHours();
            const isNight = hour >= 18 || hour < 6;
            document.body.classList.toggle('night', isNight);
        } else if (mode === 'night') {
            document.body.classList.add('night');
        } else {
            document.body.classList.remove('night');
        }
    }
    
    function updateModeButtons(mode) {
        ['light', 'night', 'auto'].forEach(m => {
            const btn = document.getElementById(`btn-mode-${m}`);
            if(btn) {
                if(m === mode) btn.classList.add('active');
                else btn.classList.remove('active');
            }
        });
    }

    const currentMode = localStorage.getItem('display_mode') || 'auto';
    applyThemeMode();
    updateModeButtons(currentMode);

    // Core Logic
    function calculateStats(m) {
        const dInc = m.details.filter(d => d.type === 'income').reduce((s, d) => s + (Number(d.amount)||0), 0);
        const dExp = m.details.filter(d => d.type === 'expense').reduce((s, d) => s + (Number(d.amount)||0), 0);
        const totalInc = (Number(m.salary)||0) + (Number(m.extra)||0) + dInc;
        const totalExp = dExp;
        const balance = totalInc - totalExp;
        const freeBalance = balance - (Number(m.savings)||0);
        let progress = 0;
        if(m.budget > 0) progress = (totalExp / m.budget) * 100;
        return { totalInc, totalExp, balance, freeBalance, progress };
    }

    // Animation Utility
    function animateValue(obj, start, end, duration) {
        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            obj.innerHTML = Math.floor(progress * (end - start) + start).toLocaleString();
            if (progress < 1) window.requestAnimationFrame(step);
        };
        window.requestAnimationFrame(step);
    }

    // Render Main
    window.renderCards = function() {
        const container = document.getElementById('cardsContainer');
        const openStates = Array.from(document.querySelectorAll('.month-card')).map(c => c.classList.contains('open'));
        let html = '';
        let gInc = 0, gExp = 0, gSave = 0;

        window.monthlyData.forEach((m, idx) => {
            const stats = calculateStats(m);
            gInc += stats.totalInc; gExp += stats.totalExp; gSave += (Number(m.savings)||0);
            
            // Generate Details
            let detailsHtml = '';
            m.details.forEach((d, dIdx) => {
                const isInc = d.type === 'income';
                detailsHtml += `
                  <div class="detail-row">
                    <div class="type-badge ${isInc?'badge-inc':'badge-exp'}" onclick="toggleDetailType(${idx}, ${dIdx})">
                        ${isInc?'+':'-'}
                    </div>
                    <input class="desc-input" type="text" placeholder="‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£..." value="${d.desc}" oninput="updateDetail(${idx}, ${dIdx}, 'desc', this.value)">
                    <input class="amt-input" type="number" placeholder="0" value="${d.amount}" oninput="updateDetail(${idx}, ${dIdx}, 'amount', this.value)">
                    <i class="fas fa-times" style="color:#e2e8f0; cursor:pointer;" onclick="removeDetail(${idx}, ${dIdx})"></i>
                  </div>
                `;
            });

            // Quick Category Picker
            const catPickerHtml = categories.map(c => 
                `<div class="cat-item" onclick="addWithIcon(${idx}, '${c.icon} ${c.label}')">
                    <button class="cat-btn">${c.icon}</button>
                    <span class="cat-label">${c.label}</span>
                </div>`
            ).join('');

            // Copy Prev Button (Only for Feb onwards)
            const copyBtn = idx > 0 && m.details.length === 0 
                ? `<button class="btn-full" style="background:#f1f5f9; color:var(--primary); font-size:0.9rem;" onclick="copyFromPrev(${idx})"><i class="fas fa-copy"></i> ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô</button>` 
                : '';

            html += `
              <div class="month-card ${openStates[idx] ? 'open' : ''}" id="card-${idx}">
                <div class="card-header" onclick="toggleCard(${idx})">
                  <div class="m-title">
                    <div class="m-icon-box"><i class="far fa-calendar-alt"></i></div>
                    <div>${months[idx]}</div>
                  </div>
                  <div class="m-stat">
                    <span class="balance-amount" style="font-size:1.1rem; color:${stats.balance>=0?'var(--primary)':'var(--danger)'}">${stats.balance.toLocaleString()}</span>
                    <div style="width:80px; height:4px; background:#f1f5f9; border-radius:2px; margin-top:5px; overflow:hidden;">
                        <div style="height:100%; width:${Math.min(stats.progress, 100)}%; background:${stats.progress > 100 ? 'var(--danger)' : 'var(--success)'}"></div>
                    </div>
                  </div>
                </div>

                <div class="card-body">
                  <div style="margin-bottom:15px;">
                    <div class="input-row">
                        <div class="modern-input-group"><label>‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label><input class="modern-input" type="number" value="${m.salary||''}" placeholder="0" oninput="updateBase(${idx}, 'salary', this.value)"></div>
                        <div class="modern-input-group"><label>‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏û‡∏¥‡πÄ‡∏®‡∏©</label><input class="modern-input" type="number" value="${m.extra||''}" placeholder="0" oninput="updateBase(${idx}, 'extra', this.value)"></div>
                    </div>
                    <div class="modern-input-group" style="margin-top:10px;"><label>‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì (Budget)</label><input class="modern-input" style="border-color:var(--warning);" type="number" value="${m.budget||''}" placeholder="‡∏ï‡∏±‡πâ‡∏á‡∏á‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ..." oninput="updateBase(${idx}, 'budget', this.value)"></div>
                  </div>

                  ${copyBtn}
                  <div class="detail-container">${detailsHtml}</div>
                  
                  <div style="margin-top:15px;">
                      <div style="font-size:0.8rem; color:var(--text-muted); margin-bottom:5px;">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏î‡πà‡∏ß‡∏ô:</div>
                      <div class="category-picker-container">
                          <div class="cat-nav-btn" onclick="document.getElementById('cat-scroll-${idx}').scrollLeft -= 50"><i class="fas fa-chevron-left"></i></div>
                          <div id="cat-scroll-${idx}" class="category-scroll">${catPickerHtml}</div>
                          <div class="cat-nav-btn" onclick="document.getElementById('cat-scroll-${idx}').scrollLeft += 50"><i class="fas fa-chevron-right"></i></div>
                      </div>
                  </div>
                  
                  <div class="action-row">
                    <button class="action-btn btn-inc" onclick="addDetail(${idx}, 'income')">
                        <i class="fas fa-plus"></i>
                        <span>‡∏£‡∏±‡∏ö</span>
                    </button>
                    <button class="action-btn btn-exp" onclick="addDetail(${idx}, 'expense')">
                        <i class="fas fa-minus"></i>
                        <span>‡∏à‡πà‡∏≤‡∏¢</span>
                    </button>
                    <button class="action-btn btn-scan" onclick="triggerScan(${idx})">
                        <i class="fas fa-camera"></i>
                        <span>‡∏™‡πÅ‡∏Å‡∏ô</span>
                    </button>
                  </div>

                  <div style="margin-top:20px; padding-top:15px; border-top:1px dashed #eee;">
                      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                          <div style="font-size:0.9rem; font-weight:600; color:var(--info);"><i class="fas fa-piggy-bank"></i> ‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°</div>
                          <input class="modern-input" style="width:100px; padding:8px; text-align:right;" type="number" value="${m.savings||''}" placeholder="0" oninput="updateBase(${idx}, 'savings', this.value)">
                      </div>
                      <div style="text-align:right; font-size:0.85rem; color:var(--text-muted);">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡∏à‡∏£‡∏¥‡∏á: <b>${stats.freeBalance.toLocaleString()}</b></div>
                  </div>
                </div>
              </div>
            `;
        });

        container.innerHTML = html;
        
        // Rolling Numbers
        animateValue(document.getElementById('grandBalance'), 0, gInc - gExp, 800);
        document.getElementById('grandIncome').innerText = gInc.toLocaleString();
        document.getElementById('grandExpense').innerText = gExp.toLocaleString();
        document.getElementById('grandSavings').innerText = gSave.toLocaleString();
    }

    // Logic Functions
    window.toggleCard = (idx) => document.getElementById(`card-${idx}`).classList.toggle('open');
    window.switchView = (view) => {
        document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
        event.currentTarget.classList.add('active');
        window.scrollTo({top:0, behavior:'smooth'});
    }

    window.updateBase = (idx, field, val) => {
        window.monthlyData[idx][field] = Number(val);
        saveData();
    }

    window.updateDetail = (mIdx, dIdx, field, val) => {
        window.monthlyData[mIdx].details[dIdx][field] = field==='amount' ? Number(val) : val;
        saveDataSilent(); 
    }

    window.toggleDetailType = (mIdx, dIdx) => {
        const current = window.monthlyData[mIdx].details[dIdx].type;
        window.monthlyData[mIdx].details[dIdx].type = current === 'income' ? 'expense' : 'income';
        saveData();
        renderCards();
    }

    window.addDetail = (idx, type) => {
        window.monthlyData[idx].details.push({ type, desc: '', amount: '' });
        saveData(); renderCards();
    }
    
    window.addWithIcon = (idx, icon) => {
        window.monthlyData[idx].details.push({ type: 'expense', desc: icon + ' ', amount: '' });
        saveData(); renderCards();
    }

    window.removeDetail = (m, d) => {
        window.monthlyData[m].details.splice(d, 1);
        saveData(); renderCards();
    }

    window.copyFromPrev = (idx) => {
        const prev = window.monthlyData[idx-1];
        if(prev && prev.details.length > 0) {
            const newDetails = prev.details.map(d => ({...d}));
            window.monthlyData[idx].details = [...window.monthlyData[idx].details, ...newDetails];
            saveData(); renderCards();
        }
    }

    function saveData() {
        localStorage.setItem('yearlyBudget_v1', JSON.stringify(window.monthlyData));
        if(window.saveDataToCloud) window.saveDataToCloud();
    }
    function saveDataSilent() {
        localStorage.setItem('yearlyBudget_v1', JSON.stringify(window.monthlyData));
    }

    // Modal Helpers
    window.openChartModal = () => { document.getElementById('chartModal').classList.add('show'); renderChart('bar'); }
    window.openToolsModal = () => document.getElementById('toolsModal').classList.add('show');
    window.openSettingsModal = () => document.getElementById('settingsModal').classList.add('show');
    window.closeModal = (id) => document.getElementById(id).classList.remove('show');

    // Chart
    let myChart = null;
    window.renderChart = (type) => {
        const ctx = document.getElementById('chart').getContext('2d');
        if(myChart) myChart.destroy();
        
        const labels = months;
        let chartData = {};
        
        if (type === 'pie') {
            // Aggregate expenses by category for pie chart
            const expMap = {};
            window.monthlyData.forEach(m => {
                 m.details.filter(d => d.type === 'expense').forEach(d => {
                     let key = d.desc.trim() || '‡∏≠‡∏∑‡πà‡∏ô‡πÜ';
                     expMap[key] = (expMap[key] || 0) + (Number(d.amount)||0);
                 });
            });
            const sorted = Object.entries(expMap).sort((a,b) => b[1] - a[1]);
            let pLabels = [], pData = [], others = 0;
            sorted.forEach((item, index) => {
                if (index < 8) { pLabels.push(item[0]); pData.push(item[1]); }
                else others += item[1];
            });
            if (others > 0) { pLabels.push('‡∏≠‡∏∑‡πà‡∏ô‡πÜ'); pData.push(others); }
            
            const colors = ['#f5365c', '#fb6340', '#ffd600', '#2dce89', '#11cdef', '#5e72e4', '#8965e0', '#32325d', '#adb5bd'];
            chartData = {
                labels: pLabels,
                datasets: [{ data: pData, backgroundColor: colors.slice(0, pData.length), borderWidth: 0 }]
            };
        } else {
            // Bar or Line chart data
            let datasets = [];
            if (type === 'bar') {
                const dInc = window.monthlyData.map(m=>calculateStats(m).totalInc);
                const dExp = window.monthlyData.map(m=>calculateStats(m).totalExp);
                datasets = [
                    { label: '‡∏£‡∏±‡∏ö', data: dInc, backgroundColor: '#2dce89', borderRadius:4 },
                    { label: '‡∏à‡πà‡∏≤‡∏¢', data: dExp, backgroundColor: '#f5365c', borderRadius:4 }
                ];
            } else {
                const dSave = window.monthlyData.map(m=>Number(m.savings)||0);
                const dFree = window.monthlyData.map(m=>calculateStats(m).freeBalance);
                datasets = [
                    { label: '‡∏≠‡∏≠‡∏°', data: dSave, borderColor: '#11cdef', backgroundColor: 'rgba(17,205,239,0.2)', fill:true, tension:0.4 },
                    { label: '‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÉ‡∏ä‡πâ', data: dFree, borderColor: '#2dce89', borderDash:[5,5], borderWidth:2, tension:0.4 }
                ];
            }
            chartData = { labels: labels, datasets: datasets };
        }

        myChart = new Chart(ctx, {
            type: type === 'line' ? 'line' : (type === 'pie' ? 'doughnut' : 'bar'),
            data: chartData,
            options: { 
                responsive: true, 
                maintainAspectRatio: false,
                scales: type === 'pie' ? {} : { x: { grid: { display:false } }, y: { grid: { borderDash: [4, 4] }, beginAtZero: true } },
                plugins: { legend: { position: 'bottom' }, title: { display: type==='pie', text: '‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏õ‡∏µ‡∏ô‡∏µ‡πâ' } }
            }
        });
    }

    // Theme Customizer
    window.setTheme = (color) => {
        document.documentElement.style.setProperty('--primary', color);
        document.documentElement.style.setProperty('--primary-soft', color + '20'); 
        localStorage.setItem('app_theme', color);
    }
    
    // Background Handlers
    window.handleBgChange = (input) => {
        if(input.files[0]) {
            const r = new FileReader();
            r.onload = (e) => {
                localStorage.setItem('custom_bg', e.target.result);
                document.body.style.backgroundImage = `url(${e.target.result})`;
                window.closeModal('settingsModal');
            };
            r.readAsDataURL(input.files[0]);
        }
    }
    window.resetBackground = () => {
        localStorage.removeItem('custom_bg');
        document.body.style.backgroundImage = 'none';
        window.closeModal('settingsModal');
    }

    // AI & Gemini
    const apiKey = "AIzaSyD-wO4EzjPsLNrXC0v8J4jqTunMKWMJRjw"; // ‡πÉ‡∏™‡πà‡∏Ñ‡∏µ‡∏¢‡πå‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö
    window.analyzeBudgetWithAI = async () => {
        const key = localStorage.getItem('gemini_api_key') || apiKey;
        
        document.getElementById('loadingOverlay').style.display='flex';
        try {
            const sum = window.monthlyData.map((m,i)=>`${months[i]}: In=${calculateStats(m).totalInc}, Out=${calculateStats(m).totalExp}`).join('\n');
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`, {
                method:'POST', headers:{'Content-Type':'application/json'},
                body:JSON.stringify({contents:[{parts:[{text:`Analyze this budget:\n${sum}\nGive 3 quick tips in Thai markdown.`}]}]})
            });
            const d = await res.json();
            document.getElementById('aiContent').innerHTML = marked.parse(d.candidates[0].content.parts[0].text);
            document.getElementById('aiModal').classList.add('show');
        } catch(e) { alert("API Error: " + e.message); }
        finally { document.getElementById('loadingOverlay').style.display='none'; }
    }
    
    // Slip Scan
    window.triggerScan = (idx) => { window.scanIdx = idx; document.getElementById('receiptInput').click(); }
    window.handleReceiptScan = async (input) => {
        const key = localStorage.getItem('gemini_api_key') || apiKey;

        if(!input.files[0]) return;
        document.getElementById('loadingOverlay').style.display='flex';
        const r = new FileReader();
        r.onload = async (e) => {
            try {
                const b64 = e.target.result.split(',')[1];
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`, {
                    method:'POST', headers:{'Content-Type':'application/json'},
                    body:JSON.stringify({contents:[{role:"user", parts:[{text:"Extract: {\"desc\":\"str\",\"amount\":num,\"type\":\"expense\"}"},{inlineData:{mimeType:"image/jpeg",data:b64}}]}]})
                });
                const d = await res.json();
                const json = JSON.parse(d.candidates[0].content.parts[0].text.replace(/```json/g,'').replace(/```/g,'').trim());
                if(json.amount) {
                    window.monthlyData[window.scanIdx].details.push({type:json.type, desc:json.desc, amount:json.amount});
                    saveData(); renderCards();
                }
            } catch(e) { alert("Scan Failed"); }
            finally { document.getElementById('loadingOverlay').style.display='none'; input.value=''; }
        };
        r.readAsDataURL(input.files[0]);
    }

    // JSON/Excel
    window.exportJSON = () => {
        const a = document.createElement('a');
        a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(window.monthlyData));
        a.download = "budget_backup.json"; a.click();
    }
    window.importJSON = (input) => {
        const r = new FileReader();
        r.onload = (e) => { window.monthlyData = JSON.parse(e.target.result); saveData(); renderCards(); alert("Restore Success"); };
        r.readAsText(input.files[0]);
    }

    // Start
    renderCards();
  </script>
</body>
</html>
