<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</title>
  
  <!-- PWA Manifest & iOS Support -->
  <link rel="manifest" href="data:application/manifest+json;charset=utf-8,%7B%22name%22%3A%22%E0%B8%81%E0%B8%B2%E0%B8%A3%E0%B9%80%E0%B8%87%E0%B8%B4%E0%B8%99%E0%B8%82%E0%B8%AD%E0%B8%87%E0%B8%89%E0%B8%B1%E0%B8%99%22%2C%22short_name%22%3A%22MyBudget%22%2C%22start_url%22%3A%22.%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%23f8f9fe%22%2C%22theme_color%22%3A%22%235e72e4%22%2C%22icons%22%3A%5B%7B%22src%22%3A%22https%3A%2F%2Fcdn-icons-png.flaticon.com%2F512%2F2344%2F2344147.png%22%2C%22sizes%22%3A%22512x512%22%2C%22type%22%3A%22image%2Fpng%22%7D%5D%7D" />
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="MyBudget">
  <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2344/2344147.png">
  <meta name="theme-color" content="#5e72e4">

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&family=Sarabun:wght@300;400;500;600&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --primary: #5e72e4;
      --primary-soft: #eaecfb;
      --success: #2dce89;
      --success-soft: #e0fbf4;
      --danger: #f5365c;
      --danger-soft: #fee6ea;
      --warning: #fb6340;
      --info: #11cdef;
      --info-soft: #e0f7fa;
      --text-main: #32325d;
      --text-muted: #8898aa;
      --bg-body: #f8f9fe;
      --bg-card: #ffffff;
      --radius: 24px;
      --radius-sm: 15px;
      --bottom-nav-height: 80px;
      --shadow-soft: 0 10px 25px rgba(0,0,0,0.06);
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
      font-family: 'Prompt', 'Sarabun', sans-serif;
      margin: 0; padding: 0; min-height: 100vh;
      color: var(--text-main); background: var(--bg-body);
      padding-bottom: calc(var(--bottom-nav-height) + 15px);
      transition: background 0.3s, color 0.3s;
      overscroll-behavior-y: none;
      background-size: cover; background-position: center; background-attachment: fixed;
    }
    
    body.night {
        --text-main: #f1f5f9; --text-muted: #94a3b8;
        --bg-body: #0f172a; --bg-card: #1e293b;
        --primary-soft: rgba(94, 114, 228, 0.2);
    }

    .main-container { max-width: 600px; margin: 0 auto; width: 100%; padding: 20px; }
    
    .view-section { display: none; }
    .view-section.active { display: block; animation: fadeIn 0.3s ease; }

    /* Dashboard & Cards */
    .dashboard {
      background: var(--bg-card); border-radius: var(--radius); padding: 25px 20px;
      box-shadow: var(--shadow-soft); margin-bottom: 25px; position: relative; overflow: hidden;
      border: 1px solid rgba(0,0,0,0.02);
    }
    .dashboard::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 5px; background: linear-gradient(90deg, var(--primary), var(--info)); }
    
    .dash-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .main-avatar { width: 45px; height: 45px; border-radius: 50% !important; object-fit: cover; border: 2px solid var(--bg-card); box-shadow: 0 4px 10px rgba(0,0,0,0.1); display: none; }
    
    .balance-container { text-align: center; margin: 15px 0; }
    .balance-amount { font-size: 2.8rem; font-weight: 700; letter-spacing: -1px; line-height: 1; transition: color 0.3s; }
    .stats-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; background: var(--primary-soft); padding: 15px; border-radius: var(--radius-sm); margin-top: 20px; }
    .stat-item { text-align: center; }
    .stat-label { font-size: 0.7rem; color: var(--text-muted); display: block; margin-bottom: 3px; font-weight: 700; }
    .stat-val { font-size: 0.95rem; font-weight: 700; }

    /* Nav & Back Button */
    .nav-header { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }
    .btn-back { 
        width: 48px; height: 48px; border-radius: 16px; background: var(--bg-card); 
        border: none; box-shadow: var(--shadow-soft); display: flex; align-items: center; justify-content: center; 
        color: var(--text-main); cursor: pointer; transition: all 0.2s; font-size: 1.2rem;
    }
    .btn-back:active { transform: scale(0.9); }

    /* List Items */
    .month-summary-card {
        background: var(--bg-card); border-radius: var(--radius); margin-bottom: 12px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.03); border: 1px solid rgba(0,0,0,0.01);
        padding: 16px 20px; display: flex; justify-content: space-between; align-items: center;
        cursor: pointer; transition: transform 0.2s;
    }
    .m-left { display: flex; align-items: center; gap: 15px; }
    .m-icon { width: 44px; height: 44px; background: var(--primary-soft); border-radius: 14px; display: flex; align-items: center; justify-content: center; color: var(--primary); font-weight: 700; }

    /* Inputs Modern */
    .modern-input { 
        width: 100%; padding: 14px 16px; border-radius: 15px; border: 1px solid #eef2f6; 
        background: rgba(0,0,0,0.04); 
        font-size: 1rem; font-family: 'Sarabun'; color: var(--text-main); outline: none; transition: all 0.2s;
    }
    .night .modern-input { background: rgba(255,255,255,0.06); border-color: #334155; }
    .modern-input:focus { border-color: var(--primary); background: #fff; box-shadow: 0 0 0 4px var(--primary-soft); }
    .night .modern-input:focus { background: #1e293b; }

    /* Detail Row & Badges */
    .detail-row { 
        display: flex; align-items: center; gap: 8px; margin-bottom: 12px; 
        background: var(--bg-card); padding: 10px; border-radius: var(--radius-sm);
        box-shadow: 0 2px 6px rgba(0,0,0,0.02); border: 1px solid rgba(0,0,0,0.02);
        width: 100%;
    }
    .type-badge-circle { 
        width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; 
        font-size: 0.9rem; font-weight: 800; color: #fff; flex-shrink: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .badge-inc { background: var(--success); }
    .badge-exp { background: var(--danger); }
    
    .desc-input { 
        flex: 1; min-width: 0; border: none; 
        background: rgba(0,0,0,0.04); padding: 10px 14px; border-radius: 12px;
        font-size: 0.95rem; color: var(--text-main); outline: none; font-family: 'Sarabun'; 
    }
    .night .desc-input { background: rgba(255,255,255,0.06); }
    .amt-input { 
        width: 90px; text-align: right; border: none; 
        background: rgba(0,0,0,0.04); padding: 10px 12px; border-radius: 12px;
        font-weight: 700; font-size: 1rem; color: var(--text-main); outline: none; 
    }
    .night .amt-input { background: rgba(255,255,255,0.06); }

    .btn-del-modern { width: 32px; height: 32px; border-radius: 50%; border: none; background: var(--danger-soft); color: var(--danger); display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; font-size: 0.8rem; }

    /* Action Buttons Area */
    .action-container { margin-top: 35px; margin-bottom: 30px; }
    .action-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
    .btn-action-main { 
        padding: 12px; border-radius: 22px; border: none; font-weight: 700; cursor: pointer; 
        display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px;
        color: white; box-shadow: 0 6px 15px rgba(0,0,0,0.1); height: 85px; transition: all 0.2s;
    }
    .btn-action-main:active { transform: scale(0.94); }
    .btn-action-inc { background: linear-gradient(135deg, #2dce89, #2dcecc); }
    .btn-action-exp { background: linear-gradient(135deg, #f5365c, #f56636); }
    .btn-action-scan { background: #34495e; }

    .btn-rounded-pill { padding: 10px 20px; border-radius: 50px; border: none; font-weight: 700; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; color: #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }

    /* Bottom Navigation - FIXED: Small text for mobile comfort */
    .bottom-nav { 
        position: fixed; bottom: 0; left: 0; width: 100%; height: var(--bottom-nav-height); 
        background: var(--bg-card); box-shadow: 0 -10px 30px rgba(0,0,0,0.08); 
        display: flex; justify-content: space-around; align-items: center; 
        z-index: 2000; border-top-left-radius: 30px; border-top-right-radius: 30px;
        padding-bottom: env(safe-area-inset-bottom);
        backdrop-filter: blur(15px);
        padding-top: 5px;
    }
    .nav-item { 
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        gap: 4px; color: var(--text-muted); cursor: pointer; transition: all 0.3s;
        padding: 8px 10px; border-radius: 25px; width: 18%;
    }
    .nav-item.active { 
        color: var(--primary); 
        background: var(--primary-soft);
    }
    .nav-item i { font-size: 1.2rem; } /* Compact icon */
    .nav-item span { font-size: 0.6rem; font-weight: 700; } /* Compact text */

    /* Selection Styles */
    .modern-select {
        flex: 1; min-width: 0; border: none; 
        background: rgba(0,0,0,0.04); padding: 10px 14px; border-radius: 12px;
        font-size: 0.95rem; font-family: 'Sarabun'; font-weight: 500; color: var(--text-main); outline: none;
    }
    .night .modern-select { background: rgba(255,255,255,0.06); color: #fff; }

    /* Modals & Large Close Button */
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.65); z-index: 3000; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(5px); }
    .modal.show { display: flex; }
    .modal-card { background: var(--bg-card); width: 100%; max-width: 480px; border-radius: 35px; padding: 45px 25px 25px; position: relative; box-shadow: 0 25px 60px rgba(0,0,0,0.4); max-height: 85vh; overflow-y: auto; }
    
    .close-btn { 
        position: absolute; top: 12px; right: 12px; 
        width: 46px; height: 46px; 
        display: flex; align-items: center; justify-content: center;
        background: #f1f5f9; border-radius: 50%;
        font-size: 1.5rem; cursor: pointer; color: var(--text-main); 
        z-index: 3100; transition: background 0.2s;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .night .close-btn { background: #334155; color: #fff; }
    .close-btn:active { background: #e2e8f0; transform: scale(0.9); }

    .modal-section { margin-bottom: 25px; padding: 20px; background: rgba(0,0,0,0.02); border-radius: 22px; border: 1px solid rgba(0,0,0,0.02); }
    .modal-section h4 { margin-top: 0; margin-bottom: 15px; font-size: 0.9rem; font-weight: 800; color: var(--primary); text-transform: uppercase; }
    
    .btn-full { width: 100%; padding: 16px; border-radius: 50px; border: none; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 12px; transition: all 0.2s; font-size: 1rem; }
    .btn-chart-pill { flex: 1; padding: 12px; border-radius: 50px; border: 1px solid #ddd; background: transparent; color: var(--text-muted); font-weight: 700; cursor: pointer; }
    .btn-chart-pill.active { border-color: var(--primary); color: var(--primary); background: var(--primary-soft); }

    /* AI Loader Robot */
    .loading { position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 4000; display: none; align-items: center; justify-content: center; flex-direction: column; }
    .ai-loader-icon { font-size: 5rem; color: var(--primary); margin-bottom: 15px; animation: pulse 1.5s infinite; }
    @keyframes pulse { 0%, 100% { transform: scale(0.95); opacity: 0.7; } 50% { transform: scale(1.1); opacity: 1; } }

    /* Portfolio Graph */
    .savings-portfolio { margin-top: 15px; display: flex; gap: 15px; align-items: center; }
    .sp-chart-container { width: 85px; height: 85px; flex-shrink: 0; }
    .sp-list { flex: 1; display: flex; flex-direction: column; gap: 5px; }
    .sp-item { display: flex; justify-content: space-between; font-size: 0.8rem; }
    .sp-color { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 5px; }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body id="mainBody">

  <!-- AI Loader -->
  <div class="loading" id="loadingOverlay">
    <i class="fas fa-robot ai-loader-icon"></i>
    <p id="aiLoaderText" style="font-weight:800; color:var(--primary); margin-top:20px; font-size:1.1rem;">AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏¥‡∏î...</p>
  </div>

  <!-- ================= VIEW: HOME ================= -->
  <div id="view-home" class="view-section active">
      <div class="main-container">
          <div class="dashboard">
              <div class="dash-header">
                  <div style="display:flex; align-items:center; gap:12px;">
                      <img id="mainAvatar" class="main-avatar" src="" alt="">
                      <div>
                          <h2 id="userNameLabel" style="margin:0; font-size:1.1rem;">‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô</h2>
                          <div id="userRoleLabel" style="font-size:0.75rem; color:var(--text-muted); font-weight:600;">Personal Wallet</div>
                      </div>
                  </div>
                  <div id="syncStatus" style="font-size:1.1rem; padding:6px 12px; border-radius:50px; background:#e2e8f0; color:#64748b;">
                      <i class="fas fa-wifi"></i>
                  </div>
              </div>
              
              <div class="balance-container">
                  <div class="balance-label" style="font-weight:600; color:var(--text-muted); font-size:0.9rem;">
                    ‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ (<span id="currMonthName">...</span>)
                  </div>
                  <div class="balance-amount" id="currentMonthBalance">0</div>
                  <div style="font-size:0.85rem; color:var(--text-muted); margin-top:12px;">
                      ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏∞‡∏™‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏õ‡∏µ: <span id="grandBalance" style="font-weight:800; color:var(--text-main);">0</span>
                  </div>
              </div>

              <div class="stats-row">
                  <div class="stat-item"><span class="stat-label">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</span><span class="stat-val" style="color:var(--success)" id="dashIncome">0</span></div>
                  <div class="stat-item"><span class="stat-label">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</span><span class="stat-val" style="color:var(--danger)" id="dashExpense">0</span></div>
                  <div class="stat-item" style="border-left:1px solid rgba(0,0,0,0.1)"><span class="stat-label">‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°</span><span class="stat-val" style="color:var(--info)" id="dashSavings">0</span></div>
              </div>
              
              <div class="top-expenses-widget" style="margin-top:25px;">
                  <div style="font-size:0.85rem; font-weight:800; color:var(--info); margin-bottom:12px;"><i class="fas fa-chart-pie"></i> ‡∏û‡∏≠‡∏£‡πå‡∏ï‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏° (‡∏õ‡∏µ)</div>
                  <div class="savings-portfolio">
                      <div class="sp-chart-container"><canvas id="savingsDoughnut"></canvas></div>
                      <div id="savingsLegend" class="sp-list"></div>
                  </div>
              </div>
          </div>
          
          <div id="homeMonthList"></div>
      </div>
  </div>

  <!-- ================= VIEW: MONTH DETAIL ================= -->
  <div id="view-month" class="view-section">
      <div class="main-container">
          <div class="nav-header">
              <button class="btn-back" onclick="window.switchView('home')"><i class="fas fa-arrow-left"></i></button>
              <h2 class="page-title" id="detailMonthName">‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°</h2>
          </div>

          <div class="dashboard">
              <div class="balance-container" style="margin-bottom:15px;">
                  <div class="balance-label" style="font-weight:600; color:var(--text-muted); font-size:0.9rem;">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏à‡∏£‡∏¥‡∏á (‡∏´‡∏±‡∏Å‡∏≠‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß)</div>
                  <div class="balance-amount" id="monthGrandBalance">0</div>
                  <div style="width:100%; height:10px; background:#f1f5f9; border-radius:10px; margin-top:18px; overflow:hidden; border:1px solid #eee;">
                      <div id="monthProgressBar" style="height:100%; width:0%; background:var(--success); transition:width 0.8s ease-out;"></div>
                  </div>
              </div>
              <div class="stats-row">
                  <div class="stat-item"><span class="stat-label">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</span><span class="stat-val" style="color:var(--success)" id="monthGrandIncome">0</span></div>
                  <div class="stat-item"><span class="stat-label">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</span><span class="stat-val" style="color:var(--danger)" id="monthGrandExpense">0</span></div>
                  <div class="stat-item" style="border-left:1px solid rgba(0,0,0,0.1)"><span class="stat-label">‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°</span><span class="stat-val" style="color:var(--info)" id="monthGrandSavings">0</span></div>
              </div>

              <!-- Month Savings Portfolio -->
              <div class="top-expenses-widget" style="margin-top:20px; padding-top:15px; border-top: 1px dashed rgba(0,0,0,0.08);">
                  <div style="font-size:0.85rem; font-weight:800; color:var(--info); margin-bottom:12px;"><i class="fas fa-chart-pie"></i> ‡∏û‡∏≠‡∏£‡πå‡∏ï‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div>
                  <div class="savings-portfolio">
                      <div class="sp-chart-container"><canvas id="monthSavingsDoughnut"></canvas></div>
                      <div id="monthSavingsLegend" class="sp-list"></div>
                  </div>
              </div>
          </div>

          <div class="modal-section" style="background:var(--bg-card); margin-bottom:15px; box-shadow: var(--shadow-soft);">
              <h4 style="color:var(--text-main); font-size:0.9rem;">üí∞ ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏´‡∏•‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h4>
              <input class="modern-input" type="number" id="inpSalary" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô..." oninput="updateCurrentMonthBase('salary', this.value)">
              <div id="copyPrevBtnContainer" style="margin-top:12px;"></div>
          </div>
          
          <div class="modal-section" style="background:var(--bg-card); border-left:5px solid var(--success); margin-bottom:15px; box-shadow: var(--shadow-soft);">
              <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                  <h4 style="margin:0; color:var(--success); font-size:0.9rem;">‚ú® ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏û‡∏¥‡πÄ‡∏®‡∏©</h4>
                  <button class="btn-rounded-pill" style="background:var(--success); font-size:0.8rem; padding:8px 16px;" onclick="addExtraIncomeItem()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
              </div>
              <div id="extraIncomeList"></div>
          </div>

          <div class="modal-section" style="background:var(--bg-card); border-left:5px solid var(--info); margin-bottom:15px; box-shadow: var(--shadow-soft);">
              <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                  <h4 style="margin:0; color:var(--info); font-size:0.9rem;">üè¶ ‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏°‡πÄ‡∏á‡∏¥‡∏ô</h4>
                  <button class="btn-rounded-pill" style="background:var(--info); font-size:0.8rem; padding:8px 16px;" onclick="addSavingItemCurrent()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
              </div>
              <div id="savingsDetailList"></div>
          </div>

          <div style="margin-bottom:30px;">
              <h4 style="margin:0 0 15px 5px; font-size:0.95rem; font-weight:800;">üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</h4>
              <div id="monthDetailList"></div>
          </div>
          
          <!-- Month View Actions -->
          <div class="action-container">
              <div class="action-grid">
                <button class="btn-action-main btn-action-inc" onclick="addDetailCurrent('income')"><i class="fas fa-plus-circle"></i> ‡∏£‡∏±‡∏ö</button>
                <button class="btn-action-main btn-action-exp" onclick="addDetailCurrent('expense')"><i class="fas fa-minus-circle"></i> ‡∏à‡πà‡∏≤‡∏¢</button>
                <button class="btn-action-main btn-action-scan" onclick="window.triggerScanCurrent()"><i class="fas fa-camera"></i> ‡∏™‡πÅ‡∏Å‡∏ô</button>
              </div>
          </div>
          <div style="height:40px;"></div>
      </div>
  </div>

  <!-- Bottom Navigation -->
  <div class="bottom-nav">
      <div class="nav-item active" id="nav-home" onclick="window.switchView('home')"><i class="fas fa-home"></i><span>‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</span></div>
      <div class="nav-item" onclick="window.openChartModal('bar')"><i class="fas fa-chart-pie"></i><span>‡∏Å‡∏£‡∏≤‡∏ü</span></div>
      <div class="nav-item" onclick="window.analyzeBudgetWithAI()"><i class="fas fa-robot"></i><span>AI Coach</span></div>
      <div class="nav-item" onclick="window.openToolsModal()"><i class="fas fa-tools"></i><span>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠</span></div>
      <div class="nav-item" onclick="window.openSettingsModal()"><i class="fas fa-cog"></i><span>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</span></div>
  </div>

  <!-- Modals -->
  <div class="modal" id="chartModal">
    <div class="modal-card">
      <span class="close-btn" onclick="closeModal('chartModal')">&times;</span>
      <h3 id="modalChartTitle" style="margin-top:0; margin-bottom:20px; font-size:1.2rem;">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô</h3>
      <div style="display:flex; gap:10px; margin-bottom:25px;">
          <button class="btn-chart-pill active" id="btn-chart-bar" onclick="window.openChartModal('bar')">‡πÅ‡∏ó‡πà‡∏á</button>
          <button class="btn-chart-pill" id="btn-chart-pie" onclick="window.openChartModal('pie')">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô</button>
          <button class="btn-chart-pill" id="btn-chart-line" onclick="window.openChartModal('line')">‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°</button>
      </div>
      <div class="chart-container-wrapper" style="position:relative; height:40vh;"><canvas id="chart"></canvas></div>
    </div>
  </div>

  <div class="modal" id="toolsModal">
    <div class="modal-card">
      <span class="close-btn" onclick="closeModal('toolsModal')">&times;</span>
      <h3>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠</h3>
      <button class="btn-full" style="background:#d1fae5; color:#065f46;" onclick="exportToExcel()">‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel</button>
      <button class="btn-full" style="background:#f1f5f9; color:#475569;" onclick="exportJSON()">‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
      <hr style="margin:20px 0; opacity: 0.1;">
      <button class="btn-full" style="background:#fee2e2; color:#dc2626;" onclick="openClearModal()">‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏≠‡∏õ</button>
    </div>
  </div>

  <div class="modal" id="settingsModal">
    <div class="modal-card">
        <span class="close-btn" onclick="closeModal('settingsModal')">&times;</span>
        <h3 style="margin-top:0; margin-bottom:25px; font-size:1.2rem;"><i class="fas fa-cog"></i> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h3>
        <div class="modal-section">
            <h4>üõ∞Ô∏è ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Ñ‡∏•‡∏≤‡∏ß‡∏î‡πå</h4>
            <button id="btnLogin" class="btn-full" style="background:#fff; border:1px solid #e2e8f0; color:#444;" onclick="loginGoogle()"><i class="fab fa-google"></i> Login with Google</button>
            <button id="btnLogout" class="btn-full hidden" style="background:#fee2e2; color:#dc2626;" onclick="logout()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
        <div class="modal-section">
            <h4>üß† ‡∏£‡∏∞‡∏ö‡∏ö AI COACH</h4>
            <div style="display:flex; gap:12px; margin-bottom:12px;">
                <input id="apiKeyInput" type="password" class="modern-input" placeholder="‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™ Gemini API...">
                <button onclick="saveApiKey()" style="padding:0 22px; border-radius:50px; background:var(--primary); color:#fff; border:none; font-weight:800;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
            <a href="https://aistudio.google.com/app/apikey" target="_blank" style="font-size:0.75rem; color:var(--primary); text-decoration:none; font-weight:700;">üëâ ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏Ç‡∏≠‡∏£‡∏±‡∏ö‡∏£‡∏´‡∏±‡∏™ Gemini ‡∏ü‡∏£‡∏µ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</a>
        </div>
        <div class="modal-section">
            <h4>üåó ‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•</h4>
            <div style="display:flex; gap:12px;">
                <button onclick="window.setDisplayMode('light')" style="flex:1; padding:12px; border-radius:50px; border:1px solid #ddd; background:white; font-weight:800;"><i class="fas fa-sun"></i> ‡∏™‡∏ß‡πà‡∏≤‡∏á</button>
                <button onclick="window.setDisplayMode('night')" style="flex:1; padding:12px; border-radius:50px; border:1px solid #ddd; background:#334155; color:white; font-weight:800;"><i class="fas fa-moon"></i> ‡∏°‡∏∑‡∏î</button>
            </div>
        </div>
    </div>
  </div>

  <div class="modal" id="aiModal">
    <div class="modal-card">
      <span class="close-btn" onclick="closeAiModal()">&times;</span>
      <h3><i class="fas fa-robot"></i> ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏à‡∏≤‡∏Å AI</h3>
      <div id="aiContent" style="line-height:1.7;"></div>
    </div>
  </div>

  <div class="modal" id="clearDataModal"><div class="modal-card"><h3>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•?</h3><div style="display:flex; gap:10px;"><button class="btn-full" style="background:#fee2e2; color:#dc2626; flex:1" onclick="performClear()">‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏•‡∏¢</button><button class="btn-full" style="background:#eee; flex:1" onclick="closeModal('clearDataModal')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button></div></div></div>

  <input type="file" id="receiptInput" accept="image/*" style="display: none;">

  <!-- Firebase Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const FIREBASE_CONFIG = { apiKey: "AIzaSyDUliKbJO1YyUNjZdBvkBULaWlEaBzmcAA", authDomain: "budget1-ed2f4.firebaseapp.com", projectId: "budget1-ed2f4", storageBucket: "budget1-ed2f4.firebasestorage.app", messagingSenderId: "312969765873", appId: "1:312969765873:web:db0e163fe587149963da50" };
    const app = initializeApp(FIREBASE_CONFIG);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const appId = 'budget-app';
    let userId, useCloud = false;

    window.loginGoogle = async () => { try { await signInWithPopup(auth, new GoogleAuthProvider()); window.closeModal('settingsModal'); } catch(e) { } };
    window.logout = async () => { await signOut(auth); window.location.reload(); };

    onAuthStateChanged(auth, (user) => {
        const syncBadge = document.getElementById('syncStatus');
        const userLabel = document.getElementById('userNameLabel');
        if (user) {
            userId = user.uid; useCloud = true;
            syncBadge.innerHTML = '<i class="fas fa-wifi"></i>'; syncBadge.style.background = '#dcfce7'; syncBadge.style.color = '#166534';
            document.getElementById('btnLogin').classList.add('hidden');
            document.getElementById('btnLogout').classList.remove('hidden');
            if(user.photoURL) { document.getElementById('mainAvatar').src = user.photoURL; document.getElementById('mainAvatar').style.display = 'block'; }
            if(userLabel) userLabel.innerText = user.displayName || "‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô";
            startDataListener();
        } else { useCloud = false; syncBadge.innerHTML = '<i class="fas fa-wifi"></i>'; }
    });

    function startDataListener() {
        onSnapshot(doc(db, 'artifacts', appId, 'users', userId, 'budget_data', 'yearly'), (docSnap) => {
            if (docSnap.exists() && document.activeElement.tagName !== 'INPUT') {
                const data = docSnap.data();
                if (data.monthlyData) { window.monthlyData = data.monthlyData; window.initDataAndRender(); }
            }
        });
    }

    window.saveDataToCloud = async () => {
        if (useCloud && userId) {
            try { await setDoc(doc(db, 'artifacts', appId, 'users', userId, 'budget_data', 'yearly'), { monthlyData: window.monthlyData, lastUpdated: new Date().toISOString() }); } catch (e) {}
        }
    }
  </script>

  <!-- App Script Logic -->
  <script>
    window.myMainChartObj = null; window.savingsChartObj = null; window.monthSavingsChartObj = null;
    const extraSources = ["OT", "‡πÇ‡∏ö‡∏ô‡∏±‡∏™", "‡∏Ç‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á", "‡∏ü‡∏£‡∏µ‡πÅ‡∏•‡∏ô‡∏ã‡πå", "‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à", "‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç", "‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß", "‡∏≠‡∏∑‡πà‡∏ô‡πÜ"];
    const savingPurposes = ["‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡∏£‡∏≠‡∏á", "‡∏•‡∏á‡∏ó‡∏∏‡∏ô", "‡πÄ‡∏Å‡∏©‡∏µ‡∏¢‡∏ì", "‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß", "‡∏ö‡πâ‡∏≤‡∏ô/‡∏£‡∏ñ", "‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤", "‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û", "‡∏≠‡∏∑‡πà‡∏ô‡πÜ"];

    window.closeModal = (id) => { document.getElementById(id).classList.remove('show'); };
    window.closeAiModal = () => { document.getElementById('aiModal').classList.remove('show'); };
    window.scrollContainer = (id, offset) => { const el = document.getElementById(id); if(el) el.scrollLeft += offset; };
    function escapeHtml(text) { return text ? String(text).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#039;"}[m])) : ""; }

    window.setDisplayMode = (mode) => { localStorage.setItem('display_mode', mode); applyThemeMode(); };
    function applyThemeMode() {
        const mode = localStorage.getItem('display_mode') || 'auto';
        const isNight = mode === 'auto' ? (new Date().getHours() >= 18 || new Date().getHours() < 6) : mode === 'night';
        document.body.classList.toggle('night', isNight);
    }

    const months = ["‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå", "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°", "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô", "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°", "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô", "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°", "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô", "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°", "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô", "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"];
    window.monthlyData = JSON.parse(localStorage.getItem('yearlyBudget_v1')) || months.map(() => ({ salary: 0, extraList: [], savings: [], details: [] }));
    window.currentMonthIndex = 0;

    window.initDataAndRender = function() {
        window.monthlyData = window.monthlyData.map(m => ({ ...m, details: Array.isArray(m.details) ? m.details : [], extraList: Array.isArray(m.extraList) ? m.extraList : [], savings: Array.isArray(m.savings) ? m.savings : [] }));
        applyThemeMode();
        const storedKey = localStorage.getItem('gemini_api_key'); if(storedKey) { const el = document.getElementById('apiKeyInput'); if(el) el.value = storedKey; }
        if(document.getElementById('view-home').classList.contains('active')) window.renderHome(); else window.renderMonthDetail();
    };

    function calculateStats(m) {
        const inc = (Number(m.salary)||0) + (m.extraList||[]).reduce((s,i)=>s+(Number(i.amount)||0), 0) + (m.details||[]).filter(d=>d.type==='income').reduce((s,d)=>s+(Number(d.amount)||0), 0);
        const exp = (m.details||[]).filter(d=>d.type==='expense').reduce((s,d)=>s+(Number(d.amount)||0), 0);
        const save = (m.savings||[]).reduce((s,i)=>s+(Number(i.amount)||0), 0);
        return { inc, exp, save, bal: inc - exp, free: inc - exp - save };
    }

    let saveTimeout;
    window.saveData = () => { localStorage.setItem('yearlyBudget_v1', JSON.stringify(window.monthlyData)); clearTimeout(saveTimeout); saveTimeout = setTimeout(() => { if(window.saveDataToCloud) window.saveDataToCloud(); }, 2000); };

    window.renderHome = () => {
        const list = document.getElementById('homeMonthList');
        if(!list) return;
        let html = '', gInc = 0, gExp = 0, gSave = 0, savingsMap = {};
        const currIdx = new Date().getMonth();
        const currStats = calculateStats(window.monthlyData[currIdx]);

        window.monthlyData.forEach((m, i) => {
            const s = calculateStats(m);
            gInc += s.inc; gExp += s.exp; gSave += s.save;
            m.savings.forEach(v => { let k=v.desc||'‡∏≠‡∏≠‡∏°‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ'; savingsMap[k]=(savingsMap[k]||0)+Number(v.amount); });
            html += `<div class="month-summary-card" onclick="window.openMonth(${i})"><div class="m-left"><div class="m-icon">${i+1}</div><div class="m-info"><h4>${months[i]}</h4><span style="font-size:0.75rem; color:#888">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏à‡∏£‡∏¥‡∏á: ${s.free.toLocaleString()}</span></div></div><div class="m-right"><span class="m-bal" style="color:${s.free>=0?'var(--primary)':'var(--danger)'}">${s.free.toLocaleString()}</span></div></div>`;
        });
        list.innerHTML = html;
        const elCurrMonth = document.getElementById('currMonthName'); if(elCurrMonth) elCurrMonth.innerText = months[currIdx];
        const elBalance = document.getElementById('currentMonthBalance'); if(elBalance) elBalance.innerText = currStats.free.toLocaleString();
        const elInc = document.getElementById('dashIncome'); if(elInc) elInc.innerText = currStats.inc.toLocaleString();
        const elExp = document.getElementById('dashExpense'); if(elExp) elExp.innerText = currStats.exp.toLocaleString();
        const elSave = document.getElementById('dashSavings'); if(elSave) elSave.innerText = currStats.save.toLocaleString();
        const elGrand = document.getElementById('grandBalance'); if(elGrand) elGrand.innerText = (gInc - gExp - gSave).toLocaleString();
        renderPortfolioChart(savingsMap, 'savingsDoughnut', 'savingsLegend');
    };

    window.openMonth = (idx) => { window.currentMonthIndex = idx; window.switchView('month'); };
    window.renderMonthDetail = () => {
        const m = window.monthlyData[window.currentMonthIndex]; const s = calculateStats(m);
        const elMonthName = document.getElementById('detailMonthName'); if(elMonthName) elMonthName.innerText = months[window.currentMonthIndex];
        const elGrandBal = document.getElementById('monthGrandBalance'); if(elGrandBal) elGrandBal.innerText = s.free.toLocaleString();
        const elGrandInc = document.getElementById('monthGrandIncome'); if(elGrandInc) elGrandInc.innerText = s.inc.toLocaleString();
        const elGrandExp = document.getElementById('monthGrandExpense'); if(elGrandExp) elGrandExp.innerText = s.exp.toLocaleString();
        const elGrandSav = document.getElementById('monthGrandSavings'); if(elGrandSav) elGrandSav.innerText = s.save.toLocaleString();
        const elProg = document.getElementById('monthProgressBar'); if(elProg) elProg.style.width = Math.min((s.exp / (s.inc||1)) * 100, 100) + '%';
        const inpSal = document.getElementById('inpSalary'); if(inpSal) inpSal.value = m.salary || '';
        renderCategorizedList(m.extraList, 'extraIncomeList', 'updateExtra', 'removeExtra', 'üí∏', extraSources);
        renderCategorizedList(m.savings, 'savingsDetailList', 'updateSave', 'removeSave', 'üè¶', savingPurposes);
        const detailList = document.getElementById('monthDetailList');
        if(detailList) detailList.innerHTML = m.details.map((d, i) => `<div class="detail-row"><div class="type-badge-circle ${d.type==='income'?'badge-inc':'badge-exp'}" onclick="toggleType(${i})">${d.type==='income'?'+':'-'}</div><input class="desc-input" value="${escapeHtml(d.desc)}" oninput="updateDetail(${i},'desc',this.value)"><div style="width:1px; height:20px; background:#eee;"></div><input class="amt-input" type="number" value="${d.amount}" oninput="updateDetail(${i},'amount',this.value)"><button class="btn-del-modern" onclick="removeDetail(${i})"><i class="fas fa-times"></i></button></div>`).join('');
        const mSavMap = {}; m.savings.forEach(v => { let k=v.desc||'‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ'; mSavMap[k]=(mSavMap[k]||0)+Number(v.amount); });
        renderPortfolioChart(mSavMap, 'monthSavingsDoughnut', 'monthSavingsLegend', true);
    };

    function renderCategorizedList(arr, id, upFn, rmFn, icon, options) {
        const el = document.getElementById(id); if(!el) return;
        el.innerHTML = arr.length ? arr.map((v, i) => `<div class="detail-row"><span>${icon}</span><select class="modern-select" onchange="window.${upFn}(${i},'desc',this.value)"><option value="" disabled ${!v.desc ? 'selected' : ''}>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£...</option>${options.map(opt => `<option value="${opt}" ${v.desc===opt?'selected':''}>${opt}</option>`).join('')}</select><div style="width:1px; height:20px; background:#eee;"></div><input class="amt-input" type="number" value="${v.amount}" oninput="window.${upFn}(${i},'amount',this.value)"><button class="btn-del-modern" onclick="window.${rmFn}(${i})"><i class="fas fa-times"></i></button></div>`).join('') : '<div style="text-align:center; color:#ccc; font-size:0.8rem; padding:10px">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>';
    }

    window.updateCurrentMonthBase = (f, v) => { window.monthlyData[window.currentMonthIndex][f] = Number(v); window.saveData(); updateMonthStatsUI(); };
    window.addExtraIncomeItem = () => { window.monthlyData[window.currentMonthIndex].extraList.push({desc:'', amount:''}); window.saveData(); window.renderMonthDetail(); };
    window.updateExtra = (i, f, v) => { window.monthlyData[window.currentMonthIndex].extraList[i][f] = f==='amount'?Number(v):v; window.saveData(); updateMonthStatsUI(); };
    window.removeExtra = (i) => { window.monthlyData[window.currentMonthIndex].extraList.splice(i, 1); window.saveData(); window.renderMonthDetail(); };
    window.addSavingItemCurrent = () => { window.monthlyData[window.currentMonthIndex].savings.push({desc:'', amount:''}); window.saveData(); window.renderMonthDetail(); };
    window.updateSave = (i, f, v) => { window.monthlyData[window.currentMonthIndex].savings[i][f] = f==='amount'?Number(v):v; window.saveData(); updateMonthStatsUI(); };
    window.removeSave = (i) => { window.monthlyData[window.currentMonthIndex].savings.splice(i, 1); window.saveData(); window.renderMonthDetail(); };
    window.addDetailCurrent = (t) => { window.monthlyData[window.currentMonthIndex].details.push({type:t, desc:'', amount:''}); window.saveData(); window.renderMonthDetail(); };
    window.updateDetail = (i, f, v) => { window.monthlyData[window.currentMonthIndex].details[i][f] = f==='amount'?Number(v):v; window.saveData(); updateMonthStatsUI(); };
    window.removeDetail = (i) => { window.monthlyData[window.currentMonthIndex].details.splice(i, 1); window.saveData(); window.renderMonthDetail(); };
    window.toggleType = (i) => { let d=window.monthlyData[window.currentMonthIndex].details[i]; d.type=d.type==='income'?'expense':'income'; window.saveData(); window.renderMonthDetail(); };

    function updateMonthStatsUI() {
        const s = calculateStats(window.monthlyData[window.currentMonthIndex]);
        const elBal = document.getElementById('monthGrandBalance'); if(elBal) elBal.innerText = s.free.toLocaleString();
        const elProg = document.getElementById('monthProgressBar'); if(elProg) elProg.style.width = Math.min((s.exp / (s.inc||1)) * 100, 100) + '%';
        const elInc = document.getElementById('monthGrandIncome'); if(elInc) elInc.innerText = s.inc.toLocaleString();
        const elExp = document.getElementById('monthGrandExpense'); if(elExp) elExp.innerText = s.exp.toLocaleString();
        const elSav = document.getElementById('monthGrandSavings'); if(elSav) elSav.innerText = s.save.toLocaleString();
    }

    function renderPortfolioChart(map, canvasId, legendId, isMonth = false) {
        const canvas = document.getElementById(canvasId); if(!canvas) return;
        const entries = Object.entries(map).sort((a,b)=>b[1]-a[1]);
        const legend = document.getElementById(legendId);
        if (!entries.length) { if(legend) legend.innerHTML = '<span style="color:#aaa; font-size:0.8rem; padding:10px">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>'; return; }
        const colors = ['#11cdef','#2dce89','#5e72e4','#fb6340','#f5365c'];
        const chartKey = isMonth ? 'monthSavingsChartObj' : 'savingsChartObj';
        if(window[chartKey]) window[chartKey].destroy();
        window[chartKey] = new Chart(canvas.getContext('2d'), { type:'doughnut', data:{ labels:entries.map(e=>e[0]), datasets:[{data:entries.map(e=>e[1]), backgroundColor:colors, borderWidth:0, cutout:'70%'}] }, options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}} } });
        if(legend) legend.innerHTML = entries.map((e,i)=>`<div class="sp-item"><span><span class="sp-color" style="background:${colors[i%5]}"></span>${escapeHtml(e[0])}</span><b>${e[1].toLocaleString()}</b></div>`).join('');
    }

    window.openChartModal = (type) => {
        document.getElementById('chartModal').classList.add('show');
        document.querySelectorAll('.btn-chart-pill').forEach(b => b.classList.remove('active'));
        const btn = document.getElementById('btn-chart-' + type); if(btn) btn.classList.add('active');
        const ctx = document.getElementById('chart').getContext('2d');
        if(window.myMainChartObj) window.myMainChartObj.destroy();
        if (type === 'bar') {
            document.getElementById('modalChartTitle').innerText = "‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö-‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô";
            window.myMainChartObj = new Chart(ctx, { type: 'bar', data: { labels: months, datasets: [ { label: '‡∏£‡∏±‡∏ö', data: window.monthlyData.map(m=>calculateStats(m).inc), backgroundColor: '#2dce89' }, { label: '‡∏à‡πà‡∏≤‡∏¢', data: window.monthlyData.map(m=>calculateStats(m).exp), backgroundColor: '#f5365c' } ] }, options: { responsive: true, maintainAspectRatio: false } });
        } else if (type === 'pie') {
            document.getElementById('modalChartTitle').innerText = "‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏õ‡∏µ‡∏ô‡∏µ‡πâ";
            const expMap = {}; window.monthlyData.forEach(m => m.details.filter(d=>d.type==='expense').forEach(d => { let k=d.desc.trim()||'‡∏≠‡∏∑‡πà‡∏ô‡πÜ'; expMap[k]=(expMap[k]||0)+Number(d.amount); }));
            const ent = Object.entries(expMap).sort((a,b)=>b[1]-a[1]).slice(0, 8);
            window.myMainChartObj = new Chart(ctx, { type: 'doughnut', data: { labels: ent.map(e=>e[0]), datasets: [{ data: ent.map(e=>e[1]), backgroundColor: ['#5e72e4','#2dce89','#fb6340','#f5365c','#11cdef'] }] }, options: { responsive: true, maintainAspectRatio: false } });
        } else if (type === 'line') {
            document.getElementById('modalChartTitle').innerText = "‡∏û‡∏≠‡∏£‡πå‡∏ï‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°‡∏™‡∏∞‡∏™‡∏°";
            window.myMainChartObj = new Chart(ctx, { type: 'line', data: { labels: months, datasets: [{ label: '‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°', data: window.monthlyData.map(m=>calculateStats(m).save), borderColor: '#11cdef', fill: true, backgroundColor: 'rgba(17, 205, 239, 0.15)', tension: 0.35 }] }, options: { responsive: true, maintainAspectRatio: false } });
        }
    };

    window.switchView = (v) => {
        document.querySelectorAll('.view-section').forEach(e=>e.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));
        if(v==='home') { 
            document.getElementById('view-home').classList.add('active'); 
            document.getElementById('nav-home').classList.add('active');
            window.renderHome(); 
        } else { 
            document.getElementById('view-month').classList.add('active'); 
            window.renderMonthDetail();
        }
        window.scrollTo({top:0, behavior:'smooth'});
    };

    // --- Gemini 2.5 Flash API Implementation ---
    window.analyzeBudgetWithAI = async () => {
        const apiKey = ""; // Environment provided
        const userKey = localStorage.getItem('gemini_api_key');
        const finalKey = userKey || apiKey;
        
        if(!finalKey) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà API Key ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤");
        
        const loader = document.getElementById('loadingOverlay');
        const loaderText = document.getElementById('aiLoaderText');
        loaderText.innerText = "AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...";
        loader.style.display='flex';
        
        try {
            const summary = window.monthlyData.map((m,i)=>`${months[i]}: In=${calculateStats(m).inc}, Out=${calculateStats(m).exp}, Save=${calculateStats(m).save}`).join('\n');
            
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${finalKey}`, { 
                method:'POST', 
                headers:{'Content-Type':'application/json'}, 
                body:JSON.stringify({
                    contents:[{
                        parts:[{text:`Analyze this annual budget data in Thai Baht and provide 3 actionable, encouraging financial tips in Thai markdown. Data summary:\n${summary}`}]
                    }]
                }) 
            });

            if (!res.ok) throw new Error("API Connection Failed");

            const d = await res.json();
            const text = d.candidates?.[0]?.content?.parts?.[0]?.text;
            
            if (!text) throw new Error("AI returned empty data");

            document.getElementById('aiContent').innerHTML = marked.parse(text);
            document.getElementById('aiModal').classList.add('show');
        } catch(e) { 
            alert("AI Error: ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö AI ‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏´‡∏±‡∏™ API Key ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì");
        } finally { 
            loader.style.display='none'; 
        }
    };

    window.triggerScanCurrent = () => { document.getElementById('receiptInput').click(); };

    window.onload = function() {
        const input = document.getElementById('receiptInput');
        if(input) {
            input.addEventListener('change', async function(e) {
                const apiKey = "";
                const userKey = localStorage.getItem('gemini_api_key');
                const finalKey = userKey || apiKey;

                if(!finalKey || !this.files[0]) return;
                
                const loader = document.getElementById('loadingOverlay');
                const loaderText = document.getElementById('aiLoaderText');
                loaderText.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏•‡∏¥‡∏õ...";
                loader.style.display='flex';

                const reader = new FileReader();
                reader.onload = async (ev) => {
                    try {
                        const b64 = ev.target.result.split(',')[1];
                        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${finalKey}`, { 
                            method:'POST', 
                            headers:{'Content-Type':'application/json'}, 
                            body:JSON.stringify({
                                contents:[{
                                    role:"user", 
                                    parts:[
                                        {text:"Analyze this receipt and extract ONLY a JSON object: { \"description\": \"string\", \"amount\": number, \"type\": \"expense\" }. Description should be in Thai."}, 
                                        {inlineData:{mimeType:"image/jpeg",data:b64}}
                                    ]
                                }]
                            }) 
                        });

                        if (!res.ok) throw new Error("Scan API Failed");

                        const d = await res.json(); 
                        const rawText = d.candidates?.[0]?.content?.parts?.[0]?.text;
                        const jsonStr = rawText.replace(/```json/g,'').replace(/```/g,'').trim();
                        const json = JSON.parse(jsonStr);
                        
                        if(json.amount) { 
                            window.monthlyData[window.currentMonthIndex].details.push({type:json.type||'expense', desc:json.description, amount:json.amount}); 
                            window.saveData(); window.renderMonthDetail(); 
                        }
                    } catch(err) { 
                        alert("‡∏™‡πÅ‡∏Å‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: AI ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ");
                    } finally { 
                        loader.style.display='none'; input.value=''; 
                    }
                }; reader.readAsDataURL(this.files[0]);
            });
        }
        window.initDataAndRender();
    };

    window.saveApiKey = () => { localStorage.setItem('gemini_api_key', document.getElementById('apiKeyInput').value); alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!"); };
    window.exportJSON = () => { const a=document.createElement('a'); a.href="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(window.monthlyData)); a.download="budget_backup.json"; a.click(); };
    window.exportToExcel = () => {
       let csv = "\uFEFF‡πÄ‡∏î‡∏∑‡∏≠‡∏ô,‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó,‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£,‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô\n";
       window.monthlyData.forEach((m, idx) => {
         const mm = months[idx];
         if(m.salary) csv += `${mm},‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏à‡∏≥,‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô,${m.salary}\n`;
         m.extraList.forEach(e => csv += `${mm},‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏û‡∏¥‡πÄ‡∏®‡∏©,${e.desc},${e.amount}\n`);
         m.savings.forEach(s => csv += `${mm},‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°,${s.desc},${s.amount}\n`);
         m.details.forEach(d => csv += `${mm},${d.type==='income'?'‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö':'‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢'},${d.desc},${d.amount}\n`);
       });
       const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'})); a.download="Budget_Summary.csv"; a.click();
    };
    window.openClearModal = () => document.getElementById('clearDataModal').classList.add('show');
    window.performClear = () => { if(confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')) { window.monthlyData = months.map(() => ({ salary: 0, extraList: [], savings: [], details: [] })); window.saveData(); window.initDataAndRender(); window.closeModal('clearDataModal'); window.closeModal('toolsModal'); } };
    window.openToolsModal = () => document.getElementById('toolsModal').classList.add('show');
    window.openSettingsModal = () => document.getElementById('settingsModal').classList.add('show');
  </script>
</body>
</html>
