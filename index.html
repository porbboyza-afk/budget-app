<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üì± Budget Mobile</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
*{box-sizing:border-box;}
body{
  margin:0;
  font-family:system-ui, sans-serif;
  background:linear-gradient(180deg,#0f172a,#020617);
  color:#fff;
  padding:14px;
}
.header{
  background:#1e293b;
  padding:12px 14px;
  border-radius:14px;
  display:flex;
  align-items:center;
  justify-content:space-between;
}
.badge{
  background:#22c55e;
  padding:4px 10px;
  border-radius:999px;
  font-size:12px;
}
.summary{
  background:#fff;
  color:#000;
  margin-top:12px;
  padding:12px;
  border-radius:14px;
  display:flex;
  justify-content:space-around;
  text-align:center;
}
.summary div{font-weight:600;}
.buttons{
  margin:12px 0;
  display:flex;
  gap:10px;
}
button{
  flex:1;
  border:none;
  padding:10px;
  border-radius:999px;
  font-weight:600;
  cursor:pointer;
}
.btn-graph{background:#f59e0b;color:#000;}
.btn-backup{background:#22c55e;}
.btn-import{background:#3b82f6;}

.month{
  background:#f1f5f9;
  color:#000;
  margin-bottom:10px;
  border-radius:12px;
  padding:10px;
}
.month-header{
  display:flex;
  justify-content:space-between;
  font-weight:700;
  cursor:pointer;
}
.details{
  margin-top:8px;
  display:none;
}
input,select{
  width:100%;
  padding:6px;
  margin:4px 0;
}
.row{
  display:grid;
  grid-template-columns:1fr 80px 40px;
  gap:6px;
}
.add-btn{
  background:#22c55e;
  color:#000;
  margin-top:6px;
}
.delete-btn{
  background:#ef4444;
  color:#fff;
}
canvas{
  background:#fff;
  border-radius:12px;
  margin-top:12px;
}
</style>
</head>
<body>

<div class="header">
  <div>üìä Budget Mobile</div>
  <div class="badge">Online</div>
</div>

<div class="summary">
  <div>‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö<br><span id="sumIncome">0</span></div>
  <div>‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢<br><span id="sumExpense">0</span></div>
  <div>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠<br><span id="sumBalance">0</span></div>
</div>

<div class="buttons">
  <button class="btn-graph" onclick="toggleChart()">‡∏Å‡∏£‡∏≤‡∏ü</button>
  <button class="btn-backup" onclick="backup()">Backup</button>
  <button class="btn-import" onclick="importData()">Import</button>
</div>

<div id="months"></div>

<canvas id="chart" height="200" style="display:none"></canvas>

<script>
const monthsName=["‡∏°.‡∏Ñ.","‡∏Å.‡∏û.","‡∏°‡∏µ.‡∏Ñ.","‡πÄ‡∏°.‡∏¢.","‡∏û.‡∏Ñ.","‡∏°‡∏¥.‡∏¢.","‡∏Å.‡∏Ñ.","‡∏™.‡∏Ñ.","‡∏Å.‡∏¢.","‡∏ï.‡∏Ñ.","‡∏û.‡∏¢.","‡∏ò.‡∏Ñ."];

// ===== SAFE LOAD =====
let data;
try{
  const raw = JSON.parse(localStorage.getItem("budgetData"));
  if(Array.isArray(raw)) data = raw;
  else throw "bad";
}catch{
  data = monthsName.map(()=>({items:[]}));
  localStorage.removeItem("budgetData");
}

function save(){
  localStorage.setItem("budgetData",JSON.stringify(data));
}

// ===== RENDER =====
function render(){
  const root=document.getElementById("months");
  root.innerHTML="";
  let totalIncome=0,totalExpense=0;

  data.forEach((m,i)=>{
    let income=0,expense=0;
    m.items.forEach(it=>{
      if(it.type==="income") income+=it.amount;
      else expense+=it.amount;
    });

    totalIncome+=income;
    totalExpense+=expense;

    const div=document.createElement("div");
    div.className="month";
    div.innerHTML=`
      <div class="month-header" onclick="toggle(${i})">
        <div>${monthsName[i]}</div>
        <div>${income-expense}</div>
      </div>
      <div class="details" id="detail-${i}">
        <div id="list-${i}"></div>
        <button class="add-btn" onclick="addItem(${i})">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
      </div>
    `;
    root.appendChild(div);

    const list=document.getElementById(`list-${i}`);
    m.items.forEach((it,idx)=>{
      const row=document.createElement("div");
      row.className="row";
      row.innerHTML=`
        <select onchange="updateItem(${i},${idx},'type',this.value)">
          <option value="income" ${it.type==="income"?"selected":""}>‡∏£‡∏±‡∏ö</option>
          <option value="expense" ${it.type==="expense"?"selected":""}>‡∏à‡πà‡∏≤‡∏¢</option>
        </select>
        <input type="number" value="${it.amount}" 
          onchange="updateItem(${i},${idx},'amount',this.value)">
        <button class="delete-btn" onclick="removeItem(${i},${idx})">‚úï</button>
      `;
      list.appendChild(row);
    });
  });

  document.getElementById("sumIncome").innerText=totalIncome;
  document.getElementById("sumExpense").innerText=totalExpense;
  document.getElementById("sumBalance").innerText=totalIncome-totalExpense;
  drawChart();
  save();
}

// ===== ACTIONS =====
function toggle(i){
  const el=document.getElementById(`detail-${i}`);
  el.style.display=el.style.display==="block"?"none":"block";
}
function addItem(i){
  data[i].items.push({type:"income",amount:0});
  render();
}
function removeItem(i,idx){
  data[i].items.splice(idx,1);
  render();
}
function updateItem(i,idx,key,val){
  data[i].items[idx][key]= key==="amount"?Number(val):val;
  render();
}

// ===== BACKUP =====
function backup(){
  const blob=new Blob([JSON.stringify(data)],{type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="budget-backup.json";
  a.click();
}

// ===== IMPORT =====
function importData(){
  const input=document.createElement("input");
  input.type="file";
  input.accept="application/json";
  input.onchange=e=>{
    const file=e.target.files[0];
    const reader=new FileReader();
    reader.onload=()=>{
      try{
        const json=JSON.parse(reader.result);
        if(Array.isArray(json)){
          data=json;
          render();
        }else alert("‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
      }catch{
        alert("‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ");
      }
    };
    reader.readAsText(file);
  };
  input.click();
}

// ===== CHART =====
let chart=null;
function toggleChart(){
  const c=document.getElementById("chart");
  c.style.display=c.style.display==="none"?"block":"none";
  drawChart();
}
function drawChart(){
  const ctx=document.getElementById("chart");
  if(ctx.style.display==="none") return;

  if(chart) chart.destroy();
  const income=[],expense=[];
  data.forEach(m=>{
    let inc=0,exp=0;
    m.items.forEach(it=>{
      if(it.type==="income") inc+=it.amount;
      else exp+=it.amount;
    });
    income.push(inc);
    expense.push(exp);
  });

  chart=new Chart(ctx,{
    type:"bar",
    data:{
      labels:monthsName,
      datasets:[
        {label:"‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö",data:income},
        {label:"‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢",data:expense}
      ]
    }
  });
}

render();
</script>
</body>
</html>
