<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Budget Mobile App</title>

<!-- PWA -->
<link rel="manifest" href="data:application/manifest+json,{
  &quot;name&quot;:&quot;Budget Mobile&quot;,
  &quot;short_name&quot;:&quot;Budget&quot;,
  &quot;start_url&quot;:&quot;.&quot;,
  &quot;display&quot;:&quot;standalone&quot;,
  &quot;background_color&quot;:&quot;#4f7cff%22,
  &quot;theme_color&quot;:&quot;#4f7cff&quot;
}">
<meta name="theme-color" content="#4f7cff">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --green:#2ecc71;
  --red:#e74c3c;
  --blue:#4f7cff;
}

body{
  margin:0;
  font-family:system-ui,-apple-system,sans-serif;
  background:#20242d;
  color:#111;
  padding:14px;
}

.header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-bottom:12px;
}

.title{
  display:flex;
  gap:8px;
  align-items:center;
  font-weight:700;
  color:#fff;
  font-size:20px;
}

.status{
  background:#2ecc71;
  color:white;
  padding:4px 10px;
  border-radius:999px;
  font-size:12px;
}

.card{
  background:white;
  border-radius:16px;
  padding:14px;
  margin-bottom:12px;
}

.summary{
  display:flex;
  justify-content:space-between;
  font-weight:600;
}

.green{ color:var(--green); }
.red{ color:var(--red); }

.toolbar{
  display:flex;
  gap:10px;
  margin:12px 0;
}

.btn{
  flex:1;
  border:none;
  border-radius:999px;
  padding:10px;
  color:white;
  font-weight:600;
}

.btn-orange{ background:#f39c12; }
.btn-green{ background:#2ecc71; }
.btn-blue{ background:#4f7cff; }

.month{
  background:#f3f6fb;
  border-radius:14px;
  padding:12px;
  margin-bottom:10px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  cursor:pointer;
}

.detail{
  display:none;
  background:white;
  border-radius:14px;
  padding:12px;
  margin-bottom:10px;
}

input,select{
  padding:6px;
  border-radius:8px;
  border:1px solid #ddd;
}

.row{
  display:flex;
  gap:6px;
  margin-bottom:6px;
}

.row input{ flex:1; }

.small-btn{
  border:none;
  border-radius:8px;
  padding:6px 10px;
  color:white;
}

.add-income{ background:var(--green); }
.add-expense{ background:var(--red); }

/* ===== Modal ===== */
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:999;
}

.modal.show{ display:flex; }

.modal-box{
  background:white;
  width:90%;
  max-width:420px;
  border-radius:16px;
  padding:16px;
}

.close-btn{
  text-align:right;
  font-weight:bold;
  cursor:pointer;
}
</style>
</head>
<body>

<div class="header">
  <div class="title">üìä Budget Mobile</div>
  <div class="status">‚óè Online</div>
</div>

<div class="card">
  <div class="summary">
    <div>‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö: <span id="totalIncome" class="green">0</span></div>
    <div>‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢: <span id="totalExpense" class="red">0</span></div>
    <div>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: <span id="totalBalance">0</span></div>
  </div>
</div>

<div class="toolbar">
  <button class="btn btn-orange" onclick="openChart()">‡∏Å‡∏£‡∏≤‡∏ü</button>
  <button class="btn btn-green" onclick="backup()">Backup</button>
  <button class="btn btn-blue" onclick="importData()">Import</button>
</div>

<div id="months"></div>

<!-- Modal -->
<div class="modal" id="chartModal">
  <div class="modal-box">
    <div class="close-btn" onclick="closeChart()">‚úñ ‡∏õ‡∏¥‡∏î</div>
    <canvas id="chart" height="260"></canvas>
  </div>
</div>

<script>
/* ===================== DATA ===================== */
const months = ["‡∏°.‡∏Ñ.","‡∏Å.‡∏û.","‡∏°‡∏µ.‡∏Ñ.","‡πÄ‡∏°.‡∏¢.","‡∏û.‡∏Ñ.","‡∏°‡∏¥.‡∏¢.","‡∏Å.‡∏Ñ.","‡∏™.‡∏Ñ.","‡∏Å.‡∏¢.","‡∏ï.‡∏Ñ.","‡∏û.‡∏¢.","‡∏ò.‡∏Ñ."];

let data = JSON.parse(localStorage.getItem("budget-data")) ||
  months.map(()=>({salary:0, extra:0, items:[]}));

let openState = {};
let chart = null;

const container = document.getElementById("months");

function render(){
  container.innerHTML = "";

  data.forEach((m,i)=>{
    const income = calcIncome(m);
    const expense = calcExpense(m);
    const balance = income-expense;

    const month = document.createElement("div");
    month.className="month";
    month.innerHTML = `<b>${months[i]}</b><span class="green">${balance.toLocaleString()}</span>`;
    month.onclick = ()=>toggleDetail(i);

    const detail = document.createElement("div");
    detail.className="detail";
    detail.id="detail-"+i;

    detail.innerHTML = `
      <div class="row">
        <input type="number" placeholder="‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô" value="${m.salary}" oninput="updateBase(${i},'salary',this.value)">
        <input type="number" placeholder="‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏û‡∏¥‡πÄ‡∏®‡∏©" value="${m.extra}" oninput="updateBase(${i},'extra',this.value)">
      </div>
      <div id="items-${i}"></div>
      <div class="row">
        <button class="small-btn add-income" onclick="addItem(${i},'income')">+ ‡∏£‡∏±‡∏ö</button>
        <button class="small-btn add-expense" onclick="addItem(${i},'expense')">- ‡∏à‡πà‡∏≤‡∏¢</button>
      </div>
    `;

    container.appendChild(month);
    container.appendChild(detail);
    renderItems(i);

    if(openState[i]) detail.style.display="block";
  });

  calcTotal();
}

function renderItems(i){
  const box = document.getElementById("items-"+i);
  if(!box) return;

  box.innerHTML="";
  data[i].items.forEach((it,idx)=>{
    const row = document.createElement("div");
    row.className="row";
    row.innerHTML=`
      <select onchange="updateItem(${i},${idx},'type',this.value)">
        <option value="income" ${it.type==="income"?"selected":""}>‡∏£‡∏±‡∏ö</option>
        <option value="expense" ${it.type==="expense"?"selected":""}>‡∏à‡πà‡∏≤‡∏¢</option>
      </select>
      <input placeholder="‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£" value="${it.desc}" oninput="updateItem(${i},${idx},'desc',this.value)">
      <input type="number" value="${it.amount}" oninput="updateItem(${i},${idx},'amount',this.value)">
      <button onclick="removeItem(${i},${idx})">‚ùå</button>
    `;
    box.appendChild(row);
  });
}

function toggleDetail(i){
  const el = document.getElementById("detail-"+i);
  const open = el.style.display==="block";
  el.style.display = open ? "none" : "block";
  openState[i] = !open;
}

function calcIncome(m){
  return m.salary + m.extra + m.items.filter(x=>x.type==="income").reduce((s,a)=>s+a.amount,0);
}

function calcExpense(m){
  return m.items.filter(x=>x.type==="expense").reduce((s,a)=>s+a.amount,0);
}

function updateBase(i,key,val){
  data[i][key]=Number(val)||0;
  save();
}

function addItem(i,type){
  data[i].items.push({type,desc:"",amount:0});
  save();
}

function updateItem(i,idx,key,val){
  data[i].items[idx][key] = key==="amount" ? Number(val)||0 : val;
  save(false);
}

function removeItem(i,idx){
  data[i].items.splice(idx,1);
  save();
}

function calcTotal(){
  let inc=0, exp=0;
  data.forEach(m=>{
    inc += calcIncome(m);
    exp += calcExpense(m);
  });
  document.getElementById("totalIncome").innerText = inc.toLocaleString();
  document.getElementById("totalExpense").innerText = exp.toLocaleString();
  document.getElementById("totalBalance").innerText = (inc-exp).toLocaleString();
}

function save(reRender=true){
  localStorage.setItem("budget-data", JSON.stringify(data));
  if(reRender) render();
  else calcTotal();
}

/* ===================== CHART ===================== */

function openChart(){
  const modal = document.getElementById("chartModal");
  modal.classList.add("show");

  const incomes = data.map(m=>calcIncome(m));
  const expenses = data.map(m=>calcExpense(m));

  const ctx = document.getElementById("chart");

  if(chart) chart.destroy();

  chart = new Chart(ctx,{
    type:"scatter",
    data:{
      datasets:[{
        label:"‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö vs ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢",
        data: incomes.map((inc,i)=>({
          x: expenses[i],
          y: inc,
          label: months[i]
        })),
        backgroundColor:"#4f7cff"
      }]
    },
    options:{
      scales:{
        x:{ title:{display:true,text:"‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ (‡∏ö‡∏≤‡∏ó)"} },
        y:{ title:{display:true,text:"‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö (‡∏ö‡∏≤‡∏ó)"} }
      },
      plugins:{
        tooltip:{
          callbacks:{
            label:(ctx)=>`${ctx.raw.label} | ‡∏£‡∏±‡∏ö ${ctx.raw.y.toLocaleString()} | ‡∏à‡πà‡∏≤‡∏¢ ${ctx.raw.x.toLocaleString()}`
          }
        }
      }
    }
  });
}

function closeChart(){
  document.getElementById("chartModal").classList.remove("show");
}

function backup(){ alert("Backup ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤"); }
function importData(){ alert("Import ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤"); }

render();
</script>
</body>
</html>
