<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>การเงินของฉัน</title>
  
  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&family=Sarabun:wght@300;400;500;600&display=swap" rel="stylesheet">
  
  <style>
    :root {
      /* Theme Colors */
      --primary: #5e72e4;
      --primary-soft: #eaecfb;
      --success: #2dce89;
      --success-soft: #e0fbf4;
      --danger: #f5365c;
      --danger-soft: #fee6ea;
      --warning: #fb6340;
      --info: #11cdef;
      --info-soft: #e0f7fa;
      --text-main: #32325d;
      --text-muted: #8898aa;
      --bg-glass: rgba(255, 255, 255, 0.85);
      --bg-glass-strong: rgba(255, 255, 255, 0.98);
      --radius: 16px;
      --radius-sm: 8px;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
      font-family: 'Prompt', 'Sarabun', sans-serif;
      margin: 0; padding: 20px 15px;
      min-height: 100vh;
      color: var(--text-main);
      background: #f8f9fe;
      padding-bottom: 100px;
    }

    /* Container */
    .main-container {
        max-width: 600px; 
        margin: 0 auto;
        width: 100%;
    }

    /* Background Animation */
    .bg-layer { position: fixed; inset: 0; z-index: -2; overflow: hidden; }
    .bg {
      position: absolute; inset: 0;
      background-size: cover; background-position: center;
      filter: blur(8px); transform: scale(1.1);
      transition: opacity 2.5s ease; opacity: 0;
    }
    .bg.active { opacity: 1; }
    .bg-overlay { 
        position: fixed; inset: 0; z-index: -1; 
        transition: background 1s; background: rgba(248, 249, 254, 0.75);
    }
    .night .bg-overlay { background: rgba(15, 23, 42, 0.9); }
    .night { 
        --text-main: #e2e8f0; --text-muted: #94a3b8;
        --bg-glass: rgba(30, 41, 59, 0.85); --bg-glass-strong: rgba(30, 41, 59, 0.98);
        --primary-soft: rgba(94, 114, 228, 0.15); --success-soft: rgba(45, 206, 137, 0.15);
        --danger-soft: rgba(245, 54, 92, 0.15); --info-soft: rgba(17, 205, 239, 0.15);
    }

    /* Dashboard */
    .dashboard {
      background: var(--bg-glass-strong);
      border-radius: var(--radius); padding: 24px 20px;
      box-shadow: 0 7px 14px rgba(50, 50, 93, 0.1);
      margin-bottom: 25px; backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255,255,255,0.4); position: relative; overflow: hidden;
    }
    .dashboard::before {
        content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px;
        background: linear-gradient(90deg, var(--primary), var(--success));
    }
    
    .dash-header {
        display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;
    }
    
    /* Menu Button */
    .menu-trigger {
        font-size: 1.4rem; cursor: pointer; color: var(--text-main); padding: 5px;
        transition: transform 0.2s;
    }
    .menu-trigger:active { transform: scale(0.9); }

    .user-profile-header {
        display: flex; align-items: center; gap: 12px;
    }
    .user-info div { line-height: 1.2; }
    
    .sync-status {
        font-size: 0.75rem; padding: 4px 10px; border-radius: 20px;
        background: #e2e8f0; color: #64748b; font-weight: 500; display: none;
        align-items: center; gap: 5px;
    }
    .sync-status.show { display: flex; }
    .sync-status.online { background: #dcfce7; color: #166534; }
    .sync-status.offline { background: #fee2e2; color: #991b1b; }
    
    .balance-amount { 
        font-size: 2.5rem; font-weight: 700; color: var(--text-main); letter-spacing: -1px; line-height: 1; text-align: center;
    }
    .balance-amount.positive { color: var(--primary); }
    .balance-label { text-align: center; font-size: 0.9rem; color: var(--text-muted); margin-bottom: 5px; }

    .stats-row { 
        display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;
        background: rgba(0,0,0,0.03); padding: 15px; border-radius: var(--radius-sm); margin-top: 20px;
    }
    .stat-item { text-align: center; }
    .stat-label { font-size: 0.75rem; color: var(--text-muted); display: block; margin-bottom: 4px; white-space: nowrap; }
    .stat-val { font-size: 1rem; font-weight: 600; }
    .val-inc { color: var(--success); }
    .val-exp { color: var(--danger); }
    .val-save { color: var(--info); }

    /* Top Expenses */
    .top-expenses-widget { margin-top: 20px; padding-top: 15px; border-top: 1px dashed rgba(0,0,0,0.1); }
    .top-pill {
        display: inline-flex; align-items: center; gap: 6px;
        background: var(--danger-soft); padding: 4px 10px; border-radius: 20px;
        font-size: 0.75rem; color: var(--danger); margin-right: 5px; margin-bottom: 5px; font-weight: 500;
    }

    /* Toolbar */
    .toolbar-container {
        position: sticky; top: 10px; z-index: 100; margin-bottom: 20px;
        display: flex; gap: 10px; overflow-x: auto; padding: 5px 2px;
        scrollbar-width: none;
    }
    .toolbar-container::-webkit-scrollbar { display: none; }

    .btn-tool {
        flex: none; padding: 10px 16px; border-radius: 30px; border: none;
        font-size: 0.85rem; font-weight: 500; cursor: pointer; color: white;
        display: flex; align-items: center; gap: 6px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        transition: transform 0.2s;
    }
    .btn-tool:active { transform: translateY(1px); }
    .btn-tool.ai { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .btn-tool.graph { background: #fb6340; }
    .btn-tool.savings { background: #11cdef; }
    .btn-tool.excel { background: #2dce89; }
    /* Backup Removed from here */
    .btn-tool.clear { background: #f5365c; }
    
    /* Google Login Button */
    .btn-tool.google { 
        background: white; color: #444; border: 1px solid #ddd;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
    }
    .btn-tool.google:hover { background: #f8f9fa; }
    .btn-tool.logout { background: #e2e8f0; color: #444; }

    /* Cards */
    .month-card {
        background: var(--bg-glass); border-radius: var(--radius); margin-bottom: 16px;
        box-shadow: 0 4px 6px rgba(50, 50, 93, 0.11); transition: transform 0.2s;
        border: 1px solid rgba(255,255,255,0.5); overflow: hidden;
    }
    .month-card.open {
        background: var(--bg-glass-strong); transform: scale(1.01); z-index: 10; border-color: var(--primary);
    }
    .card-header { padding: 18px 20px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
    .m-title { font-weight: 600; display: flex; align-items: center; gap: 10px; color: var(--text-main); }
    .m-icon-box { width: 36px; height: 36px; background: white; border-radius: 10px; display: flex; align-items: center; justify-content: center; color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .night .m-icon-box { background: #334155; color: white; }
    
    .card-body { display: none; padding: 20px; border-top: 1px solid rgba(0,0,0,0.05); background: rgba(255,255,255,0.3); }
    .month-card.open .card-body { display: block; animation: fadeIn 0.3s; }
    @keyframes fadeIn { from { opacity:0; transform:translateY(-5px); } to { opacity:1; transform:translateY(0); } }

    /* Inputs */
    .input-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
    .modern-input {
        width: 100%; padding: 12px; border-radius: var(--radius-sm); border: 1px solid #e9ecef;
        background: #fff; font-size: 0.95rem; color: var(--text-main); font-family: 'Sarabun';
    }
    .night .modern-input { background: #1e293b; border-color: #334155; color: white; }
    .modern-input-group label { font-size: 0.75rem; color: var(--text-muted); margin-bottom: 5px; display: block; }

    /* Savings & Budget */
    .savings-section { background: var(--info-soft); border: 1px dashed var(--info); border-radius: var(--radius-sm); padding: 15px; margin-bottom: 20px; }
    .night .savings-section { background: rgba(17, 205, 239, 0.15); border-color: rgba(17, 205, 239, 0.4); }
    
    .budget-bar-container { background: rgba(0,0,0,0.03); border-radius: var(--radius-sm); padding: 10px; margin-bottom: 20px; }
    .progress-track { width: 100%; height: 6px; background: #e9ecef; border-radius: 10px; margin-top: 5px; overflow: hidden; }
    .progress-fill { height: 100%; transition: width 0.5s; }

    /* Details List */
    .detail-row {
        display: flex; align-items: center; gap: 8px; margin-bottom: 10px;
        background: white; padding: 8px; border-radius: var(--radius-sm);
        box-shadow: 0 1px 3px rgba(0,0,0,0.05); flex-wrap: nowrap;
    }
    .night .detail-row { background: #334155; }
    
    .type-select { width: 70px; flex-shrink: 0; border: none; background: transparent; font-weight: 600; cursor: pointer; }
    .desc-input { flex: 1; min-width: 0; border: none; background: transparent; color: var(--text-main); }
    .amt-input { width: 70px; flex-shrink: 0; border: none; background: transparent; text-align: right; font-weight: 600; color: var(--text-main); }
    .btn-del { width: 28px; height: 28px; flex-shrink: 0; border-radius: 50%; border: none; background: var(--danger-soft); color: var(--danger); cursor: pointer; display: flex; align-items: center; justify-content: center; }

    /* Actions */
    .action-row { display: flex; gap: 10px; margin-top: 15px; }
    .action-btn { flex: 1; padding: 12px; border-radius: var(--radius-sm); border: none; font-weight: 600; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px; }
    .btn-add-inc { background: #2dce89; }
    .btn-add-exp { background: #f5365c; }
    
    .scan-btn { width: 100%; padding: 12px; border: 2px solid var(--primary); background: white; color: var(--primary); font-weight: 700; border-radius: var(--radius-sm); margin-top: 15px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }

    /* Desktop Responsive */
    @media (min-width: 1024px) {
        .main-container { max-width: 1200px; }
        #cardsContainer { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; align-items: start; }
        .month-card { margin-bottom: 0; height: fit-content; }
        .month-card.open { grid-column: 1 / -1; transform: scale(1.02); box-shadow: 0 15px 35px rgba(50, 50, 93, 0.1); }
        .toolbar-container { justify-content: center; }
    }
    @media (min-width: 768px) and (max-width: 1023px) {
        .main-container { max-width: 90%; }
        #cardsContainer { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; align-items: start; }
        .month-card.open { grid-column: 1 / -1; }
    }

    /* Modal */
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 1000; align-items: center; justify-content: center; padding: 20px; }
    .modal.show { display: flex; animation: fadeIn 0.2s; }
    .modal-card { background: white; width: 100%; max-width: 700px; border-radius: 20px; padding: 20px; max-height: 90vh; display: flex; flex-direction: column; position: relative; }
    .night .modal-card { background: #1e293b; color: white; }
    .chart-wrapper { position: relative; flex: 1; min-height: 300px; width: 100%; }
    .close-btn { position: absolute; top: 15px; right: 20px; font-size: 1.5rem; cursor: pointer; color: #888; z-index: 10; }
    
    .loading { position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 2000; display: none; align-items: center; justify-content: center; flex-direction: column; }
    .night .loading { background: rgba(15,23,42,0.95); }
    .spinner { width: 40px; height: 40px; border: 4px solid var(--primary); border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    /* Sidebar & Overlay */
    .menu-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5); z-index: 2999;
        display: none; opacity: 0; transition: opacity 0.3s;
        backdrop-filter: blur(2px);
    }
    .menu-overlay.active { display: block; opacity: 1; }

    .sidebar {
        position: fixed; top: 0; left: 0; height: 100%; width: 280px;
        background: white; z-index: 3000;
        transform: translateX(-100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 2px 0 15px rgba(0,0,0,0.1);
        padding: 25px; display: flex; flex-direction: column;
    }
    .sidebar.active { transform: translateX(0); }
    .night .sidebar { background: #1e293b; color: white; }

    .sidebar-header {
        display: flex; justify-content: space-between; align-items: center;
        margin-bottom: 30px; border-bottom: 1px solid rgba(0,0,0,0.05); padding-bottom: 15px;
    }
    .sidebar-title { font-size: 1.2rem; font-weight: 700; color: var(--primary); display: flex; align-items: center; gap: 10px; }
    
    .sidebar-user {
        text-align: center; margin-bottom: 30px;
    }
    .sidebar-avatar {
        width: 80px; height: 80px; border-radius: 50%; object-fit: cover;
        border: 3px solid var(--primary-soft); margin-bottom: 10px;
        background: #eee;
    }
    
    .btn-sidebar {
        width: 100%; padding: 12px; border-radius: 12px; border: none;
        font-size: 1rem; font-weight: 500; cursor: pointer;
        display: flex; align-items: center; justify-content: center; gap: 10px;
        margin-bottom: 10px; transition: background 0.2s;
    }
    .btn-google { background: white; color: #444; border: 1px solid #ddd; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .btn-google:hover { background: #f8f9fa; }
    .btn-logout { background: #fee2e2; color: #dc2626; }
    .btn-logout:hover { background: #fecaca; }
  </style>
</head>
<body id="mainBody">

  <div class="bg-layer">
    <div class="bg active" id="bg1"></div>
    <div class="bg" id="bg2"></div>
  </div>
  <div class="bg-overlay day" id="overlay"></div>

  <!-- Sidebar & Overlay -->
  <div class="menu-overlay" id="menuOverlay" onclick="toggleMenu()"></div>
  <div class="sidebar" id="sideMenu">
      <div class="sidebar-header">
          <div class="sidebar-title"><i class="fas fa-bars"></i> เมนูหลัก</div>
          <i class="fas fa-times" onclick="toggleMenu()" style="cursor:pointer; font-size:1.2rem; color:var(--text-muted);"></i>
      </div>
      
      <div class="sidebar-content">
          <!-- User Info (Hidden by default) -->
          <div id="sidebarUserInfo" class="sidebar-user" style="display:none;">
               <img id="sidebarAvatar" src="" class="sidebar-avatar" alt="Avatar">
               <div id="sidebarName" style="font-weight:700; font-size:1.1rem; margin-bottom:5px;">User</div>
               <div style="font-size:0.8rem; color:var(--text-muted);">Logged in via Google</div>
          </div>

          <!-- Auth Buttons -->
          <button id="sidebarBtnLogin" class="btn-sidebar btn-google" onclick="loginGoogle()">
              <i class="fab fa-google"></i> เข้าสู่ระบบด้วย Google
          </button>
          
          <button id="sidebarBtnLogout" class="btn-sidebar btn-logout" onclick="logout()" style="display:none;">
              <i class="fas fa-sign-out-alt"></i> ออกจากระบบ
          </button>

          <!-- Data Management (New) -->
          <div style="margin-top: 20px; border-top: 1px solid rgba(0,0,0,0.05); padding-top: 15px;">
              <div style="font-size:0.8rem; color:var(--text-muted); margin-bottom:10px; font-weight:600;">จัดการข้อมูล</div>
              <button class="btn-sidebar" onclick="exportJSON()" style="background:#f1f5f9; color:#475569;">
                  <i class="fas fa-download"></i> สำรองข้อมูล (Backup)
              </button>
              <button class="btn-sidebar" onclick="document.getElementById('restoreInput').click()" style="background:#f1f5f9; color:#475569;">
                  <i class="fas fa-upload"></i> กู้คืนข้อมูล (Restore)
              </button>
          </div>
      </div>
      
      <div style="margin-top:auto; text-align:center; font-size:0.75rem; color:var(--text-muted);">
          v 2.0 (Cloud Sync)
      </div>
  </div>

  <!-- Inputs -->
  <input type="file" id="receiptInput" accept="image/*" style="display: none;">
  <input type="file" id="restoreInput" accept="application/json" style="display: none;" onchange="importJSON(this)">

  <div class="loading" id="loadingOverlay">
    <div class="spinner"></div>
    <p style="margin-top:15px; font-weight:600;">AI กำลังทำงาน...</p>
  </div>

  <div class="main-container">
      <div class="dashboard">
        <div class="dash-header">
            <div class="user-profile-header">
                <!-- Hamburger Button -->
                <i class="fas fa-bars menu-trigger" onclick="toggleMenu()"></i>
                <div class="user-info">
                    <h2 id="appTitle">การเงินของฉัน</h2>
                    <div id="userRole" style="font-size: 0.8rem; color: var(--text-muted);"><i class="fas fa-wallet"></i> Personal Wallet</div>
                </div>
            </div>
            <div id="syncStatus" class="sync-status">
                <i class="fas fa-wifi"></i> Offline
            </div>
        </div>
        
        <div class="balance-container">
            <div class="balance-label">ยอดคงเหลือสุทธิ</div>
            <div class="balance-amount" id="grandBalance">0</div>
        </div>

        <div class="stats-row">
            <div class="stat-item">
                <span class="stat-label">รายรับ</span>
                <span class="stat-val val-inc" id="grandIncome">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">รายจ่าย</span>
                <span class="stat-val val-exp" id="grandExpense">0</span>
            </div>
            <div class="stat-item" style="border-left:1px solid rgba(0,0,0,0.1);">
                <span class="stat-label">เงินออม</span>
                <span class="stat-val val-save" id="grandSavings">0</span>
            </div>
        </div>

        <div class="top-expenses-widget">
            <div style="font-size:0.8rem; font-weight:600; color:var(--warning); margin-bottom:8px;"><i class="fas fa-trophy"></i> รายจ่ายสูงสุดปีนี้</div>
            <div id="yearTopExpList" style="white-space: nowrap; overflow-x: auto; padding-bottom: 5px;"></div>
        </div>
      </div>

      <div class="toolbar-container">
        <!-- Buttons removed here -->
        <button class="btn-tool ai" onclick="analyzeBudgetWithAI()"><i class="fas fa-robot"></i> AI</button>
        <button class="btn-tool graph" onclick="openChart()"><i class="fas fa-chart-pie"></i> กราฟ</button>
        <button class="btn-tool savings" onclick="openSavingsChart()"><i class="fas fa-piggy-bank"></i> ออม</button>
        <button class="btn-tool excel" onclick="exportToExcel()"><i class="fas fa-file-excel"></i> Excel</button>
        <button class="btn-tool clear" onclick="clearData()"><i class="fas fa-trash-alt"></i> ล้าง</button>
      </div>

      <div id="cardsContainer"></div>
  </div>

  <!-- Modals -->
  <div class="modal" id="chartModal">
    <div class="modal-card">
      <span class="close-btn" onclick="closeChart()">&times;</span>
      <h3 style="margin:0 0 15px 0;">สถิติภาพรวม</h3>
      <div class="chart-wrapper">
        <canvas id="chart"></canvas>
      </div>
    </div>
  </div>

  <div class="modal" id="aiModal">
    <div class="modal-card" style="display:block; overflow-y:auto;">
      <span class="close-btn" onclick="closeAiModal()">&times;</span>
      <h3 style="margin:0 0 10px 0; color:#667eea;"><i class="fas fa-robot"></i> AI Coach</h3>
      <div id="aiContent" style="line-height:1.7; font-size:0.95rem;"></div>
    </div>
  </div>

  <!-- Firebase Scripts -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- ส่วนสำหรับใส่ Config ของคุณเอง (ถ้ามี) ---
    const YOUR_FIREBASE_CONFIG = {
      apiKey: "AIzaSyDUliKbJO1YyUNjZdBvkBULaWlEaBzmcAA",
      authDomain: "budget1-ed2f4.firebaseapp.com",
      projectId: "budget1-ed2f4",
      storageBucket: "budget1-ed2f4.firebasestorage.app",
      messagingSenderId: "312969765873",
      appId: "1:312969765873:web:db0e163fe587149963da50",
      measurementId: "G-FXT8WGFGKP"
    };

    let db, auth, userId, appId;
    let useCloud = false;
    let unsubscribeData = null;

    async function initFirebase() {
        let config = YOUR_FIREBASE_CONFIG;
        
        if (!config && typeof __firebase_config !== 'undefined') {
            config = JSON.parse(__firebase_config);
        }
        
        appId = typeof __app_id !== 'undefined' ? __app_id : 'budget-app';

        if (config) {
            try {
                const app = initializeApp(config);
                auth = getAuth(app);
                db = getFirestore(app);
                
                // Expose auth functions globally
                window.loginGoogle = async () => {
                    try {
                        const provider = new GoogleAuthProvider();
                        await signInWithPopup(auth, provider);
                        window.toggleMenu(); // Close menu on success
                    } catch(e) { alert("Login Failed: " + e.message); }
                };

                window.logout = async () => {
                    try {
                        await signOut(auth);
                        window.location.reload(); // Reload to clear state
                    } catch(e) { console.error(e); }
                };
                
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } 

                onAuthStateChanged(auth, (user) => {
                    // Update Sidebar UI
                    const btnLogin = document.getElementById('sidebarBtnLogin');
                    const btnLogout = document.getElementById('sidebarBtnLogout');
                    const userInfo = document.getElementById('sidebarUserInfo');
                    const avatar = document.getElementById('sidebarAvatar');
                    const userName = document.getElementById('sidebarName');
                    
                    const dashboardRole = document.getElementById('userRole');
                    
                    if (user) {
                        userId = user.uid;
                        useCloud = !user.isAnonymous; 
                        
                        // Update UI
                        if (!user.isAnonymous) {
                            updateSyncStatus('online');
                            
                            // Sidebar Logic
                            btnLogin.style.display = 'none';
                            btnLogout.style.display = 'flex';
                            userInfo.style.display = 'block';
                            
                            if(user.photoURL) avatar.src = user.photoURL;
                            userName.innerText = user.displayName || "User";
                            
                            dashboardRole.innerText = user.displayName || "User";
                            
                            // Start Cloud Listener
                            startDataListener();
                        } else {
                            updateSyncStatus('offline'); 
                        }
                    } else {
                        // Signed out
                        useCloud = false;
                        updateSyncStatus('offline');
                        
                        // Sidebar Logic
                        btnLogin.style.display = 'flex';
                        btnLogout.style.display = 'none';
                        userInfo.style.display = 'none';
                        dashboardRole.innerText = "Personal Wallet";
                    }
                });
            } catch (e) {
                console.log("Firebase Init Failed (Offline Mode)");
                updateSyncStatus('offline');
            }
        } else {
            console.log("No Firebase Config - Running in Offline Mode");
            updateSyncStatus('offline');
        }
    }

    function startDataListener() {
        if (!db || !userId) return;
        if (unsubscribeData) unsubscribeData();

        const safeAppId = appId || 'budget-app';
        const docRef = doc(db, 'artifacts', safeAppId, 'users', userId, 'budget_data', 'yearly');
        
        unsubscribeData = onSnapshot(docRef, (docSnap) => {
            if (docSnap.exists()) {
                const data = docSnap.data();
                if (data && data.monthlyData) {
                    window.monthlyData = data.monthlyData;
                    if (typeof window.renderCards === 'function') {
                        window.renderCards(); 
                    }
                }
            } else {
                saveDataToCloud();
            }
        }, (error) => {
            console.error("Sync Error", error);
            updateSyncStatus('error');
        });
    }

    window.saveDataToCloud = async function() {
        if (useCloud && db && userId) {
            updateSyncStatus('syncing');
            try {
                const safeAppId = appId || 'budget-app';
                await setDoc(doc(db, 'artifacts', safeAppId, 'users', userId, 'budget_data', 'yearly'), {
                    monthlyData: window.monthlyData,
                    lastUpdated: new Date().toISOString()
                });
                updateSyncStatus('online');
            } catch (e) { 
                console.error("Save Error", e);
                updateSyncStatus('error'); 
            }
        }
    }

    function updateSyncStatus(status) {
        const badge = document.getElementById('syncStatus');
        badge.classList.add('show');
        if (status === 'online') {
            badge.className = 'sync-status online';
            badge.innerHTML = '<i class="fas fa-cloud"></i> Online';
        } else if (status === 'syncing') {
            badge.className = 'sync-status';
            badge.innerHTML = '<i class="fas fa-sync fa-spin"></i> Syncing...';
        } else if (status === 'error') {
            badge.className = 'sync-status offline';
            badge.innerHTML = '<i class="fas fa-exclamation-circle"></i> Error';
        } else {
            badge.className = 'sync-status offline';
            badge.innerHTML = '<i class="fas fa-wifi"></i> Offline';
        }
    }

    initFirebase();
  </script>

  <script>
    const apiKey = ""; 
    const backgroundImages = ['DSCF1292.jpg', 'DSCF1361.jpg', 'DSCF1400.jpg', 'DSC00543.jpg', 'DSCF0921.jpg'];
    let currentBgIndex = 0;
    
    // BG Logic
    const bgA = document.getElementById('bg1');
    const bgB = document.getElementById('bg2');
    bgA.style.backgroundImage = `url(${backgroundImages[0]})`;
    setInterval(() => {
      currentBgIndex = (currentBgIndex + 1) % backgroundImages.length;
      const show = (currentBgIndex % 2 === 0) ? bgA : bgB;
      const hide = (currentBgIndex % 2 === 0) ? bgB : bgA;
      show.style.backgroundImage = `url(${backgroundImages[currentBgIndex]})`;
      show.classList.add('active'); hide.classList.remove('active');
    }, 8000);

    function updateDayNight() {
      const hour = new Date().getHours();
      const isNight = hour >= 18 || hour < 6;
      document.getElementById('overlay').className = `bg-overlay ${isNight ? 'night' : 'day'}`;
      if(isNight) document.body.classList.add('night'); else document.body.classList.remove('night');
    }
    updateDayNight();

    // Data Init
    const months = ["มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน", "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"];
    window.monthlyData = JSON.parse(localStorage.getItem('yearlyBudget_v1')) || months.map(() => ({ salary: 0, extra: 0, savings: 0, budget: 0, details: [] }));
    window.monthlyData = window.monthlyData.map(m => ({ ...m, savings: m.savings || 0, budget: m.budget || 0 }));

    // Helper Stats
    function calculateStats(m) {
        const dInc = m.details.filter(d => d.type === 'income').reduce((s, d) => s + (Number(d.amount)||0), 0);
        const dExp = m.details.filter(d => d.type === 'expense').reduce((s, d) => s + (Number(d.amount)||0), 0);
        const totalInc = (Number(m.salary)||0) + (Number(m.extra)||0) + dInc;
        const totalExp = dExp;
        const saving = Number(m.savings)||0;
        const budget = Number(m.budget)||0;
        const balance = totalInc - totalExp;
        const freeBalance = balance - saving;
        
        let progress = 0;
        let progressColor = '#2dce89'; 
        if(budget > 0) {
            progress = (totalExp / budget) * 100;
            if(progress > 100) progressColor = '#f5365c';
            else if(progress > 75) progressColor = '#fb6340';
        }
        return { totalInc, totalExp, balance, saving, budget, freeBalance, progress, progressColor };
    }

    function calculateYearlyTop5() {
        const expMap = {};
        window.monthlyData.forEach(m => {
            m.details.filter(d => d.type === 'expense').forEach(d => {
                const key = d.desc.trim() || 'อื่นๆ';
                expMap[key] = (expMap[key] || 0) + (Number(d.amount)||0);
            });
        });
        return Object.entries(expMap).sort((a, b) => b[1] - a[1]).slice(0, 5).map(([name, val]) => ({ name, val }));
    }

    function refreshStats() {
        let gInc = 0, gExp = 0, gSave = 0;
        
        window.monthlyData.forEach((m, idx) => {
            const stats = calculateStats(m);
            gInc += stats.totalInc; gExp += stats.totalExp; gSave += stats.saving;

            const ids = { bal: `m-bal-${idx}`, inc: `m-inc-${idx}`, exp: `m-exp-${idx}`, free: `m-free-${idx}`, pFill: `prog-fill-${idx}`, pText: `prog-text-${idx}` };
            
            const balEl = document.getElementById(ids.bal);
            if(balEl) {
                balEl.innerText = stats.balance.toLocaleString();
                balEl.className = `m-balance ${stats.balance >= 0 ? 'val-inc' : 'val-exp'}`;
                document.getElementById(ids.inc).innerText = stats.totalInc.toLocaleString();
                document.getElementById(ids.exp).innerText = stats.totalExp.toLocaleString();
                
                const freeEl = document.getElementById(ids.free);
                freeEl.innerText = stats.freeBalance.toLocaleString();
                freeEl.style.color = stats.freeBalance >= 0 ? 'var(--text-main)' : 'var(--danger)';

                const pFill = document.getElementById(ids.pFill);
                if(pFill) {
                    pFill.style.width = Math.min(stats.progress, 100) + '%';
                    pFill.style.backgroundColor = stats.progressColor;
                    document.getElementById(ids.pText).innerText = `ใช้ไป ${stats.totalExp.toLocaleString()} / ${stats.budget.toLocaleString()} (${Math.round(stats.progress)}%)`;
                }
            }
        });

        document.getElementById('grandIncome').innerText = gInc.toLocaleString();
        document.getElementById('grandExpense').innerText = gExp.toLocaleString();
        document.getElementById('grandSavings').innerText = gSave.toLocaleString();
        const gBal = gInc - gExp;
        const gBalEl = document.getElementById('grandBalance');
        gBalEl.innerText = gBal.toLocaleString();
        gBalEl.classList.toggle('positive', gBal >= 0);

        const top5 = calculateYearlyTop5();
        let topHtml = '';
        if (top5.length > 0) {
            top5.forEach(item => topHtml += `<span class="top-pill">${item.name} ${item.val.toLocaleString()}</span>`);
        } else { topHtml = '<span style="color:var(--text-muted); font-size:0.8rem;">ยังไม่มีข้อมูล</span>'; }
        document.getElementById('yearTopExpList').innerHTML = topHtml;
    }

    function triggerSave() {
        localStorage.setItem('yearlyBudget_v1', JSON.stringify(window.monthlyData));
        if(window.saveDataToCloud) window.saveDataToCloud();
    }
    function saveDataAndRender() { triggerSave(); window.renderCards(); }

    window.renderCards = function() {
      const container = document.getElementById('cardsContainer');
      const openStates = Array.from(document.querySelectorAll('.month-card')).map(c => c.classList.contains('open'));
      let html = '';

      window.monthlyData.forEach((m, idx) => {
        const stats = calculateStats(m);
        const isOpen = openStates[idx] ? 'open' : '';

        let detailsHtml = '';
        m.details.forEach((d, dIdx) => {
          const isInc = d.type === 'income';
          detailsHtml += `
            <div class="detail-row">
              <select class="type-select ${isInc?'inc':'exp'}" onchange="updateDetail(${idx}, ${dIdx}, 'type', this.value)">
                <option value="income" ${isInc?'selected':''}>+ รับ</option>
                <option value="expense" ${!isInc?'selected':''}>- จ่าย</option>
              </select>
              <input class="desc-input" type="text" placeholder="รายการ..." value="${d.desc}" oninput="updateDetail(${idx}, ${dIdx}, 'desc', this.value)">
              <input class="amt-input" type="number" placeholder="0" value="${d.amount}" oninput="updateDetail(${idx}, ${dIdx}, 'amount', this.value)">
              <button class="btn-del" onclick="removeDetail(${idx}, ${dIdx})"><i class="fas fa-times"></i></button>
            </div>
          `;
        });

        html += `
          <div class="month-card ${isOpen}" id="card-${idx}">
            <div class="card-header" onclick="toggleCard(${idx})">
              <div class="m-title">
                <div class="m-icon-box"><i class="far fa-calendar"></i></div>
                <div>
                    <div>${months[idx]}</div>
                    <div style="width:80px; height:4px; background:#eee; border-radius:4px; margin-top:4px; overflow:hidden;">
                        <div style="height:100%; width:${Math.min(stats.progress, 100)}%; background:${stats.progressColor};"></div>
                    </div>
                </div>
              </div>
              <div class="m-stat">
                <span id="m-bal-${idx}" class="m-balance ${stats.balance >= 0 ? 'val-inc' : 'val-exp'}">${stats.balance.toLocaleString()}</span>
                <div class="m-subtext">คงเหลือ</div>
              </div>
            </div>

            <div class="card-body">
              <div class="budget-bar-container">
                <div class="budget-header"><span><i class="fas fa-bullseye"></i> เป้าหมาย</span> <span id="prog-text-${idx}">ใช้ไป ${stats.totalExp.toLocaleString()}</span></div>
                <div class="progress-track"><div id="prog-fill-${idx}" class="progress-fill" style="width:${Math.min(stats.progress, 100)}%; background-color:${stats.progressColor}"></div></div>
                <div style="margin-top:8px;"><input class="modern-input" style="padding:8px; font-size:0.85rem;" type="number" value="${m.budget||''}" placeholder="ตั้งงบ (บาท)..." oninput="updateBase(${idx}, 'budget', this.value)"></div>
              </div>

              <div class="input-row">
                <div class="modern-input-group"><label>เงินเดือน</label><input class="modern-input" type="number" value="${m.salary||''}" placeholder="0" oninput="updateBase(${idx}, 'salary', this.value)"></div>
                <div class="modern-input-group"><label>รายได้พิเศษ</label><input class="modern-input" type="number" value="${m.extra||''}" placeholder="0" oninput="updateBase(${idx}, 'extra', this.value)"></div>
              </div>

              <div class="savings-section">
                <div class="savings-header"><i class="fas fa-piggy-bank"></i> เงินออม</div>
                <input class="modern-input" style="border-color:var(--info);" type="number" value="${m.savings||''}" placeholder="ระบุยอดออม..." oninput="updateBase(${idx}, 'savings', this.value)">
                <div class="free-cash-display">คงเหลือใช้จริง: <span id="m-free-${idx}" class="free-cash-val">${stats.freeBalance.toLocaleString()}</span></div>
              </div>

              <div class="detail-container">${detailsHtml}</div>

              <div class="action-row">
                <button class="action-btn btn-add-inc" onclick="addDetail(${idx}, 'income')"><i class="fas fa-plus"></i> รับ</button>
                <button class="action-btn btn-add-exp" onclick="addDetail(${idx}, 'expense')"><i class="fas fa-minus"></i> จ่าย</button>
              </div>
              <button class="scan-btn" onclick="triggerScan(${idx})"><i class="fas fa-camera"></i> สแกนสลิป (AI)</button>

              <div style="margin-top:15px; font-size:0.8rem; color:var(--text-muted); display:flex; justify-content:space-between;">
                 <span>รับ: <b id="m-inc-${idx}" class="val-inc">${stats.totalInc.toLocaleString()}</b></span>
                 <span>จ่าย: <b id="m-exp-${idx}" class="val-exp">${stats.totalExp.toLocaleString()}</b></span>
              </div>
            </div>
          </div>
        `;
      });
      container.innerHTML = html;
      refreshStats(); 
    }

    // Window Functions
    window.toggleCard = function(idx) { document.getElementById(`card-${idx}`).classList.toggle('open'); }
    window.updateBase = function(idx, f, v) { window.monthlyData[idx][f] = Number(v); refreshStats(); triggerSave(); }
    window.updateDetail = function(midx, didx, f, v) { 
        window.monthlyData[midx].details[didx][f] = (f==='amount') ? Number(v) : v;
        if(f==='type') saveDataAndRender(); else { refreshStats(); triggerSave(); }
    }
    window.addDetail = function(idx, type) { window.monthlyData[idx].details.push({type, desc:'', amount:''}); saveDataAndRender(); }
    window.removeDetail = function(m, d) { window.monthlyData[m].details.splice(d, 1); saveDataAndRender(); }
    window.clearData = function() { if(confirm('ลบข้อมูลทั้งหมด?')) { window.monthlyData=months.map(()=>({salary:0,extra:0,savings:0,budget:0,details:[]})); saveDataAndRender(); } }
    
    // Sidebar Toggle
    window.toggleMenu = function() {
        document.getElementById('sideMenu').classList.toggle('active');
        document.getElementById('menuOverlay').classList.toggle('active');
    }

    // Backup/Restore
    window.exportJSON = function() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(window.monthlyData));
        const a = document.createElement('a'); a.href = dataStr; a.download = "budget_backup_"+new Date().toISOString().slice(0,10)+".json";
        document.body.appendChild(a); a.click(); a.remove();
    }
    window.importJSON = function(input) {
        if(!input.files[0]) return;
        const r = new FileReader();
        r.onload = function(e) {
            try {
                const json = JSON.parse(e.target.result);
                if(Array.isArray(json)) { window.monthlyData = json; saveDataAndRender(); alert("กู้คืนสำเร็จ!"); }
            } catch(err) { alert("ไฟล์ผิดพลาด"); }
        };
        r.readAsText(input.files[0]); input.value='';
    }

    // AI & Chart
    async function callGemini(p) { 
      const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({contents:[{parts:[{text:p}]}]})});
      const d = await res.json(); return d.candidates[0].content.parts[0].text;
    }
    async function callGeminiVision(b64) {
      const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({contents:[{role:"user", parts:[{text:"Extract merchant and amount. JSON: {\"description\":\"str\",\"amount\":num,\"type\":\"expense\"}"},{inlineData:{mimeType:"image/jpeg",data:b64}}]}]})});
      const d = await res.json(); return JSON.parse(d.candidates[0].content.parts[0].text.replace(/```json/g,'').replace(/```/g,'').trim());
    }

    window.analyzeBudgetWithAI = async function() {
        document.getElementById('loadingOverlay').style.display='flex';
        try {
            const sum = window.monthlyData.map((m,i)=>`${months[i]}: In=${(m.salary||0)+(m.extra||0)+m.details.filter(d=>d.type==='income').reduce((s,x)=>s+Number(x.amount),0)}, Out=${m.details.filter(d=>d.type==='expense').reduce((s,x)=>s+Number(x.amount),0)}, Save=${m.savings||0}`).join('\n');
            const txt = await callGemini(`Analyze this Thai budget:\n${sum}\nGive 3 short tips in Thai markdown.`);
            document.getElementById('aiContent').innerHTML = marked.parse(txt);
            document.getElementById('aiModal').classList.add('show');
        } catch(e) { alert("AI Error"); } finally { document.getElementById('loadingOverlay').style.display='none'; }
    }

    let myChart = null;
    function createChart(type, data, opts) {
        if(myChart) myChart.destroy();
        myChart = new Chart(document.getElementById('chart').getContext('2d'), {type, data, options:opts});
        document.getElementById('chartModal').classList.add('show');
    }

    window.openChart = function() {
        const dInc = window.monthlyData.map(m=>(m.salary||0)+(m.extra||0)+m.details.filter(d=>d.type==='income').reduce((s,d)=>s+(d.amount||0),0));
        const dExp = window.monthlyData.map(m=>m.details.filter(d=>d.type==='expense').reduce((s,d)=>s+(d.amount||0),0));
        const dSave = window.monthlyData.map(m=>Number(m.savings)||0);
        createChart('bar', {
            labels: months,
            datasets: [
                { label: 'รับ', data: dInc, backgroundColor: '#2dce89', borderRadius:4 },
                { label: 'จ่าย', data: dExp, backgroundColor: '#f5365c', borderRadius:4 },
                { label: 'ออม', data: dSave, backgroundColor: '#11cdef', borderRadius:4 }
            ]
        }, { responsive:true, maintainAspectRatio:false, scales:{x:{grid:{display:false}},y:{grid:{borderDash:[4,4]},beginAtZero:true}}, plugins:{legend:{position:'bottom'}} });
    }

    window.openSavingsChart = function() {
        const dSave = window.monthlyData.map(m=>Number(m.savings)||0);
        const dFree = window.monthlyData.map(m=>calculateStats(m).freeBalance);
        createChart('line', {
            labels: months,
            datasets: [
                { label: 'ยอดออม', data: dSave, borderColor: '#11cdef', backgroundColor: 'rgba(17,205,239,0.2)', fill:true, tension:0.4 },
                { label: 'คงเหลือจริง', data: dFree, borderColor: '#2dce89', borderDash:[5,5], borderWidth:2, tension:0.4 }
            ]
        }, { responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'bottom'}} });
    }

    // Trigger Scan & Close Modal
    window.triggerScan = (idx) => { currentUploadMonthIdx = idx; document.getElementById('receiptInput').click(); }
    document.getElementById('receiptInput').addEventListener('change', async function() {
        if(this.files[0]) {
            document.getElementById('loadingOverlay').style.display='flex';
            const r = new FileReader();
            r.onload = async (e) => {
                try {
                    const res = await callGeminiVision(e.target.result.split(',')[1]);
                    if(res.amount) { window.monthlyData[currentUploadMonthIdx].details.push({type:res.type||'expense', desc:res.description, amount:res.amount}); saveDataAndRender(); }
                } catch(err) { alert("Scan Failed"); } finally { document.getElementById('loadingOverlay').style.display='none'; this.value=''; }
            };
            r.readAsDataURL(this.files[0]);
        }
    });
    
    window.exportToExcel = function() {
       let csv = "\uFEFFเดือน,ประเภท,รายการ,จำนวนเงิน\n";
       window.monthlyData.forEach((m, idx) => {
         if(m.salary) csv += `${months[idx]},รายรับ,เงินเดือน,${m.salary}\n`;
         if(m.extra) csv += `${months[idx]},รายรับ,พิเศษ,${m.extra}\n`;
         if(m.savings) csv += `${months[idx]},เงินออม,จัดสรรเงินออม,${m.savings}\n`;
         m.details.forEach(d => csv += `${months[idx]},${d.type==='income'?'รายรับ':'รายจ่าย'},${d.desc},${d.amount}\n`);
       });
       const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv;charset=utf-8;' }));
       a.download = "Budget_Yearly.csv"; document.body.appendChild(a); a.click(); a.remove();
    }

    window.closeChart = () => document.getElementById('chartModal').classList.remove('show');
    window.closeAiModal = () => document.getElementById('aiModal').classList.remove('show');

    // Call renderCards at the end
    if (typeof window.renderCards === 'function') {
        window.renderCards();
    }
  </script>
</body>
</html>
