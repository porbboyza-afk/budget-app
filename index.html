<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</title>
  
  <!-- PWA Manifest & iOS Support -->
  <link rel="manifest" href="data:application/manifest+json;charset=utf-8,%7B%22name%22%3A%22%E0%B8%81%E0%B8%B2%E0%B8%A3%E0%B9%80%E0%B8%87%E0%B8%B4%E0%B8%99%E0%B8%82%E0%B8%AD%E0%B8%87%E0%B8%89%E0%B8%B1%E0%B8%99%22%2C%22short_name%22%3A%22MyBudget%22%2C%22start_url%22%3A%22.%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%23f8f9fe%22%2C%22theme_color%22%3A%22%235e72e4%22%2C%22icons%22%3A%5B%7B%22src%22%3A%22https%3A%2F%2Fcdn-icons-png.flaticon.com%2F512%2F2344%2F2344147.png%22%2C%22sizes%22%3A%22512x512%22%2C%22type%22%3A%22image%2Fpng%22%7D%5D%7D" />
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#5e72e4">

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&family=Sarabun:wght@300;400;500;600&display=swap" rel="stylesheet">
  
  <style>
    :root {
      /* Theme Variables */
      --primary: #5e72e4;
      --primary-soft: #eaecfb;
      --success: #2dce89;
      --success-soft: #e0fbf4;
      --danger: #f5365c;
      --danger-soft: #fee6ea;
      --warning: #fb6340;
      --warning-soft: #fff3cd;
      --info: #11cdef;
      --info-soft: #e0f7fa;
      
      --text-main: #32325d;
      --text-muted: #8898aa;
      --bg-body: #f8f9fe;
      --bg-card: #ffffff;
      
      --radius: 20px;
      --radius-sm: 12px;
      --shadow-soft: 0 7px 14px rgba(50, 50, 93, 0.1), 0 3px 6px rgba(0, 0, 0, 0.08);
      --bottom-nav-height: 70px;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
      font-family: 'Prompt', 'Sarabun', sans-serif;
      margin: 0; padding: 0;
      min-height: 100vh;
      color: var(--text-main);
      background: var(--bg-body);
      background-size: cover; background-position: center; background-attachment: fixed;
      padding-bottom: calc(var(--bottom-nav-height) + 20px);
      transition: background 0.3s, color 0.3s;
      overscroll-behavior-y: none;
    }
    
    body.night {
        --text-main: #e2e8f0; --text-muted: #94a3b8;
        --bg-body: #0f172a; --bg-card: #1e293b;
        --primary-soft: rgba(94, 114, 228, 0.15); 
        --success-soft: rgba(45, 206, 137, 0.15);
        --danger-soft: rgba(245, 54, 92, 0.15); 
        --info-soft: rgba(17, 205, 239, 0.15);
        --warning-soft: rgba(251, 99, 64, 0.15);
    }

    /* Layout */
    .main-container {
        max-width: 600px; margin: 0 auto; width: 100%; padding: 20px;
    }
    
    .view-section {
        display: none;
        animation: fadeIn 0.3s ease;
    }
    .view-section.active { display: block; }

    /* Dashboard */
    .dashboard {
      background: var(--bg-card);
      border-radius: var(--radius); padding: 24px;
      box-shadow: var(--shadow-soft);
      margin-bottom: 25px; position: relative; overflow: hidden;
      border: 1px solid rgba(255,255,255,0.5);
    }
    .night .dashboard { border-color: rgba(255,255,255,0.05); }
    .dashboard::before {
        content: ''; position: absolute; top: 0; left: 0; right: 0; height: 6px;
        background: linear-gradient(90deg, var(--primary), var(--info));
    }
    
    .dash-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; }
    
    .user-profile-header { display: flex; align-items: center; gap: 12px; }
    .main-avatar {
        width: 45px; height: 45px; border-radius: 50%; object-fit: cover;
        border: 2px solid var(--bg-card); box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        display: none;
    }
    
    .balance-container { text-align: center; margin-bottom: 25px; padding: 10px 0; }
    .balance-label { font-size: 0.9rem; color: var(--text-muted); margin-bottom: 5px; font-weight: 500; }
    .balance-amount { 
        font-size: 2.8rem; font-weight: 700; color: var(--text-main); 
        letter-spacing: -1px; line-height: 1;
        transition: color 0.3s;
    }
    .balance-amount.positive { color: var(--primary); }

    .stats-row { 
        display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;
        background: var(--primary-soft); padding: 15px; border-radius: var(--radius-sm); 
        margin-top: 10px;
    }
    .night .stats-row { background: rgba(255,255,255,0.03); }
    .stat-item { text-align: center; }
    .stat-label { font-size: 0.75rem; color: var(--text-muted); display: block; margin-bottom: 4px; }
    .stat-val { font-size: 1rem; font-weight: 600; white-space: nowrap; }

    /* Month Summary Cards */
    .month-summary-card {
        background: var(--bg-card); border-radius: var(--radius); margin-bottom: 15px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.05);
        padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;
        cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;
    }
    .month-summary-card:active { transform: scale(0.98); }
    .m-left { display: flex; align-items: center; gap: 15px; }
    .m-icon { 
        width: 45px; height: 45px; background: var(--primary-soft); border-radius: 12px; 
        display: flex; align-items: center; justify-content: center; color: var(--primary); font-size: 1.2rem;
    }
    .m-info h4 { margin: 0; font-size: 1rem; font-weight: 600; color: var(--text-main); }
    .m-info span { font-size: 0.8rem; color: var(--text-muted); }
    .m-right { text-align: right; }
    .m-bal { font-weight: 700; font-size: 1rem; display: block; }

    /* Nav Header */
    .nav-header { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }
    .btn-back {
        width: 40px; height: 40px; border-radius: 12px; background: var(--bg-card);
        border: none; box-shadow: var(--shadow-soft); display: flex; align-items: center; justify-content: center;
        color: var(--text-main); cursor: pointer; font-size: 1rem;
    }
    .page-title { margin: 0; font-size: 1.5rem; color: var(--text-main); font-weight: 700; }

    /* Inputs */
    .input-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
    .modern-input {
        width: 100%; padding: 12px 15px; border-radius: var(--radius-sm); border: 1px solid #e2e8f0;
        background: var(--bg-body); font-size: 1rem; color: var(--text-main); font-family: 'Sarabun';
        transition: border-color 0.2s;
    }
    .night .modern-input { border-color: #334155; }
    .modern-input:focus { border-color: var(--primary); outline: none; }
    .modern-input-group label { font-size: 0.75rem; color: var(--text-muted); margin-bottom: 5px; display: block; font-weight: 600;}
    
    /* Category Picker */
    .category-picker-container { position: relative; display: flex; align-items: center; margin-bottom: 15px; }
    .category-scroll {
        display: flex; gap: 12px; overflow-x: auto; padding: 10px 5px; 
        scrollbar-width: none; flex: 1; scroll-behavior: smooth;
    }
    .cat-item { display: flex; flex-direction: column; align-items: center; gap: 5px; flex: none; width: 60px; cursor: pointer; }
    .cat-btn {
        width: 48px; height: 48px; border-radius: 50%; border: none;
        background: var(--bg-card); display: flex; align-items: center; justify-content: center;
        font-size: 1.4rem; transition: transform 0.1s; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .cat-item:active .cat-btn { transform: scale(0.9); background: var(--primary-soft); }
    .cat-label { font-size: 0.75rem; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; text-align: center; }
    .night .cat-btn { background: #334155; }
    .cat-nav-btn {
      background: var(--bg-card); border: none; width: 30px; height: 30px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text-muted); font-size: 0.8rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); z-index: 2;
    }

    /* Action Buttons */
    .action-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 20px; }
    .action-btn {
        padding: 12px; border: none; border-radius: 50px;
        font-weight: 600; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px;
        color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.15); transition: transform 0.1s;
        font-size: 0.9rem; height: 60px;
    }
    .action-btn:active { transform: scale(0.95); }
    .btn-inc { background: linear-gradient(135deg, #2dce89, #2dcecc); }
    .btn-exp { background: linear-gradient(135deg, #f5365c, #f56636); }
    .btn-scan { background: linear-gradient(135deg, #5e72e4, #825ee4); }

    /* Detail List */
    .detail-container { margin-top: 20px; background: var(--bg-card); border-radius: var(--radius); padding: 15px; box-shadow: var(--shadow-soft); }
    .detail-row {
        display: flex; align-items: center; gap: 8px; margin-bottom: 10px; padding-bottom: 10px;
        border-bottom: 1px solid rgba(0,0,0,0.05);
    }
    .detail-row:last-child { margin-bottom: 0; border-bottom: none; padding-bottom: 0; }
    
    .type-badge {
        width: 30px; height: 30px; border-radius: 8px; display: flex; align-items: center; justify-content: center;
        font-size: 0.8rem; font-weight: bold; cursor: pointer; flex-shrink: 0;
    }
    .badge-inc { background: var(--success-soft); color: var(--success); }
    .badge-exp { background: var(--danger-soft); color: var(--danger); }
    
    .desc-input { flex: 1; min-width: 0; border: none; background: transparent; color: var(--text-main); font-size: 0.95rem; }
    .amt-input { width: 70px; flex-shrink: 0; border: none; background: transparent; text-align: right; font-weight: 600; color: var(--text-main); font-size: 0.95rem; }
    
    /* Vertical Divider */
    .detail-divider { width: 1px; height: 24px; background: #e2e8f0; margin: 0 4px; }
    .night .detail-divider { background: #334155; }

    .btn-del { width: 28px; height: 28px; flex-shrink: 0; border-radius: 50%; border: none; background: var(--danger-soft); color: var(--danger); cursor: pointer; display: flex; align-items: center; justify-content: center; }

    /* Bottom Nav */
    .bottom-nav {
        position: fixed; bottom: 0; left: 0; width: 100%; height: var(--bottom-nav-height);
        background: var(--bg-card); 
        box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
        display: flex; justify-content: space-around; align-items: center;
        z-index: 1000; border-top-left-radius: 20px; border-top-right-radius: 20px;
        backdrop-filter: blur(10px);
        padding-bottom: env(safe-area-inset-bottom);
    }
    .nav-item {
        display: flex; flex-direction: column; align-items: center; gap: 4px;
        color: var(--text-muted); cursor: pointer; transition: color 0.2s; width: 20%;
    }
    .nav-item i { font-size: 1.3rem; margin-bottom: 2px; transition: transform 0.2s; }
    .nav-item span { font-size: 0.7rem; font-weight: 500; }
    .nav-item.active { color: var(--primary); }
    .nav-item.active i { transform: translateY(-3px); }

    /* Modals */
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); z-index: 2000; align-items: center; justify-content: center; padding: 20px; animation: fadeIn 0.2s; }
    .modal.show { display: flex; }
    .modal-card { background: var(--bg-card); width: 100%; max-width: 500px; border-radius: 24px; padding: 25px; max-height: 85vh; overflow-y: auto; position: relative; box-shadow: 0 20px 50px rgba(0,0,0,0.3); }
    
    .chart-btn-grid { margin-top: 20px; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
    .color-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 15px; }
    .color-swatch { width: 40px; height: 40px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: transform 0.2s; }
    .color-swatch.active { border-color: var(--text-main); transform: scale(1.1); }
    
    .btn-mode { flex: 1; padding: 10px; border-radius: 12px; border: 1px solid #eee; background: transparent; color: var(--text-muted); cursor: pointer; font-weight: 500; font-size: 0.9rem; transition: all 0.2s; }
    .night .btn-mode { border-color: #334155; }
    .btn-mode.active { border-color: var(--primary); color: var(--primary); background: var(--primary-soft); }

    .hidden { display: none !important; }
    .btn-full { width: 100%; padding: 12px; border-radius: 12px; border: none; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 10px; }
    .btn-sidebar { width: 100%; padding: 12px; border-radius: 12px; border: none; font-size: 1rem; font-weight: 500; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 10px; transition: background 0.2s; }
    
    .chart-container-wrapper { position: relative; flex: 1; min-height: 0; height: 45vh; width: 100%; }
    
    /* Sidebar */
    .menu-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2999; display: none; opacity: 0; transition: opacity 0.3s; backdrop-filter: blur(2px); }
    .menu-overlay.active { display: block; opacity: 1; }
    .sidebar { position: fixed; top: 0; left: 0; height: 100%; width: 280px; background: var(--bg-card); z-index: 3000; transform: translateX(-100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 2px 0 15px rgba(0,0,0,0.1); padding: 25px; display: flex; flex-direction: column; }
    .sidebar.active { transform: translateX(0); }
    
    /* Top Expenses */
    .top-expenses-widget { margin-top: 20px; padding-top: 15px; border-top: 1px dashed rgba(0,0,0,0.1); }
    .top-pill { display: inline-flex; align-items: center; gap: 6px; background: var(--danger-soft); padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; color: var(--danger); margin-right: 5px; margin-bottom: 5px; font-weight: 500; }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body id="mainBody">

  <!-- ================= VIEW: HOME (YEARLY) ================= -->
  <div id="view-home" class="view-section active">
      <div class="main-container">
          <!-- Yearly Dashboard -->
          <div class="dashboard">
              <div class="dash-header">
                  <div class="user-profile-header">
                      <i class="fas fa-bars" style="font-size:1.4rem; cursor:pointer;" onclick="toggleMenu()"></i>
                      <img id="mainAvatar" class="main-avatar" src="" alt="Me">
                      <div class="user-info">
                          <h2 style="margin:0; font-size:1.2rem;">‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h2>
                          <div id="userRole" style="font-size:0.8rem; color:var(--text-muted);">Personal Wallet</div>
                      </div>
                  </div>
                  <div id="syncStatus" style="font-size:0.75rem; padding:4px 10px; border-radius:20px; background:#e2e8f0; color:#64748b;">
                      <i class="fas fa-wifi"></i> Offline
                  </div>
              </div>
              
              <div class="balance-container">
                  <div class="balance-label">‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</div>
                  <div class="balance-amount" id="grandBalance">0</div>
              </div>

              <div class="stats-row">
                  <div class="stat-item">
                      <span class="stat-label">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</span>
                      <span class="stat-val" style="color:var(--success)" id="grandIncome">0</span>
                  </div>
                  <div class="stat-item">
                      <span class="stat-label">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</span>
                      <span class="stat-val" style="color:var(--danger)" id="grandExpense">0</span>
                  </div>
                  <div class="stat-item" style="border-left:1px solid rgba(0,0,0,0.1)">
                      <span class="stat-label">‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°</span>
                      <span class="stat-val" style="color:var(--info)" id="grandSavings">0</span>
                  </div>
              </div>
              
              <div class="top-expenses-widget">
                  <div style="font-size:0.8rem; font-weight:600; color:var(--warning); margin-bottom:8px;"><i class="fas fa-trophy"></i> ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏õ‡∏µ‡∏ô‡∏µ‡πâ</div>
                  <div id="yearTopExpList" style="white-space: nowrap; overflow-x: auto; padding-bottom: 5px;"></div>
              </div>
          </div>

          <!-- Month List (Cards) -->
          <div id="homeMonthList"></div>
      </div>
  </div>

  <!-- ================= VIEW: MONTH DETAIL ================= -->
  <div id="view-month" class="view-section">
      <div class="main-container">
          
          <!-- Month Header -->
          <div class="nav-header">
              <button class="btn-back" onclick="switchView('home')"><i class="fas fa-chevron-left"></i></button>
              <h2 class="page-title" id="detailMonthName">‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°</h2>
          </div>

          <!-- Month Dashboard -->
          <div class="dashboard">
              <div class="balance-container" style="margin-bottom:15px; padding:0;">
                  <div class="balance-label">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div>
                  <div class="balance-amount" id="monthGrandBalance">0</div>
                  <div style="width:100%; height:6px; background:#f1f5f9; border-radius:3px; margin-top:10px; overflow:hidden;">
                      <div id="monthProgressBar" style="height:100%; width:0%; background:var(--success); transition:width 0.5s;"></div>
                  </div>
                  <div id="monthProgressText" style="font-size:0.8rem; color:var(--text-muted); margin-top:5px;"></div>
              </div>
              
              <div class="stats-row">
                  <div class="stat-item">
                      <span class="stat-label">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</span>
                      <span class="stat-val" style="color:var(--success)" id="monthGrandIncome">0</span>
                  </div>
                  <div class="stat-item">
                      <span class="stat-label">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</span>
                      <span class="stat-val" style="color:var(--danger)" id="monthGrandExpense">0</span>
                  </div>
                  <div class="stat-item" style="border-left:1px solid rgba(0,0,0,0.1)">
                      <span class="stat-label">‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°</span>
                      <span class="stat-val" style="color:var(--info)" id="monthGrandSavings">0</span>
                  </div>
              </div>
          </div>

          <!-- Inputs Section -->
          <div style="background:var(--bg-card); border-radius:var(--radius); padding:20px; box-shadow:var(--shadow-soft); margin-bottom:20px;">
              <h4 style="margin:0 0 15px 0; color:var(--text-main);">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö & ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</h4>
              <div class="input-row">
                  <div class="modern-input-group"><label>‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label><input class="modern-input" type="number" id="inpSalary" placeholder="0" oninput="updateCurrentMonthBase('salary', this.value)"></div>
                  <div class="modern-input-group"><label>‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏û‡∏¥‡πÄ‡∏®‡∏©</label><input class="modern-input" type="number" id="inpExtra" placeholder="0" oninput="updateCurrentMonthBase('extra', this.value)"></div>
              </div>
              <div class="input-row">
                  <div class="modern-input-group"><label>‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (Budget)</label><input class="modern-input" style="border-color:var(--warning);" type="number" id="inpBudget" placeholder="0" oninput="updateCurrentMonthBase('budget', this.value)"></div>
                  <div class="modern-input-group"><label>‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°</label><input class="modern-input" style="border-color:var(--info);" type="number" id="inpSavings" placeholder="0" oninput="updateCurrentMonthBase('savings', this.value)"></div>
              </div>
              <div id="copyPrevBtnContainer" style="margin-top:10px;"></div>
          </div>

          <!-- Transactions -->
          <div style="margin-bottom:20px;">
              <h4 style="margin:0 0 10px 0; color:var(--text-main); display:flex; justify-content:space-between;">
                  ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢
                  <span style="font-size:0.8rem; color:var(--text-muted); font-weight:400;">‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</span>
              </h4>
              
              <!-- Quick Add -->
              <div class="category-picker-container">
                  <div class="cat-nav-btn" onclick="document.getElementById('cat-scroll').scrollLeft -= 50"><i class="fas fa-chevron-left"></i></div>
                  <div id="cat-scroll" class="category-scroll"></div> <!-- Injected by JS -->
                  <div class="cat-nav-btn" onclick="document.getElementById('cat-scroll').scrollLeft += 50"><i class="fas fa-chevron-right"></i></div>
              </div>

              <!-- List -->
              <div class="detail-container" id="monthDetailList">
                  <!-- Items injected here -->
              </div>
          </div>
          
          <!-- Floating Action Buttons -->
          <div class="action-row" style="margin-bottom:20px;">
            <button class="action-btn btn-inc" onclick="addDetailCurrent('income')">
                <i class="fas fa-plus"></i> <span>‡∏£‡∏±‡∏ö</span>
            </button>
            <button class="action-btn btn-exp" onclick="addDetailCurrent('expense')">
                <i class="fas fa-minus"></i> <span>‡∏à‡πà‡∏≤‡∏¢</span>
            </button>
            <button class="action-btn btn-scan" onclick="triggerScanCurrent()">
                <i class="fas fa-camera"></i> <span>‡∏™‡πÅ‡∏Å‡∏ô</span>
            </button>
          </div>

      </div>
  </div>

  <!-- Bottom Navigation -->
  <div class="bottom-nav">
      <div class="nav-item active" onclick="switchView('home')">
          <i class="fas fa-home"></i>
          <span>‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</span>
      </div>
      <div class="nav-item" onclick="openChartModal()">
          <i class="fas fa-chart-pie"></i>
          <span>‡∏Å‡∏£‡∏≤‡∏ü</span>
      </div>
      <div class="nav-item" onclick="analyzeBudgetWithAI()">
          <i class="fas fa-robot"></i>
          <span>AI</span>
      </div>
      <div class="nav-item" onclick="openToolsModal()">
          <i class="fas fa-tools"></i>
          <span>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠</span>
      </div>
      <div class="nav-item" onclick="openSettingsModal()">
          <i class="fas fa-cog"></i>
          <span>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</span>
      </div>
  </div>

  <!-- Sidebar & Overlay -->
  <div class="menu-overlay" id="menuOverlay" onclick="toggleMenu()"></div>
  <div class="sidebar" id="sideMenu">
      <div class="sidebar-header">
          <div class="sidebar-title"><i class="fas fa-bars"></i> ‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</div>
          <i class="fas fa-times" onclick="toggleMenu()" style="cursor:pointer; font-size:1.2rem; color:var(--text-muted);"></i>
      </div>
      
      <div class="sidebar-content">
          <!-- User Info (Hidden by default) -->
          <div id="sidebarUserInfo" class="sidebar-user" style="display:none;">
               <img id="sidebarAvatar" src="" class="sidebar-avatar" alt="Avatar">
               <div id="sidebarName" style="font-weight:700; font-size:1.1rem; margin-bottom:5px;">User</div>
               <div style="font-size:0.8rem; color:var(--text-muted);">Logged in via Google</div>
          </div>

          <!-- Auth Buttons -->
          <button id="sidebarBtnLogin" class="btn-sidebar btn-google" onclick="loginGoogle()">
              <i class="fab fa-google"></i> ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
          </button>
          
          <button id="sidebarBtnLogout" class="btn-sidebar btn-logout" onclick="logout()" style="display:none;">
              <i class="fas fa-sign-out-alt"></i> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
          </button>

          <!-- Data Management -->
          <div style="margin-top: 20px; border-top: 1px solid rgba(0,0,0,0.05); padding-top: 15px;">
              <div style="font-size:0.8rem; color:var(--text-muted); margin-bottom:10px; font-weight:600;">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
              
              <button class="btn-sidebar" onclick="exportToExcel()" style="background:#d1fae5; color:#065f46;">
                  <i class="fas fa-file-excel"></i> ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel
              </button>
              
              <button class="btn-sidebar" onclick="exportJSON()" style="background:#f1f5f9; color:#475569;">
                  <i class="fas fa-download"></i> ‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Backup)
              </button>
              
              <button class="btn-sidebar" onclick="document.getElementById('restoreInput').click()" style="background:#f1f5f9; color:#475569;">
                  <i class="fas fa-upload"></i> ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Restore)
              </button>
          </div>
      </div>
      
      <div style="margin-top:auto; text-align:center; font-size:0.75rem; color:var(--text-muted);">
          v 2.4 (No Duplicates)
      </div>
  </div>

  <!-- Inputs -->
  <input type="file" id="receiptInput" accept="image/*" style="display: none;">
  <input type="file" id="restoreInput" accept="application/json" style="display: none;" onchange="importJSON(this)">
  <input type="file" id="bgInput" accept="image/*" style="display: none;" onchange="handleBgChange(this)">

  <div class="loading" id="loadingOverlay">
    <div class="spinner"></div>
    <p style="margin-top:15px; font-weight:600;">AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô...</p>
  </div>

  <!-- Modals -->
  <div class="modal" id="chartModal">
    <div class="modal-card">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <h3 style="margin:0;">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</h3>
        <i class="fas fa-times" style="cursor:pointer; font-size:1.2rem;" onclick="closeModal('chartModal')"></i>
      </div>
      <div class="chart-container-wrapper"><canvas id="chart"></canvas></div>
      <div class="chart-btn-grid">
          <button class="btn-full" style="background:var(--primary-soft); color:var(--primary); margin:0;" onclick="renderChart('bar')">‡πÅ‡∏ó‡πà‡∏á</button>
          <button class="btn-full" style="background:var(--warning-soft); color:var(--warning); margin:0;" onclick="renderChart('pie')">‡∏ß‡∏á‡∏Å‡∏•‡∏°</button>
          <button class="btn-full" style="background:var(--info-soft); color:var(--info); margin:0;" onclick="renderChart('line')">‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°</button>
      </div>
    </div>
  </div>

  <div class="modal" id="aiModal">
    <div class="modal-card" style="max-height:80vh; overflow-x: hidden;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <h3 style="margin:0; color:var(--primary);"><i class="fas fa-robot"></i> AI Coach</h3>
        <i class="fas fa-times" style="cursor:pointer;" onclick="closeModal('aiModal')"></i>
      </div>
      <div id="aiContent" style="line-height:1.7; font-size:0.95rem; overflow-y:auto; overflow-x:hidden; word-wrap:break-word;"></div>
    </div>
  </div>

  <div class="modal" id="toolsModal">
    <div class="modal-card" style="max-width:400px;">
      <h3 style="margin-top:0;">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠</h3>
      <button class="btn-full" style="background:#d1fae5; color:#065f46;" onclick="exportToExcel()"><i class="fas fa-file-excel"></i> Excel</button>
      <button class="btn-full" style="background:#fee2e2; color:#dc2626;" onclick="clearData()"><i class="fas fa-trash-alt"></i> ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
      <button class="btn-full" style="margin-top:10px; background:transparent; color:#888;" onclick="closeModal('toolsModal')">‡∏õ‡∏¥‡∏î</button>
    </div>
  </div>

  <div class="modal" id="settingsModal">
    <div class="modal-card" style="max-width:400px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h3 style="margin:0;">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</h3>
            <i class="fas fa-times" style="cursor:pointer;" onclick="closeModal('settingsModal')"></i>
        </div>
        
        <div id="authSection" style="margin-bottom:20px; padding-bottom:10px; border-bottom:1px solid #eee;">
            <button id="btnLogin" class="btn-full" style="background:var(--bg-body); border:1px solid #ddd; color:var(--text-main);" onclick="loginGoogle()">
                <i class="fab fa-google"></i> ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢ Google
            </button>
            <button id="btnLogout" class="btn-full hidden" style="background:#fee2e2; color:#dc2626;" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
            </button>
        </div>
        
        <div style="margin-bottom:20px;">
            <h4 style="margin:0 0 5px 0; font-size:0.9rem; color:var(--text-muted);">Gemini API Key</h4>
            <div style="display:flex; gap:10px;">
                <input id="apiKeyInput" type="password" class="modern-input" placeholder="AIza..." style="padding:10px;">
                <button class="btn-full" style="width:auto; margin:0; background:var(--primary); color:white;" onclick="saveApiKey()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
            <a href="https://aistudio.google.com/app/apikey" target="_blank" style="font-size:0.75rem; color:var(--primary); text-decoration:none;">üëâ ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏Ç‡∏≠‡∏Ñ‡∏µ‡∏¢‡πå‡∏ü‡∏£‡∏µ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</a>
        </div>

        <div style="margin-bottom:20px;">
            <h4 style="margin:0 0 10px 0; font-size:0.9rem; color:var(--text-muted);">‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•</h4>
            <div style="display:flex; gap:10px;">
                <button class="btn-mode" onclick="setDisplayMode('light')" id="btn-mode-light"><i class="fas fa-sun"></i> ‡∏™‡∏ß‡πà‡∏≤‡∏á</button>
                <button class="btn-mode" onclick="setDisplayMode('night')" id="btn-mode-night"><i class="fas fa-moon"></i> ‡∏°‡∏∑‡∏î</button>
                <button class="btn-mode" onclick="setDisplayMode('auto')" id="btn-mode-auto"><i class="fas fa-magic"></i> ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</button>
            </div>
        </div>

        <div style="margin-bottom:20px;">
            <h4 style="margin:0 0 10px 0; font-size:0.9rem; color:var(--text-muted);">‡∏™‡∏µ‡∏ò‡∏µ‡∏°‡πÅ‡∏≠‡∏õ</h4>
            <div class="color-grid">
                <div class="color-swatch" style="background:#5e72e4;" onclick="setTheme('#5e72e4')"></div>
                <div class="color-swatch" style="background:#2dce89;" onclick="setTheme('#2dce89')"></div>
                <div class="color-swatch" style="background:#fb6340;" onclick="setTheme('#fb6340')"></div>
                <div class="color-swatch" style="background:#f5365c;" onclick="setTheme('#f5365c')"></div>
                <div class="color-swatch" style="background:#11cdef;" onclick="setTheme('#11cdef')"></div>
            </div>
        </div>

        <div>
            <h4 style="margin:0 0 10px 0; font-size:0.9rem; color:var(--text-muted);">‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á</h4>
            <button class="btn-full" style="background:var(--primary-soft); color:var(--primary); margin-bottom:5px;" onclick="document.getElementById('bgInput').click()">
                <i class="fas fa-image"></i> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
            </button>
            <button class="btn-full" style="background:#f1f5f9; color:#64748b;" onclick="resetBackground()">
                <i class="fas fa-undo"></i> ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
            </button>
        </div>
    </div>
  </div>

  <!-- Firebase Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- YOUR FIREBASE CONFIG ---
    const YOUR_FIREBASE_CONFIG = {
      apiKey: "AIzaSyDUliKbJO1YyUNjZdBvkBULaWlEaBzmcAA",
      authDomain: "budget1-ed2f4.firebaseapp.com",
      projectId: "budget1-ed2f4",
      storageBucket: "budget1-ed2f4.firebasestorage.app",
      messagingSenderId: "312969765873",
      appId: "1:312969765873:web:db0e163fe587149963da50",
      measurementId: "G-FXT8WGFGKP"
    };

    let db, auth, userId, appId;
    let useCloud = false;

    async function initFirebase() {
        if (!YOUR_FIREBASE_CONFIG) return;
        try {
            const app = initializeApp(YOUR_FIREBASE_CONFIG);
            auth = getAuth(app);
            db = getFirestore(app);
            appId = 'budget-app';

            window.loginGoogle = async () => {
                try {
                    const provider = new GoogleAuthProvider();
                    await signInWithPopup(auth, provider);
                    window.closeModal('settingsModal');
                } catch(e) { alert("Login Failed: " + e.message); }
            };

            window.logout = async () => {
                await signOut(auth);
                window.location.reload();
            };

            onAuthStateChanged(auth, (user) => {
                const btnLogin = document.getElementById('sidebarBtnLogin');
                const btnLogout = document.getElementById('sidebarBtnLogout');
                const avatar = document.getElementById('mainAvatar');
                const role = document.getElementById('userRole');
                const syncBadge = document.getElementById('syncStatus');

                if (user) {
                    userId = user.uid;
                    useCloud = !user.isAnonymous;
                    
                    if (!user.isAnonymous) {
                        syncBadge.innerHTML = '<i class="fas fa-cloud"></i> Online';
                        syncBadge.style.background = '#dcfce7'; syncBadge.style.color = '#166534';
                        if(btnLogin) btnLogin.classList.add('hidden');
                        if(btnLogout) btnLogout.classList.remove('hidden');
                        if(user.photoURL) { avatar.src = user.photoURL; avatar.style.display = 'block'; }
                        role.innerText = user.displayName || "User";
                        startDataListener();
                    }
                } else {
                    useCloud = false;
                    syncBadge.innerHTML = '<i class="fas fa-wifi"></i> Offline';
                    if(btnLogin) btnLogin.classList.remove('hidden');
                    if(btnLogout) btnLogout.classList.add('hidden');
                    avatar.style.display = 'none';
                    role.innerText = "Personal Wallet";
                }
            });
        } catch (e) { console.log("Offline Mode"); }
    }

    function startDataListener() {
        if (!db || !userId) return;
        const docRef = doc(db, 'artifacts', appId, 'users', userId, 'budget_data', 'yearly');
        onSnapshot(docRef, (docSnap) => {
            if (docSnap.exists()) {
                const data = docSnap.data();
                if (data && data.monthlyData) {
                    // Update global data but don't force full re-render if user is editing
                    const isEditing = document.activeElement.tagName === 'INPUT';
                    window.monthlyData = data.monthlyData;
                    if(!isEditing) {
                        if(document.getElementById('view-home').classList.contains('active')) window.renderHome();
                        else window.renderMonthDetail();
                    }
                }
            } else {
                saveDataToCloud();
            }
        });
    }

    window.saveDataToCloud = async function() {
        if (useCloud && db && userId) {
            try {
                await setDoc(doc(db, 'artifacts', appId, 'users', userId, 'budget_data', 'yearly'), {
                    monthlyData: window.monthlyData,
                    lastUpdated: new Date().toISOString()
                });
            } catch (e) { console.error("Save Error", e); }
        }
    }

    initFirebase();
  </script>

  <!-- App Logic -->
  <script>
    const months = ["‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå", "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°", "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô", "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°", "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô", "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°", "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô", "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°", "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô", "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"];
    const categories = [
        {icon: 'üçî', label: '‡∏≠‡∏≤‡∏´‡∏≤‡∏£'}, {icon: 'üöó', label: '‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á'}, {icon: 'üè†', label: '‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å'},
        {icon: 'üõçÔ∏è', label: '‡∏ä‡πâ‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á'}, {icon: 'üíä', label: '‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û'}, {icon: 'üéâ', label: '‡∏ö‡∏±‡∏ô‡πÄ‡∏ó‡∏¥‡∏á'},
        {icon: 'üí°', label: '‡∏ö‡∏¥‡∏•‡∏ï‡πà‡∏≤‡∏á‡πÜ'}, {icon: 'üí∏', label: '‡∏•‡∏á‡∏ó‡∏∏‡∏ô'}
    ];

    // Data Init
    window.monthlyData = JSON.parse(localStorage.getItem('yearlyBudget_v1')) || months.map(() => ({ salary: 0, extra: 0, savings: 0, budget: 0, details: [] }));
    window.monthlyData = window.monthlyData.map(m => ({ ...m, savings: m.savings || 0, budget: m.budget || 0 }));
    
    // State
    window.currentMonthIndex = 0;

    // --- Init ---
    const savedTheme = localStorage.getItem('app_theme');
    if(savedTheme) document.documentElement.style.setProperty('--primary', savedTheme);
    const savedBg = localStorage.getItem('custom_bg');
    if(savedBg) document.body.style.backgroundImage = `url(${savedBg})`;
    
    const storedKey = localStorage.getItem('gemini_api_key') || "AIzaSyD-wO4EzjPsLNrXC0v8J4jqTunMKWMJRjw";
    if(document.getElementById('apiKeyInput')) document.getElementById('apiKeyInput').value = storedKey;

    // --- Core Logic ---
    function calculateStats(m) {
        const dInc = m.details.filter(d => d.type === 'income').reduce((s, d) => s + (Number(d.amount)||0), 0);
        const dExp = m.details.filter(d => d.type === 'expense').reduce((s, d) => s + (Number(d.amount)||0), 0);
        const totalInc = (Number(m.salary)||0) + (Number(m.extra)||0) + dInc;
        const totalExp = dExp;
        const balance = totalInc - totalExp;
        const freeBalance = balance - (Number(m.savings)||0);
        let progress = 0;
        if(m.budget > 0) progress = (totalExp / m.budget) * 100;
        return { totalInc, totalExp, balance, freeBalance, progress };
    }

    function animateValue(obj, start, end, duration) {
        if(!obj) return;
        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            obj.innerHTML = Math.floor(progress * (end - start) + start).toLocaleString();
            if (progress < 1) window.requestAnimationFrame(step);
        };
        window.requestAnimationFrame(step);
    }
    
    // Save function (Global)
    window.saveData = function() {
        localStorage.setItem('yearlyBudget_v1', JSON.stringify(window.monthlyData));
        // Add pending write flag or similar if needed for robustness, but simple logic:
        if(window.saveDataToCloud) window.saveDataToCloud();
    }

    // --- View: Home ---
    window.renderHome = function() {
        const list = document.getElementById('homeMonthList');
        if(!list) return;
        let html = '';
        let gInc = 0, gExp = 0, gSave = 0;
        const yearlyExpMap = {};

        window.monthlyData.forEach((m, idx) => {
            const stats = calculateStats(m);
            gInc += stats.totalInc; gExp += stats.totalExp; gSave += (Number(m.savings)||0);
            
            // Collect Top Expenses
            m.details.filter(d=>d.type==='expense').forEach(d => {
                let k = d.desc.trim() || '‡∏≠‡∏∑‡πà‡∏ô‡πÜ';
                yearlyExpMap[k] = (yearlyExpMap[k]||0) + Number(d.amount);
            });

            html += `
                <div class="month-summary-card" onclick="openMonth(${idx})">
                    <div class="m-left">
                        <div class="m-icon">${idx+1}</div>
                        <div class="m-info">
                            <h4>${months[idx]}</h4>
                            <span>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${stats.freeBalance.toLocaleString()}</span>
                        </div>
                    </div>
                    <div class="m-right">
                        <span class="m-bal" style="color:${stats.balance>=0?'var(--primary)':'var(--danger)'}">${stats.balance.toLocaleString()}</span>
                        <div style="width:60px; height:4px; background:#f1f5f9; border-radius:2px; margin-top:5px; margin-left:auto; overflow:hidden;">
                             <div style="height:100%; width:${Math.min(stats.progress, 100)}%; background:${stats.progress > 100 ? 'var(--danger)' : 'var(--success)'}"></div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        list.innerHTML = html;
        animateValue(document.getElementById('grandBalance'), 0, gInc - gExp, 800);
        document.getElementById('grandIncome').innerText = gInc.toLocaleString();
        document.getElementById('grandExpense').innerText = gExp.toLocaleString();
        document.getElementById('grandSavings').innerText = gSave.toLocaleString();
        
        // Render Top 5
        const top5 = Object.entries(yearlyExpMap).sort((a,b)=>b[1]-a[1]).slice(0,5);
        document.getElementById('yearTopExpList').innerHTML = top5.length ? top5.map(i=>`<span class="top-pill">${i[0]} ${i[1].toLocaleString()}</span>`).join('') : '<span style="color:#aaa; font-size:0.8rem;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>';
    }

    // --- View: Month Detail ---
    window.openMonth = function(idx) {
        window.currentMonthIndex = idx;
        switchView('month');
        renderMonthDetail();
    }

    window.renderMonthDetail = function() {
        const idx = window.currentMonthIndex;
        const m = window.monthlyData[idx];
        const stats = calculateStats(m);

        document.getElementById('detailMonthName').innerText = months[idx];
        document.getElementById('monthGrandBalance').innerText = stats.balance.toLocaleString();
        document.getElementById('monthGrandIncome').innerText = stats.totalInc.toLocaleString();
        document.getElementById('monthGrandExpense').innerText = stats.totalExp.toLocaleString();
        document.getElementById('monthGrandSavings').innerText = (Number(m.savings)||0).toLocaleString();
        
        // Progress Bar
        const progBar = document.getElementById('monthProgressBar');
        progBar.style.width = Math.min(stats.progress, 100) + '%';
        progBar.style.background = stats.progress > 100 ? 'var(--danger)' : 'var(--success)';
        document.getElementById('monthProgressText').innerText = m.budget > 0 ? `‡πÉ‡∏ä‡πâ‡πÑ‡∏õ ${Math.round(stats.progress)}% ‡∏Ç‡∏≠‡∏á‡∏á‡∏ö ${Number(m.budget).toLocaleString()}` : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì';

        // Inputs (Set value)
        document.getElementById('inpSalary').value = m.salary || '';
        document.getElementById('inpExtra').value = m.extra || '';
        document.getElementById('inpBudget').value = m.budget || '';
        document.getElementById('inpSavings').value = m.savings || '';

        // Copy Button logic
        const copyContainer = document.getElementById('copyPrevBtnContainer');
        if (idx > 0 && m.details.length === 0) {
            copyContainer.innerHTML = `<button class="btn-full" style="background:#f1f5f9; color:var(--primary); font-size:0.9rem;" onclick="copyFromPrev(${idx})"><i class="fas fa-copy"></i> ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô</button>`;
        } else {
            copyContainer.innerHTML = '';
        }

        // Category Picker
        const catScroll = document.getElementById('cat-scroll');
        catScroll.innerHTML = categories.map(c => 
            `<div class="cat-item" onclick="addWithIconCurrent('${c.icon} ${c.label}')">
                <button class="cat-btn">${c.icon}</button>
                <span class="cat-label">${c.label}</span>
            </div>`
        ).join('');

        // Details List
        const list = document.getElementById('monthDetailList');
        list.innerHTML = m.details.map((d, dIdx) => {
            const isInc = d.type === 'income';
            return `
              <div class="detail-row">
                <div class="type-badge ${isInc?'badge-inc':'badge-exp'}" onclick="toggleDetailTypeCurrent(${dIdx})">
                    ${isInc?'+':'-'}
                </div>
                <input class="desc-input" type="text" placeholder="‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£..." value="${d.desc}" oninput="updateDetailCurrent(${dIdx}, 'desc', this.value)">
                <div class="detail-divider"></div>
                <input class="amt-input" type="number" placeholder="0" value="${d.amount}" oninput="updateDetailCurrent(${dIdx}, 'amount', this.value)">
                <i class="fas fa-times" style="color:#e2e8f0; cursor:pointer;" onclick="removeDetailCurrent(${dIdx})"></i>
              </div>
            `;
        }).join('');
    }

    // --- Actions (Scoped to Current Month) ---
    // Optimization: Don't re-render entire view on input change, just save data
    window.updateCurrentMonthBase = (field, val) => {
        window.monthlyData[window.currentMonthIndex][field] = Number(val);
        window.saveData(); 
        // Update stats locally for immediate feedback
        const stats = calculateStats(window.monthlyData[window.currentMonthIndex]);
        document.getElementById('monthGrandBalance').innerText = stats.balance.toLocaleString();
        document.getElementById('monthGrandIncome').innerText = stats.totalInc.toLocaleString();
        document.getElementById('monthGrandExpense').innerText = stats.totalExp.toLocaleString();
        // Progress bar logic
        const progBar = document.getElementById('monthProgressBar');
        if(progBar) {
             progBar.style.width = Math.min(stats.progress, 100) + '%';
             progBar.style.background = stats.progress > 100 ? 'var(--danger)' : 'var(--success)';
        }
    }
    
    window.updateDetailCurrent = (dIdx, field, val) => {
        const m = window.monthlyData[window.currentMonthIndex];
        m.details[dIdx][field] = field==='amount' ? Number(val) : val;
        window.saveData();
        // Optional: Update total stats here too if needed
    }
    
    window.addDetailCurrent = (type) => {
        window.monthlyData[window.currentMonthIndex].details.push({ type, desc: '', amount: '' });
        window.saveData(); renderMonthDetail();
    }
    
    window.addWithIconCurrent = (icon) => {
        window.monthlyData[window.currentMonthIndex].details.push({ type: 'expense', desc: icon + ' ', amount: '' });
        window.saveData(); renderMonthDetail();
    }

    window.toggleDetailTypeCurrent = (dIdx) => {
        const d = window.monthlyData[window.currentMonthIndex].details[dIdx];
        d.type = d.type === 'income' ? 'expense' : 'income';
        window.saveData(); renderMonthDetail();
    }

    window.removeDetailCurrent = (dIdx) => {
        window.monthlyData[window.currentMonthIndex].details.splice(dIdx, 1);
        window.saveData(); renderMonthDetail();
    }

    window.copyFromPrev = (idx) => {
        const prev = window.monthlyData[idx-1];
        if(prev && prev.details.length > 0) {
            const newDetails = prev.details.map(d => ({...d}));
            window.monthlyData[idx].details = [...window.monthlyData[idx].details, ...newDetails];
            window.saveData(); renderMonthDetail();
        }
    }
    
    window.triggerScanCurrent = () => { document.getElementById('receiptInput').click(); }

    // --- Nav ---
    window.switchView = (viewName) => {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        
        if (viewName === 'home') {
            document.getElementById('view-home').classList.add('active');
            document.querySelector('.nav-item:nth-child(1)').classList.add('active');
            renderHome();
        } else if (viewName === 'month') {
            document.getElementById('view-month').classList.add('active');
        }
        window.scrollTo({top:0, behavior:'smooth'});
    }

    // --- Handlers & Utils ---
    window.handleReceiptScan = async (input) => {
        const key = localStorage.getItem('gemini_api_key') || "AIzaSyD-wO4EzjPsLNrXC0v8J4jqTunMKWMJRjw";
        if(!input.files[0]) return;
        
        document.getElementById('loadingOverlay').style.display='flex';
        const r = new FileReader();
        r.onload = async (e) => {
            try {
                const b64 = e.target.result.split(',')[1];
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`, {
                    method:'POST', headers:{'Content-Type':'application/json'},
                    body:JSON.stringify({contents:[{role:"user", parts:[{text:"Extract: {\"desc\":\"str\",\"amount\":num,\"type\":\"expense\"}"},{inlineData:{mimeType:"image/jpeg",data:b64}}]}]})
                });
                const d = await res.json();
                const json = JSON.parse(d.candidates[0].content.parts[0].text.replace(/```json/g,'').replace(/```/g,'').trim());
                if(json.amount) {
                    window.monthlyData[window.currentMonthIndex].details.push({type:json.type, desc:json.desc, amount:json.amount});
                    saveData(); renderMonthDetail();
                }
            } catch(e) { alert("Scan Failed"); }
            finally { document.getElementById('loadingOverlay').style.display='none'; input.value=''; }
        };
        r.readAsDataURL(input.files[0]);
    }
    
    // Theme & Mode
    function saveApiKey() { localStorage.setItem('gemini_api_key', document.getElementById('apiKeyInput').value); alert("Saved"); }
    function setDisplayMode(mode) { localStorage.setItem('display_mode', mode); applyThemeMode(); }
    function applyThemeMode() {
        const mode = localStorage.getItem('display_mode') || 'auto';
        const isNight = mode === 'auto' ? (new Date().getHours()>=18 || new Date().getHours()<6) : mode==='night';
        document.body.classList.toggle('night', isNight);
    }
    applyThemeMode();
    function setTheme(c) { document.documentElement.style.setProperty('--primary', c); document.documentElement.style.setProperty('--primary-soft', c+'20'); }

    // Modals
    window.openChartModal = () => { document.getElementById('chartModal').classList.add('show'); renderChart('bar'); }
    window.openToolsModal = () => document.getElementById('toolsModal').classList.add('show');
    window.openSettingsModal = () => document.getElementById('settingsModal').classList.add('show');
    window.closeModal = (id) => document.getElementById(id).classList.remove('show');
    window.toggleMenu = () => { document.getElementById('sideMenu').classList.toggle('active'); document.getElementById('menuOverlay').classList.toggle('active'); }
    
    // AI
    window.analyzeBudgetWithAI = async () => {
        const key = localStorage.getItem('gemini_api_key') || "AIzaSyD-wO4EzjPsLNrXC0v8J4jqTunMKWMJRjw";
        document.getElementById('loadingOverlay').style.display='flex';
        try {
            const sum = window.monthlyData.map((m,i)=>`${months[i]}: In=${calculateStats(m).totalInc}, Out=${calculateStats(m).totalExp}`).join('\n');
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`, {
                method:'POST', headers:{'Content-Type':'application/json'},
                body:JSON.stringify({contents:[{parts:[{text:`Analyze: \n${sum}\nGive 3 quick tips in Thai markdown.`}]}]})
            });
            const d = await res.json();
            document.getElementById('aiContent').innerHTML = marked.parse(d.candidates[0].content.parts[0].text);
            document.getElementById('aiModal').classList.add('show');
        } catch(e) { alert("API Error"); }
        finally { document.getElementById('loadingOverlay').style.display='none'; }
    }

    // Chart
    let myChart = null;
    window.renderChart = (type) => {
        const ctx = document.getElementById('chart').getContext('2d');
        if(myChart) myChart.destroy();
        const labels = months;
        let datasets = [];
        if (type === 'pie') {
            const expMap = {};
            window.monthlyData.forEach(m => m.details.filter(d=>d.type==='expense').forEach(d => { let k=d.desc.trim()||'‡∏≠‡∏∑‡πà‡∏ô‡πÜ'; expMap[k]=(expMap[k]||0)+Number(d.amount); }));
            const sorted = Object.entries(expMap).sort((a,b)=>b[1]-a[1]);
            const pLabels = [], pData = [];
            sorted.forEach((item,i) => { if(i<8){pLabels.push(item[0]); pData.push(item[1])} });
            myChart = new Chart(ctx, { type: 'doughnut', data: { labels: pLabels, datasets: [{ data: pData, borderWidth: 0, backgroundColor: ['#f5365c', '#fb6340', '#ffd600', '#2dce89', '#11cdef', '#5e72e4'] }] }, options: { responsive:true, maintainAspectRatio:false } });
        } else {
            const dInc = window.monthlyData.map(m=>calculateStats(m).totalInc);
            const dExp = window.monthlyData.map(m=>calculateStats(m).totalExp);
            const dSave = window.monthlyData.map(m=>Number(m.savings)||0);
            if(type === 'line') {
                myChart = new Chart(ctx, { type: 'line', data: { labels, datasets: [{label:'‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°', data:dSave, borderColor:'#11cdef', backgroundColor:'rgba(17,205,239,0.2)', fill:true}] }, options: { responsive:true, maintainAspectRatio:false } });
            } else {
                myChart = new Chart(ctx, { type: 'bar', data: { labels, datasets: [{label:'‡∏£‡∏±‡∏ö', data:dInc, backgroundColor:'#2dce89'},{label:'‡∏à‡πà‡∏≤‡∏¢', data:dExp, backgroundColor:'#f5365c'}] }, options: { responsive:true, maintainAspectRatio:false, scales:{x:{grid:{display:false}}} } });
            }
        }
    }

    // JSON/Excel
    window.exportJSON = () => {
        const a = document.createElement('a');
        a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(window.monthlyData));
        a.download = "budget_backup.json"; a.click();
    }
    window.importJSON = (input) => {
        const r = new FileReader();
        r.onload = (e) => { window.monthlyData = JSON.parse(e.target.result); saveData(); renderHome(); alert("Restore Success"); };
        r.readAsText(input.files[0]);
    }
    window.exportToExcel = () => {
       let csv = "\uFEFF‡πÄ‡∏î‡∏∑‡∏≠‡∏ô,‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó,‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£,‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô\n";
       window.monthlyData.forEach((m, idx) => {
         if(m.salary) csv += `${months[idx]},‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö,‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô,${m.salary}\n`;
         if(m.extra) csv += `${months[idx]},‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö,‡∏û‡∏¥‡πÄ‡∏®‡∏©,${m.extra}\n`;
         if(m.savings) csv += `${months[idx]},‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°,‡∏à‡∏±‡∏î‡∏™‡∏£‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°,${m.savings}\n`;
         m.details.forEach(d => csv += `${months[idx]},${d.type==='income'?'‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö':'‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢'},${d.desc},${d.amount}\n`);
       });
       const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv;charset=utf-8;' }));
       a.download = "Budget_Yearly.csv"; document.body.appendChild(a); a.click(); a.remove();
    }
    
    window.clearData = () => {
        if(confirm('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')) {
            window.monthlyData = months.map(() => ({ salary: 0, extra: 0, savings: 0, budget: 0, details: [] }));
            saveData(); renderHome();
        }
    }

    // Init
    renderHome();
  </script>
</body>
</html>
