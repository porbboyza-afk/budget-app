<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</title>
  
  <!-- PWA Manifest & iOS Support -->
  <link rel="manifest" href="data:application/manifest+json;charset=utf-8,%7B%22name%22%3A%22%E0%B8%81%E0%B8%B2%E0%B8%A3%E0%B9%80%E0%B8%87%E0%B8%B4%E0%B8%99%E0%B8%82%E0%B8%AD%E0%B8%87%E0%B8%89%E0%B8%B1%E0%B8%99%22%2C%22short_name%22%3A%22MyBudget%22%2C%22start_url%22%3A%22.%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%23f8f9fe%22%2C%22theme_color%22%3A%22%235e72e4%22%2C%22icons%22%3A%5B%7B%22src%22%3A%22https%3A%2F%2Fcdn-icons-png.flaticon.com%2F512%2F2344%2F2344147.png%22%2C%22sizes%22%3A%22512x512%22%2C%22type%22%3A%22image%2Fpng%22%7D%5D%7D" />
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#5e72e4">

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&family=Sarabun:wght@300;400;500;600&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --primary: #5e72e4;
      --primary-soft: #eaecfb;
      --success: #2dce89;
      --success-soft: #e0fbf4;
      --danger: #f5365c;
      --danger-soft: #fee6ea;
      --warning: #fb6340;
      --info: #11cdef;
      --info-soft: #e0f7fa;
      --text-main: #32325d;
      --text-muted: #8898aa;
      --bg-body: #f8f9fe;
      --bg-card: #ffffff;
      --radius: 20px;
      --radius-sm: 12px;
      --bottom-nav-height: 70px;
      --shadow-soft: 0 7px 14px rgba(50, 50, 93, 0.1), 0 3px 6px rgba(0, 0, 0, 0.08);
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
      font-family: 'Prompt', 'Sarabun', sans-serif;
      margin: 0; padding: 0; min-height: 100vh;
      color: var(--text-main); background: var(--bg-body);
      padding-bottom: calc(var(--bottom-nav-height) + 20px);
      transition: background 0.3s, color 0.3s;
      overscroll-behavior-y: none;
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
    }
    
    body.night {
        --text-main: #e2e8f0; --text-muted: #94a3b8;
        --bg-body: #0f172a; --bg-card: #1e293b;
        --primary-soft: rgba(94, 114, 228, 0.15); 
        --success-soft: rgba(45, 206, 137, 0.15);
        --danger-soft: rgba(245, 54, 92, 0.15); 
        --info-soft: rgba(17, 205, 239, 0.15);
        --warning-soft: rgba(251, 99, 64, 0.15);
    }

    .main-container { max-width: 600px; margin: 0 auto; width: 100%; padding: 20px; }
    .view-section { display: none; animation: fadeIn 0.3s ease; }
    .view-section.active { display: block; }

    /* Dashboard */
    .dashboard {
      background: var(--bg-card); border-radius: var(--radius); padding: 24px;
      box-shadow: var(--shadow-soft); margin-bottom: 25px; position: relative; overflow: hidden;
      border: 1px solid rgba(255,255,255,0.5);
    }
    .night .dashboard { border-color: rgba(255,255,255,0.05); }
    .dashboard::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 6px; background: linear-gradient(90deg, var(--primary), var(--info)); }
    .dash-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; }
    .user-profile-header { display: flex; align-items: center; gap: 12px; }
    .main-avatar { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; border: 2px solid var(--bg-card); display: none; }
    
    .balance-container { text-align: center; margin-bottom: 25px; padding: 10px 0; }
    .balance-label { font-size: 0.9rem; color: var(--text-muted); margin-bottom: 5px; font-weight: 500; }
    .balance-amount { font-size: 2.8rem; font-weight: 700; letter-spacing: -1px; line-height: 1; transition: color 0.3s; }
    .stats-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; background: var(--primary-soft); padding: 15px; border-radius: var(--radius-sm); margin-top: 10px; }
    .stat-item { text-align: center; }
    .stat-label { font-size: 0.75rem; color: var(--text-muted); display: block; margin-bottom: 4px; }
    .stat-val { font-size: 1rem; font-weight: 600; white-space: nowrap; }

    /* Summary Cards */
    .month-summary-card {
        background: var(--bg-card); border-radius: var(--radius); margin-bottom: 15px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.05);
        padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;
        cursor: pointer; transition: transform 0.2s;
    }
    .month-summary-card:active { transform: scale(0.98); }
    .m-left { display: flex; align-items: center; gap: 15px; }
    .m-icon { width: 45px; height: 45px; background: var(--primary-soft); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: var(--primary); font-size: 1.2rem; }
    .m-info h4 { margin: 0; font-size: 1rem; font-weight: 600; }
    .m-right { text-align: right; }
    .m-bal { font-weight: 700; font-size: 1rem; display: block; }

    /* Nav Header */
    .nav-header { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }
    .btn-back { width: 40px; height: 40px; border-radius: 12px; background: var(--bg-card); border: none; box-shadow: var(--shadow-soft); display: flex; align-items: center; justify-content: center; color: var(--text-main); cursor: pointer; }
    .page-title { margin: 0; font-size: 1.5rem; font-weight: 700; }

    /* Inputs */
    .input-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
    .modern-input { width: 100%; padding: 12px 15px; border-radius: var(--radius-sm); border: 1px solid #e2e8f0; background: #fff; font-size: 1rem; font-family: 'Sarabun'; color: var(--text-main); transition: border-color 0.2s; }
    .night .modern-input { background: #1e293b; border-color: #334155; }
    .modern-input:focus { border-color: var(--primary); outline: none; }
    .modern-input-group label { font-size: 0.75rem; color: var(--text-muted); margin-bottom: 5px; display: block; font-weight: 600; }

    /* Categories */
    .category-picker-container { position: relative; display: flex; align-items: center; margin-bottom: 15px; }
    .category-scroll { display: flex; gap: 12px; overflow-x: auto; padding: 10px 5px; scrollbar-width: none; flex: 1; scroll-behavior: smooth; }
    .cat-item { display: flex; flex-direction: column; align-items: center; gap: 5px; flex: none; width: 60px; cursor: pointer; }
    .cat-btn { width: 48px; height: 48px; border-radius: 50%; border: none; background: var(--bg-card); display: flex; align-items: center; justify-content: center; font-size: 1.4rem; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .cat-label { font-size: 0.75rem; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; text-align: center; }
    .cat-nav-btn { background: var(--bg-card); border: none; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); z-index: 2; flex-shrink: 0; }
    .night .cat-nav-btn, .night .cat-btn { background: #334155; }

    /* Action Buttons */
    .action-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 20px; }
    .action-btn { padding: 12px; border: none; border-radius: 50px; font-weight: 600; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.15); height: 60px; }
    .btn-inc { background: linear-gradient(135deg, #2dce89, #2dcecc); }
    .btn-exp { background: linear-gradient(135deg, #f5365c, #f56636); }
    .btn-scan { background: linear-gradient(135deg, #5e72e4, #825ee4); }

    /* Detail List */
    .detail-container { margin-top: 20px; background: var(--bg-card); border-radius: var(--radius); padding: 15px; box-shadow: var(--shadow-soft); }
    .detail-row { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid rgba(0,0,0,0.05); }
    .detail-row:last-child { margin-bottom: 0; border-bottom: none; }
    .type-badge { width: 30px; height: 30px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: bold; cursor: pointer; flex-shrink: 0; }
    .badge-inc { background: var(--success-soft); color: var(--success); }
    .badge-exp { background: var(--danger-soft); color: var(--danger); }
    .desc-input { flex: 1; min-width: 0; border: none; background: transparent; color: var(--text-main); font-size: 0.95rem; }
    .amt-input { width: 70px; flex-shrink: 0; border: none; background: transparent; text-align: right; font-weight: 600; color: var(--text-main); font-size: 0.95rem; }
    .detail-divider { width: 1px; height: 24px; background: #e2e8f0; margin: 0 4px; }
    .night .detail-divider { background: #334155; }

    /* Bottom Nav */
    .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: var(--bottom-nav-height); background: var(--bg-card); box-shadow: 0 -5px 20px rgba(0,0,0,0.05); display: flex; justify-content: space-around; align-items: center; z-index: 1000; border-top-left-radius: 20px; border-top-right-radius: 20px; padding-bottom: env(safe-area-inset-bottom); }
    .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; color: var(--text-muted); cursor: pointer; width: 20%; }
    .nav-item i { font-size: 1.3rem; }
    .nav-item span { font-size: 0.7rem; font-weight: 500; }
    .nav-item.active { color: var(--primary); }

    /* Portfolio Widget */
    .savings-portfolio { margin-top: 15px; display: flex; gap: 15px; align-items: center; }
    .sp-chart-container { width: 80px; height: 80px; flex-shrink: 0; }
    .sp-list { flex: 1; display: flex; flex-direction: column; gap: 5px; }
    .sp-item { display: flex; justify-content: space-between; font-size: 0.8rem; }
    .sp-color { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 5px; }

    /* Loader Robot */
    .loading { position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 2000; display: none; align-items: center; justify-content: center; flex-direction: column; }
    .night .loading { background: rgba(15,23,42,0.9); }
    .ai-loader-icon { font-size: 5rem; color: var(--primary); margin-bottom: 10px; animation: pulse 1.5s infinite; }
    @keyframes pulse { 0%, 100% { transform: scale(0.95); opacity: 0.7; } 50% { transform: scale(1.1); opacity: 1; } }

    /* Modals */
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 2000; align-items: center; justify-content: center; padding: 20px; }
    .modal.show { display: flex; }
    .modal-card { background: var(--bg-card); width: 100%; max-width: 500px; border-radius: 24px; padding: 25px; position: relative; box-shadow: 0 20px 50px rgba(0,0,0,0.3); max-height: 85vh; overflow-y: auto; }
    .chart-container-wrapper { position: relative; height: 45vh; width: 100%; }
    .top-expenses-widget { margin-top: 20px; padding-top: 15px; border-top: 1px dashed rgba(0,0,0,0.1); }
    .top-pill { display: inline-flex; align-items: center; gap: 6px; background: var(--danger-soft); padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; color: var(--danger); margin-right: 5px; margin-bottom: 5px; font-weight: 500; white-space: nowrap; }
    .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    .hide-scrollbar::-webkit-scrollbar { display: none; }
    .scroll-wrapper { display: flex; align-items: center; position: relative; }
    .scroll-btn { background: var(--bg-card); border: 1px solid rgba(0,0,0,0.05); width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text-muted); font-size: 0.8rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); z-index: 2; flex-shrink: 0; }
    
    /* New Rounded Button Styles */
    .btn-rounded-pill { padding: 8px 16px; border-radius: 50px; border: none; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 6px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .btn-rounded-pill:active { transform: translateY(1px); box-shadow: none; }
    .btn-del-modern { width: 30px; height: 30px; border-radius: 50%; border: none; background: var(--danger-soft); color: var(--danger); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; }
    .btn-del-modern:hover { background: var(--danger); color: white; }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body id="mainBody">

  <!-- ================= VIEW: HOME ================= -->
  <div id="view-home" class="view-section active">
      <div class="main-container">
          <div class="dashboard">
              <div class="dash-header">
                  <div class="user-profile-header">
                      <img id="mainAvatar" class="main-avatar" src="" alt="Me">
                      <div class="user-info">
                          <h2 style="margin:0; font-size:1.2rem;">‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h2>
                          <div id="userRole" style="font-size:0.8rem; color:var(--text-muted);">Personal Wallet</div>
                      </div>
                  </div>
                  <div id="syncStatus" style="font-size:0.75rem; padding:4px 10px; border-radius:20px; background:#e2e8f0; color:#64748b;">
                      <i class="fas fa-wifi"></i> Offline
                  </div>
              </div>
              
              <div class="balance-container">
                  <div class="balance-label">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ (<span id="currMonthName">...</span>)</div>
                  <div class="balance-amount" id="currentMonthBalance">0</div>
                  <div style="font-size:0.85rem; color:var(--text-muted); margin-top:5px;">
                      ‡∏¢‡∏≠‡∏î‡∏™‡∏∞‡∏™‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏õ‡∏µ: <span id="grandBalance" style="font-weight:600;">0</span>
                  </div>
              </div>

              <div class="stats-row">
                  <div class="stat-item"><span class="stat-label">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö (‡∏î.)</span><span class="stat-val" style="color:var(--success)" id="dashIncome">0</span></div>
                  <div class="stat-item"><span class="stat-label">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ (‡∏î.)</span><span class="stat-val" style="color:var(--danger)" id="dashExpense">0</span></div>
                  <div class="stat-item" style="border-left:1px solid rgba(0,0,0,0.1)"><span class="stat-label">‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏° (‡∏î.)</span><span class="stat-val" style="color:var(--info)" id="dashSavings">0</span></div>
              </div>
              
              <div class="top-expenses-widget">
                  <div style="font-size:0.8rem; font-weight:600; color:var(--info); margin-bottom:8px;"><i class="fas fa-chart-pie"></i> ‡∏û‡∏≠‡∏£‡πå‡∏ï‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏° (‡∏õ‡∏µ)</div>
                  <div class="savings-portfolio">
                      <div class="sp-chart-container"><canvas id="savingsDoughnut"></canvas></div>
                      <div id="savingsLegend" class="sp-list"></div>
                  </div>
              </div>

              <div class="top-expenses-widget">
                  <div style="font-size:0.8rem; font-weight:600; color:var(--warning); margin-bottom:8px;"><i class="fas fa-trophy"></i> ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏õ‡∏µ‡∏ô‡∏µ‡πâ</div>
                  <div class="scroll-wrapper">
                      <button class="scroll-btn left" onclick="window.scrollContainer('yearTopExpList', -100)"><i class="fas fa-chevron-left"></i></button>
                      <div id="yearTopExpList" class="hide-scrollbar" style="overflow-x: auto; flex: 1; padding-bottom: 5px; white-space: nowrap;"></div>
                      <button class="scroll-btn right" onclick="window.scrollContainer('yearTopExpList', 100)"><i class="fas fa-chevron-right"></i></button>
                  </div>
              </div>
          </div>
          <div id="homeMonthList"></div>
      </div>
  </div>

  <!-- ================= VIEW: MONTH DETAIL ================= -->
  <div id="view-month" class="view-section">
      <div class="main-container">
          <div class="nav-header">
              <button class="btn-back" onclick="switchView('home')"><i class="fas fa-chevron-left"></i></button>
              <h2 class="page-title" id="detailMonthName">‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°</h2>
          </div>

          <div class="dashboard">
              <div class="balance-container" style="margin-bottom:15px; padding:0;">
                  <div class="balance-label">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡∏à‡∏£‡∏¥‡∏á (‡∏´‡∏±‡∏Å‡∏≠‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß)</div>
                  <div class="balance-amount" id="monthGrandBalance">0</div>
                  <div style="width:100%; height:6px; background:#f1f5f9; border-radius:3px; margin-top:10px; overflow:hidden;">
                      <div id="monthProgressBar" style="height:100%; width:0%; background:var(--success); transition:width 0.5s;"></div>
                  </div>
              </div>
              <div class="stats-row">
                  <div class="stat-item"><span class="stat-label">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</span><span class="stat-val" style="color:var(--success)" id="monthGrandIncome">0</span></div>
                  <div class="stat-item"><span class="stat-label">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</span><span class="stat-val" style="color:var(--danger)" id="monthGrandExpense">0</span></div>
                  <div class="stat-item" style="border-left:1px solid rgba(0,0,0,0.1)"><span class="stat-label">‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°</span><span class="stat-val" style="color:var(--info)" id="monthGrandSavings">0</span></div>
              </div>
              <div class="top-expenses-widget">
                  <div style="font-size:0.8rem; font-weight:600; color:var(--info); margin-bottom:8px;"><i class="fas fa-chart-pie"></i> ‡∏û‡∏≠‡∏£‡πå‡∏ï‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏° (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</div>
                  <div class="savings-portfolio">
                      <div class="sp-chart-container"><canvas id="monthSavingsDoughnut"></canvas></div>
                      <div id="monthSavingsLegend" class="sp-list"></div>
                  </div>
              </div>
          </div>

          <div style="background:var(--bg-card); border-radius:var(--radius); padding:20px; box-shadow:var(--shadow-soft); margin-bottom:20px;">
              <h4 style="margin:0 0 15px 0;">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏õ‡∏£‡∏∞‡∏à‡∏≥</h4>
              <div class="modern-input-group"><label>‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label><input class="modern-input" type="number" id="inpSalary" placeholder="0" oninput="updateCurrentMonthBase('salary', this.value)"></div>
              <div id="copyPrevBtnContainer" style="margin-top:10px;"></div>
          </div>
          
          <div style="background:var(--bg-card); border-radius:var(--radius); padding:20px; box-shadow:var(--shadow-soft); margin-bottom:20px; border:1px solid var(--success-soft);">
              <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                  <h4 style="margin:0; color:var(--success);">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏û‡∏¥‡πÄ‡∏®‡∏©</h4>
                  <button class="btn-rounded-pill" style="background:var(--success); color:white;" onclick="addExtraIncomeItem()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
              </div>
              <div class="category-scroll" style="margin-bottom:10px;">
                  <div class="cat-item" onclick="addWithIconExtra('‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à')"><button class="cat-btn">üè¢</button><span class="cat-label">‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à</span></div>
                  <div class="cat-item" onclick="addWithIconExtra('‡∏Ç‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á')"><button class="cat-btn">üõçÔ∏è</button><span class="cat-label">‡∏Ç‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á</span></div>
                  <div class="cat-item" onclick="addWithIconExtra('‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß')"><button class="cat-btn">üë®‚Äçüë©‚Äçüëß</button><span class="cat-label">‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß</span></div>
                  <div class="cat-item" onclick="addWithIconExtra('‡∏ü‡∏£‡∏µ‡πÅ‡∏•‡∏ô‡∏ã‡πå')"><button class="cat-btn">üíª</button><span class="cat-label">‡∏ü‡∏£‡∏µ‡πÅ‡∏•‡∏ô‡∏ã‡πå</span></div>
              </div>
              <div id="extraIncomeList"></div>
          </div>

          <div style="background:var(--bg-card); border-radius:var(--radius); padding:20px; box-shadow:var(--shadow-soft); margin-bottom:20px; border:1px solid var(--info-soft);">
              <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                  <h4 style="margin:0; color:var(--info);">‡∏à‡∏±‡∏î‡∏™‡∏£‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°</h4>
                  <button class="btn-rounded-pill" style="background:var(--info); color:white;" onclick="addSavingItemCurrent()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
              </div>
              <div class="category-scroll" style="margin-bottom:10px;">
                  <div class="cat-item" onclick="addWithIconSavings('‡∏•‡∏á‡∏ó‡∏∏‡∏ô')"><button class="cat-btn">üíπ</button><span class="cat-label">‡∏•‡∏á‡∏ó‡∏∏‡∏ô</span></div>
                  <div class="cat-item" onclick="addWithIconSavings('‡∏™‡∏≥‡∏£‡∏≠‡∏á')"><button class="cat-btn">üöë</button><span class="cat-label">‡∏™‡∏≥‡∏£‡∏≠‡∏á</span></div>
                  <div class="cat-item" onclick="addWithIconSavings('‡πÄ‡∏Å‡∏©‡∏µ‡∏¢‡∏ì')"><button class="cat-btn">üë¥</button><span class="cat-label">‡πÄ‡∏Å‡∏©‡∏µ‡∏¢‡∏ì</span></div>
              </div>
              <div id="savingsDetailList"></div>
          </div>

          <div style="margin-bottom:20px;">
              <h4 style="margin:0 0 10px 0;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</h4>
              <div class="category-picker-container">
                  <div class="cat-nav-btn" onclick="document.getElementById('cat-scroll').scrollLeft -= 50"><i class="fas fa-chevron-left"></i></div>
                  <div id="cat-scroll" class="category-scroll"></div> 
                  <div class="cat-nav-btn" onclick="document.getElementById('cat-scroll').scrollLeft += 50"><i class="fas fa-chevron-right"></i></div>
              </div>
              <div class="detail-container" id="monthDetailList"></div>
          </div>
          
          <div class="action-row" style="margin-bottom:20px;">
            <button class="action-btn btn-inc" onclick="addDetailCurrent('income')"><i class="fas fa-plus"></i> <span>‡∏£‡∏±‡∏ö</span></button>
            <button class="action-btn btn-exp" onclick="addDetailCurrent('expense')"><i class="fas fa-minus"></i> <span>‡∏à‡πà‡∏≤‡∏¢</span></button>
            <button class="action-btn btn-scan" onclick="triggerScanCurrent()"><i class="fas fa-camera"></i> <span>‡∏™‡πÅ‡∏Å‡∏ô</span></button>
          </div>
      </div>
  </div>

  <!-- Bottom Nav -->
  <div class="bottom-nav">
      <div class="nav-item active" onclick="switchView('home')"><i class="fas fa-home"></i><span>‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</span></div>
      <div class="nav-item" onclick="openChartModal()"><i class="fas fa-chart-pie"></i><span>‡∏Å‡∏£‡∏≤‡∏ü</span></div>
      <div class="nav-item" onclick="analyzeBudgetWithAI()"><i class="fas fa-robot"></i><span>AI</span></div>
      <div class="nav-item" onclick="openToolsModal()"><i class="fas fa-tools"></i><span>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠</span></div>
      <div class="nav-item" onclick="openSettingsModal()"><i class="fas fa-cog"></i><span>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</span></div>
  </div>

  <input type="file" id="receiptInput" accept="image/*" style="display: none;">
  <input type="file" id="restoreInput" accept="application/json" style="display: none;" onchange="importJSON(this)">
  <input type="file" id="bgInput" accept="image/*" style="display: none;" onchange="window.handleBgChange(this)">

  <!-- AI Loader -->
  <div class="loading" id="loadingOverlay">
    <i class="fas fa-robot ai-loader-icon"></i>
    <p style="font-weight:500; color:var(--text-muted);">AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏¥‡∏î...</p>
  </div>

  <!-- Shared Modals -->
  <div class="modal" id="chartModal"><div class="modal-card"><span style="position:absolute; top:15px; right:20px; font-size:1.5rem; cursor:pointer;" onclick="closeModal('chartModal')">&times;</span><h3>‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏õ‡∏µ</h3><div class="chart-container-wrapper"><canvas id="chart"></canvas></div></div></div>
  <div class="modal" id="aiModal"><div class="modal-card"><span style="position:absolute; top:15px; right:20px; font-size:1.5rem; cursor:pointer;" onclick="closeModal('aiModal')">&times;</span><h3 style="color:var(--primary);"><i class="fas fa-robot"></i> AI Coach</h3><div id="aiContent" style="line-height:1.7;"></div></div></div>
  <div class="modal" id="toolsModal"><div class="modal-card"><h3>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠</h3><button class="btn-full" style="background:#d1fae5; color:#065f46; padding:12px; border:none; border-radius:12px; width:100%; margin-bottom:10px;" onclick="exportToExcel()">Excel</button><button class="btn-full" style="background:#f1f5f9; padding:12px; border:none; border-radius:12px; width:100%; margin-bottom:10px;" onclick="exportJSON()">Backup</button><button class="btn-full" style="background:#fee2e2; color:#dc2626; padding:12px; border:none; border-radius:12px; width:100%;" onclick="openClearModal()">‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button><button class="btn-full" style="margin-top:10px; background:transparent; border:none; color:#888;" onclick="closeModal('toolsModal')">‡∏õ‡∏¥‡∏î</button></div></div>
  <div class="modal" id="settingsModal">
    <div class="modal-card">
        <span style="position:absolute; top:15px; right:20px; font-size:1.5rem; cursor:pointer;" onclick="closeModal('settingsModal')">&times;</span>
        <h3>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</h3>
        <div id="authSection" style="margin-bottom:20px;">
            <button id="btnLogin" class="btn-full" style="width:100%; padding:12px; border-radius:12px; border:1px solid #ddd; background:#fff;" onclick="loginGoogle()">Google Login</button>
            <button id="btnLogout" class="btn-full hidden" style="width:100%; padding:12px; border-radius:12px; border:none; background:#fee2e2; color:#dc2626;" onclick="logout()">Logout</button>
        </div>
        <div>
            <h4 style="margin-bottom:5px;">Gemini API Key</h4>
            <div style="display:flex; gap:10px; margin-bottom: 10px;">
                <input id="apiKeyInput" type="password" class="modern-input" placeholder="AIza...">
                <button onclick="saveApiKey()" style="padding:10px; border-radius:12px; background:var(--primary); color:#fff; border:none;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
            <a href="https://aistudio.google.com/app/apikey" target="_blank" style="font-size:0.75rem; color:var(--primary); text-decoration:none;">üëâ ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏Ç‡∏≠‡∏Ñ‡∏µ‡∏¢‡πå‡∏ü‡∏£‡∏µ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</a>
        </div>
        <div style="margin-top:20px;">
            <h4>‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•</h4>
            <div style="display:flex; gap:10px; margin-bottom: 15px;">
                <button onclick="window.setDisplayMode('light')" style="flex:1; padding:10px; border-radius:12px; border:1px solid #ddd;">‡∏™‡∏ß‡πà‡∏≤‡∏á</button>
                <button onclick="window.setDisplayMode('night')" style="flex:1; padding:10px; border-radius:12px; border:1px solid #ddd;">‡∏°‡∏∑‡∏î</button>
                <button onclick="window.setDisplayMode('auto')" style="flex:1; padding:10px; border-radius:12px; border:1px solid #ddd;">‡∏≠‡∏≠‡πÇ‡∏ï‡πâ</button>
            </div>
            <h4>‡∏™‡∏µ‡∏ò‡∏µ‡∏°‡πÅ‡∏•‡∏∞‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á</h4>
            <div style="display:grid; grid-template-columns: repeat(5, 1fr); gap:10px; margin-bottom:15px;">
                <div style="width:35px; height:35px; background:#5e72e4; border-radius:50%; cursor:pointer;" onclick="window.setTheme('#5e72e4')"></div>
                <div style="width:35px; height:35px; background:#2dce89; border-radius:50%; cursor:pointer;" onclick="window.setTheme('#2dce89')"></div>
                <div style="width:35px; height:35px; background:#fb6340; border-radius:50%; cursor:pointer;" onclick="window.setTheme('#fb6340')"></div>
                <div style="width:35px; height:35px; background:#f5365c; border-radius:50%; cursor:pointer;" onclick="window.setTheme('#f5365c')"></div>
                <div style="width:35px; height:35px; background:#11cdef; border-radius:50%; cursor:pointer;" onclick="window.setTheme('#11cdef')"></div>
            </div>
            <button class="btn-full" style="background:var(--primary-soft); color:var(--primary); width:100%; border:none; padding:10px; border-radius:12px; margin-bottom:10px;" onclick="document.getElementById('bgInput').click()">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á</button>
            <button class="btn-full" style="background:#eee; color:#888; width:100%; border:none; padding:10px; border-radius:12px;" onclick="window.resetBackground()">‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏î‡∏¥‡∏°</button>
        </div>
    </div>
  </div>
  <div class="modal" id="clearDataModal"><div class="modal-card"><h3>‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3><p style="color:#888;">‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÑ‡∏´‡∏ô‡∏î‡∏µ?</p><select id="clearTarget" class="modern-input" style="margin-bottom:15px;"><option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option></select><div style="display:flex; gap:10px;"><button class="btn-full" style="background:#fee2e2; color:#dc2626; flex:1;" onclick="performClear()">‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏•‡∏¢</button><button class="btn-full" style="background:#eee; flex:1;" onclick="closeModal('clearDataModal')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button></div></div></div>

  <!-- Firebase Script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const FIREBASE_CONFIG = { apiKey: "AIzaSyDUliKbJO1YyUNjZdBvkBULaWlEaBzmcAA", authDomain: "budget1-ed2f4.firebaseapp.com", projectId: "budget1-ed2f4", storageBucket: "budget1-ed2f4.firebasestorage.app", messagingSenderId: "312969765873", appId: "1:312969765873:web:db0e163fe587149963da50" };
    const app = initializeApp(FIREBASE_CONFIG);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const appId = 'budget-app';
    let userId, useCloud = false;

    window.loginGoogle = async () => { try { await signInWithPopup(auth, new GoogleAuthProvider()); window.closeModal('settingsModal'); } catch(e) { alert("Login Failed"); } };
    window.logout = async () => { await signOut(auth); window.location.reload(); };

    onAuthStateChanged(auth, (user) => {
        const syncBadge = document.getElementById('syncStatus');
        if (user) {
            userId = user.uid; useCloud = true;
            syncBadge.innerHTML = '<i class="fas fa-cloud"></i> Online'; syncBadge.style.background = '#dcfce7'; syncBadge.style.color = '#166534';
            document.getElementById('btnLogin').classList.add('hidden');
            document.getElementById('btnLogout').classList.remove('hidden');
            if(user.photoURL) { document.getElementById('mainAvatar').src = user.photoURL; document.getElementById('mainAvatar').style.display = 'block'; }
            document.getElementById('userRole').innerText = user.displayName;
            startDataListener();
        } else { useCloud = false; syncBadge.innerHTML = '<i class="fas fa-wifi"></i> Offline'; }
    });

    function startDataListener() {
        onSnapshot(doc(db, 'artifacts', appId, 'users', userId, 'budget_data', 'yearly'), (docSnap) => {
            if (docSnap.exists() && document.activeElement.tagName !== 'INPUT') {
                const data = docSnap.data();
                if (data.monthlyData) { window.monthlyData = data.monthlyData; window.initDataAndRender(); }
            }
        });
    }

    window.saveDataToCloud = async () => {
        if (useCloud && userId) {
            try { await setDoc(doc(db, 'artifacts', appId, 'users', userId, 'budget_data', 'yearly'), { monthlyData: window.monthlyData, lastUpdated: new Date().toISOString() }); } catch (e) {}
        }
    }
  </script>

  <!-- App Main Script -->
  <script>
    // --- Global Chart Instances ---
    window.myYearChart = null; 
    window.savingsChartObj = null;
    window.monthSavingsChartObj = null;

    // --- Utils ---
    window.closeModal = (id) => { document.getElementById(id).classList.remove('show'); };
    window.scrollContainer = (id, offset) => { 
        const container = document.getElementById(id);
        if(container) container.scrollLeft += offset; 
    };
    function escapeHtml(text) { return text ? String(text).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#039;"}[m])) : ""; }

    // --- Theme & Appearance Functions ---
    window.setDisplayMode = (mode) => {
        localStorage.setItem('display_mode', mode);
        applyThemeMode();
    };
    function applyThemeMode() {
        const mode = localStorage.getItem('display_mode') || 'auto';
        const isNight = mode === 'auto' ? (new Date().getHours() >= 18 || new Date().getHours() < 6) : mode === 'night';
        document.body.classList.toggle('night', isNight);
    }
    window.setTheme = (c) => {
        document.documentElement.style.setProperty('--primary', c);
        document.documentElement.style.setProperty('--primary-soft', c + '20');
        localStorage.setItem('app_theme', c);
    };
    window.handleBgChange = (input) => {
        const file = input.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const bg = e.target.result;
                document.body.style.backgroundImage = `url(${bg})`;
                localStorage.setItem('custom_bg', bg);
            };
            reader.readAsDataURL(file);
        }
    };
    window.resetBackground = () => {
        document.body.style.backgroundImage = '';
        localStorage.removeItem('custom_bg');
    };

    const months = ["‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå", "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°", "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô", "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°", "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô", "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°", "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô", "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°", "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô", "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"];
    const categories = [{icon:'üçî',label:'‡∏≠‡∏≤‡∏´‡∏≤‡∏£'},{icon:'üöó',label:'‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á'},{icon:'üè†',label:'‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å'},{icon:'üõçÔ∏è',label:'‡∏ä‡πâ‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á'},{icon:'üíä',label:'‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û'},{icon:'üéâ',label:'‡∏ö‡∏±‡∏ô‡πÄ‡∏ó‡∏¥‡∏á'},{icon:'üí°',label:'‡∏ö‡∏¥‡∏•‡∏ï‡πà‡∏≤‡∏á‡πÜ'},{icon:'üí∏',label:'‡∏•‡∏á‡∏ó‡∏∏‡∏ô'}];

    window.monthlyData = JSON.parse(localStorage.getItem('yearlyBudget_v1')) || months.map(() => ({ salary: 0, extraList: [], savings: [], details: [] }));
    window.currentMonthIndex = 0;

    window.initDataAndRender = function() {
        window.monthlyData = window.monthlyData.map(m => ({
            ...m,
            details: Array.isArray(m.details) ? m.details : [],
            extraList: Array.isArray(m.extraList) ? m.extraList : [],
            savings: Array.isArray(m.savings) ? m.savings : []
        }));
        
        // Initial Theme Loads
        applyThemeMode();
        const savedTheme = localStorage.getItem('app_theme'); if(savedTheme) window.setTheme(savedTheme);
        const savedBg = localStorage.getItem('custom_bg'); if(savedBg) document.body.style.backgroundImage = `url(${savedBg})`;
        const storedKey = localStorage.getItem('gemini_api_key'); if(storedKey) document.getElementById('apiKeyInput').value = storedKey;

        if(document.getElementById('view-home').classList.contains('active')) window.renderHome(); 
        else window.renderMonthDetail();
    };

    function calculateStats(m) {
        const inc = (Number(m.salary)||0) + (m.extraList||[]).reduce((s,i)=>s+(Number(i.amount)||0), 0) + (m.details||[]).filter(d=>d.type==='income').reduce((s,d)=>s+(Number(d.amount)||0), 0);
        const exp = (m.details||[]).filter(d=>d.type==='expense').reduce((s,d)=>s+(Number(d.amount)||0), 0);
        const save = (m.savings||[]).reduce((s,i)=>s+(Number(i.amount)||0), 0);
        return { inc, exp, save, bal: inc - exp, free: inc - exp - save };
    }

    let saveTimeout;
    window.saveData = () => {
        localStorage.setItem('yearlyBudget_v1', JSON.stringify(window.monthlyData));
        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(() => { if(window.saveDataToCloud) window.saveDataToCloud(); }, 2000);
    };

    // --- Core Rendering ---
    window.renderHome = () => {
        const list = document.getElementById('homeMonthList');
        let html = '', gInc = 0, gExp = 0, gSave = 0, yearlySavingsMap = {}, yearlyExpMap = {};
        const currIdx = new Date().getMonth();
        const currStats = calculateStats(window.monthlyData[currIdx]);

        window.monthlyData.forEach((m, i) => {
            const s = calculateStats(m);
            gInc += s.inc; gExp += s.exp; gSave += s.save;
            m.savings.forEach(v => { let k=v.desc||'‡∏≠‡∏≠‡∏°‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ'; yearlySavingsMap[k]=(yearlySavingsMap[k]||0)+Number(v.amount); });
            m.details.filter(d=>d.type==='expense').forEach(d => { let k=d.desc||'‡∏≠‡∏∑‡πà‡∏ô‡πÜ'; yearlyExpMap[k]=(yearlyExpMap[k]||0)+Number(d.amount); });
            html += `<div class="month-summary-card" onclick="openMonth(${i})"><div class="m-left"><div class="m-icon">${i+1}</div><div class="m-info"><h4>${months[i]}</h4><span>‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÉ‡∏ä‡πâ: ${s.free.toLocaleString()}</span></div></div><div class="m-right"><span class="m-bal" style="color:${s.free>=0?'var(--primary)':'var(--danger)'}">${s.free.toLocaleString()}</span></div></div>`;
        });
        
        list.innerHTML = html;
        document.getElementById('currMonthName').innerText = months[currIdx];
        document.getElementById('currentMonthBalance').innerText = currStats.free.toLocaleString();
        document.getElementById('dashIncome').innerText = currStats.inc.toLocaleString();
        document.getElementById('dashExpense').innerText = currStats.exp.toLocaleString();
        document.getElementById('dashSavings').innerText = currStats.save.toLocaleString();
        document.getElementById('grandBalance').innerText = (gInc - gExp - gSave).toLocaleString();
        
        const top5 = Object.entries(yearlyExpMap).sort((a,b)=>b[1]-a[1]).slice(0,5);
        document.getElementById('yearTopExpList').innerHTML = top5.length ? top5.map(i=>`<span class="top-pill">${escapeHtml(i[0])} ${i[1].toLocaleString()}</span>`).join('') : '<span style="color:#aaa; font-size:0.8rem;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>';
        
        renderPortfolioChart(yearlySavingsMap, 'savingsDoughnut', 'savingsLegend');
    };

    window.openMonth = (idx) => { window.currentMonthIndex = idx; switchView('month'); window.renderMonthDetail(); };

    window.renderMonthDetail = () => {
        const m = window.monthlyData[window.currentMonthIndex];
        const s = calculateStats(m);
        document.getElementById('detailMonthName').innerText = months[window.currentMonthIndex];
        document.getElementById('monthGrandBalance').innerText = s.free.toLocaleString();
        document.getElementById('monthGrandIncome').innerText = s.inc.toLocaleString();
        document.getElementById('monthGrandExpense').innerText = s.exp.toLocaleString();
        document.getElementById('monthGrandSavings').innerText = s.save.toLocaleString();
        document.getElementById('inpSalary').value = m.salary || '';
        
        renderSubList(m.extraList, 'extraIncomeList', 'updateExtra', 'removeExtra', 'üí∏');
        renderSubList(m.savings, 'savingsDetailList', 'updateSave', 'removeSave', 'üê∑');
        
        document.getElementById('monthDetailList').innerHTML = m.details.map((d, i) => `
            <div class="detail-row">
                <div class="type-badge ${d.type==='income'?'badge-inc':'badge-exp'}" onclick="toggleType(${i})">${d.type==='income'?'+':'-'}</div>
                <input class="desc-input" value="${escapeHtml(d.desc)}" oninput="updateDetail(${i},'desc',this.value)">
                <div class="detail-divider"></div>
                <input class="amt-input" type="number" value="${d.amount}" oninput="updateDetail(${i},'amount',this.value)">
                <button class="btn-del-modern" onclick="removeDetail(${i})"><i class="fas fa-times"></i></button>
            </div>
        `).join('');

        document.getElementById('cat-scroll').innerHTML = categories.map(c => `<div class="cat-item" onclick="addWithIcon('${c.icon} ${c.label}')"><button class="cat-btn">${c.icon}</button><span class="cat-label">${c.label}</span></div>`).join('');
        const mSavMap = {}; m.savings.forEach(v => { let k=v.desc||'‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ'; mSavMap[k]=(mSavMap[k]||0)+Number(v.amount); });
        renderPortfolioChart(mSavMap, 'monthSavingsDoughnut', 'monthSavingsLegend');
    };

    function renderSubList(arr, id, upFn, rmFn, icon) {
        document.getElementById(id).innerHTML = arr.length ? arr.map((v, i) => `
            <div class="detail-row"><span>${icon}</span><input class="desc-input" value="${escapeHtml(v.desc)}" oninput="window.${upFn}(${i},'desc',this.value)"><div class="detail-divider"></div><input class="amt-input" type="number" value="${v.amount}" oninput="window.${upFn}(${i},'amount',this.value)"><button class="btn-del-modern" onclick="window.${rmFn}(${i})"><i class="fas fa-times"></i></button></div>
        `).join('') : '<div style="text-align:center; color:#ccc; font-size:0.8rem;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>';
    }

    // --- Logic Actions ---
    window.updateCurrentMonthBase = (f, v) => { window.monthlyData[window.currentMonthIndex][f] = Number(v); window.saveData(); updateMonthStatsUI(); };
    window.addExtraIncomeItem = () => { window.monthlyData[window.currentMonthIndex].extraList.push({desc:'', amount:''}); window.saveData(); window.renderMonthDetail(); };
    window.updateExtra = (i, f, v) => { window.monthlyData[window.currentMonthIndex].extraList[i][f] = f==='amount'?Number(v):v; window.saveData(); updateMonthStatsUI(); };
    window.removeExtra = (i) => { window.monthlyData[window.currentMonthIndex].extraList.splice(i, 1); window.saveData(); window.renderMonthDetail(); };
    window.addWithIconExtra = (l) => { window.monthlyData[window.currentMonthIndex].extraList.push({desc:l, amount:''}); window.saveData(); window.renderMonthDetail(); };

    window.addSavingItemCurrent = () => { window.monthlyData[window.currentMonthIndex].savings.push({desc:'', amount:''}); window.saveData(); window.renderMonthDetail(); };
    window.updateSave = (i, f, v) => { window.monthlyData[window.currentMonthIndex].savings[i][f] = f==='amount'?Number(v):v; window.saveData(); updateMonthStatsUI(); };
    window.removeSave = (i) => { window.monthlyData[window.currentMonthIndex].savings.splice(i, 1); window.saveData(); window.renderMonthDetail(); };
    window.addWithIconSavings = (l) => { window.monthlyData[window.currentMonthIndex].savings.push({desc:l, amount:''}); window.saveData(); window.renderMonthDetail(); };

    window.addDetailCurrent = (t) => { window.monthlyData[window.currentMonthIndex].details.push({type:t, desc:'', amount:''}); window.saveData(); window.renderMonthDetail(); };
    window.updateDetail = (i, f, v) => { window.monthlyData[window.currentMonthIndex].details[i][f] = f==='amount'?Number(v):v; window.saveData(); updateMonthStatsUI(); };
    window.removeDetail = (i) => { window.monthlyData[window.currentMonthIndex].details.splice(i, 1); window.saveData(); window.renderMonthDetail(); };
    window.toggleType = (i) => { let d=window.monthlyData[window.currentMonthIndex].details[i]; d.type=d.type==='income'?'expense':'income'; window.saveData(); window.renderMonthDetail(); };
    window.addWithIcon = (ic) => { window.monthlyData[window.currentMonthIndex].details.push({type:'expense', desc:ic+' ', amount:''}); window.saveData(); window.renderMonthDetail(); };

    function updateMonthStatsUI() {
        const s = calculateStats(window.monthlyData[window.currentMonthIndex]);
        document.getElementById('monthGrandBalance').innerText = s.free.toLocaleString();
        document.getElementById('monthGrandIncome').innerText = s.inc.toLocaleString();
        document.getElementById('monthGrandExpense').innerText = s.exp.toLocaleString();
        document.getElementById('monthGrandSavings').innerText = s.save.toLocaleString();
    }

    // --- Charting ---
    function renderPortfolioChart(map, canvasId, legendId) {
        const canvas = document.getElementById(canvasId);
        if(!canvas) return;
        const ctx = canvas.getContext('2d');
        const entries = Object.entries(map).sort((a,b)=>b[1]-a[1]);
        if (!entries.length) { document.getElementById(legendId).innerHTML = '<span style="color:#aaa; font-size:0.8rem;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>'; return; }
        const colors = ['#11cdef','#2dce89','#5e72e4','#fb6340','#f5365c'];
        
        const chartKey = canvasId === 'savingsDoughnut' ? 'savingsChartObj' : 'monthSavingsChartObj';
        if(window[chartKey]) window[chartKey].destroy();
        
        window[chartKey] = new Chart(ctx, { 
            type:'doughnut', 
            data:{ labels:entries.map(e=>e[0]), datasets:[{data:entries.map(e=>e[1]), backgroundColor:colors, borderWidth:0, cutout:'70%'}] }, 
            options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}} } 
        });
        document.getElementById(legendId).innerHTML = entries.map((e,i)=>`<div class="sp-item"><span><span class="sp-color" style="background:${colors[i%5]}"></span>${escapeHtml(e[0])}</span><b>${e[1].toLocaleString()}</b></div>`).join('');
    }

    window.openChartModal = () => {
        document.getElementById('chartModal').classList.add('show');
        const ctx = document.getElementById('chart').getContext('2d');
        if(window.myYearChart) window.myYearChart.destroy();
        const dataInc = window.monthlyData.map(m => calculateStats(m).inc);
        const dataExp = window.monthlyData.map(m => calculateStats(m).exp);
        window.myYearChart = new Chart(ctx, {
            type: 'bar',
            data: { labels: months, datasets: [
                { label: '‡∏£‡∏±‡∏ö', data: dataInc, backgroundColor: '#2dce89', borderRadius: 4 },
                { label: '‡∏à‡πà‡∏≤‡∏¢', data: dataExp, backgroundColor: '#f5365c', borderRadius: 4 }
            ]},
            options: { responsive: true, maintainAspectRatio: false }
        });
    };

    // --- Navigation & AI ---
    window.switchView = (v) => {
        document.querySelectorAll('.view-section').forEach(e=>e.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));
        if(v==='home') { document.getElementById('view-home').classList.add('active'); document.querySelector('.nav-item:nth-child(1)').classList.add('active'); window.renderHome(); }
        else { document.getElementById('view-month').classList.add('active'); }
        window.scrollTo({top:0, behavior:'smooth'});
    };

    window.analyzeBudgetWithAI = async () => {
        const key = localStorage.getItem('gemini_api_key'); if(!key) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà API Key ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤"); return window.openSettingsModal(); }
        document.getElementById('loadingOverlay').style.display='flex';
        try {
            const sum = window.monthlyData.map((m,i)=>`${months[i]}: In=${calculateStats(m).inc}, Out=${calculateStats(m).exp}`).join('\n');
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${key}`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({contents:[{parts:[{text:`Analyze this budget and give 3 short tips in Thai markdown:\n${sum}`}]}]}) });
            const d = await res.json(); 
            document.getElementById('aiContent').innerHTML = marked.parse(d.candidates?.[0]?.content?.parts?.[0]?.text || "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö");
            document.getElementById('aiModal').classList.add('show');
        } catch(e) { alert("API Error"); } finally { document.getElementById('loadingOverlay').style.display='none'; }
    };

    window.triggerScanCurrent = () => document.getElementById('receiptInput').click();
    
    // Receipt Scan Logic
    document.getElementById('receiptInput').addEventListener('change', async function(e) {
        const key = localStorage.getItem('gemini_api_key');
        if(!key) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà API Key"); return; }
        if(!this.files[0]) return;
        
        document.getElementById('loadingOverlay').style.display='flex';
        const reader = new FileReader();
        reader.onload = async (ev) => {
            try {
                const b64 = ev.target.result.split(',')[1];
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${key}`, {
                    method:'POST', headers:{'Content-Type':'application/json'},
                    body:JSON.stringify({contents:[{role:"user", parts:[{text:"Extract: {\"desc\":\"str\",\"amount\":num,\"type\":\"expense\"}"},{inlineData:{mimeType:"image/jpeg",data:b64}}]}]})
                });
                const d = await res.json();
                const json = JSON.parse(d.candidates[0].content.parts[0].text.replace(/```json/g,'').replace(/```/g,'').trim());
                if(json.amount) {
                    window.monthlyData[window.currentMonthIndex].details.push({type:json.type||'expense', desc:json.desc, amount:json.amount});
                    window.saveData(); window.renderMonthDetail();
                }
            } catch(err) { alert("Scan Failed"); }
            finally { document.getElementById('loadingOverlay').style.display='none'; this.value=''; }
        };
        reader.readAsDataURL(this.files[0]);
    });

    window.openToolsModal = () => document.getElementById('toolsModal').classList.add('show');
    window.openSettingsModal = () => document.getElementById('settingsModal').classList.add('show');
    window.saveApiKey = () => { localStorage.setItem('gemini_api_key', document.getElementById('apiKeyInput').value); alert("Saved"); };
    window.exportJSON = () => { const a=document.createElement('a'); a.href="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(window.monthlyData)); a.download="backup.json"; a.click(); };
    window.exportToExcel = () => {
       let csv = "\uFEFF‡πÄ‡∏î‡∏∑‡∏≠‡∏ô,‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó,‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£,‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô\n";
       window.monthlyData.forEach((m, idx) => {
         const mm = months[idx];
         if(m.salary) csv += `${mm},‡∏õ‡∏£‡∏∞‡∏à‡∏≥,‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô,${m.salary}\n`;
         m.extraList.forEach(e => csv += `${mm},‡∏û‡∏¥‡πÄ‡∏®‡∏©,${e.desc},${e.amount}\n`);
         m.savings.forEach(s => csv += `${mm},‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°,${s.desc},${s.amount}\n`);
         m.details.forEach(d => csv += `${mm},${d.type==='income'?'‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö':'‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢'},${d.desc},${d.amount}\n`);
       });
       const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv' })); a.download = "Budget.csv"; a.click();
    };
    
    window.openClearModal = () => {
        const sel = document.getElementById('clearTarget');
        sel.innerHTML = '<option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>';
        months.forEach((m, i) => { sel.innerHTML += `<option value="${i}">${m}</option>`; });
        document.getElementById('clearDataModal').classList.add('show');
    };
    window.performClear = () => {
        const val = document.getElementById('clearTarget').value;
        if (val === 'all') { if(confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')) window.monthlyData = months.map(() => ({ salary: 0, extraList: [], savings: [], details: [] })); }
        else { const idx = parseInt(val); window.monthlyData[idx] = { salary: 0, extraList: [], savings: [], details: [] }; }
        window.saveData(); window.initDataAndRender(); window.closeModal('clearDataModal'); window.closeModal('toolsModal');
    };

    window.initDataAndRender();
  </script>
</body>
</html>
